# Preview Overlay Automation Fix

## Problem

The preview overlay (`k8s/overlays/preview/kustomization.yaml`) required manual updates for every new PR:

- PR number in namespace (e.g., `preview-pr-6`)
- Image tags for API and workers
- Commit SHA in comments

This was error-prone and created unnecessary manual work.

## Root Cause

Two issues were identified:

1. **Old ingress patch still in template** - The template at `scripts/ci/templates/preview-kustomization-template.yaml` still referenced `ingress-patch.yaml`, which is no longer needed after Gateway API migration
2. **Unclear file ownership** - It wasn't obvious that `kustomization.yaml` is auto-generated and should never be manually edited

## Solution

### 1. Updated Template (Gateway API Migration)

**File:** `scripts/ci/templates/preview-kustomization-template.yaml`

**Change:** Removed `ingress-patch.yaml` from patches list:

```diff
 patches:
   - path: patches/externalsecret-db-patch.yaml
   - path: patches/externalsecret-openai-patch.yaml
   - path: patches/externalsecret-storage-patch.yaml
   - path: patches/secretstore-delete-patch.yaml
   - path: patches/configmap-patch.yaml
-  - path: patches/ingress-patch.yaml
   - path: patches/httproute-patch.yaml
   - path: patches/resources-patch.yaml
   - path: patches/replicas-patch.yaml
   - path: patches/migration-job-patch.yaml
```

**Reason:** Gateway API uses HTTPRoute instead of Ingress. The old patch was causing ArgoCD sync failures due to nginx ingress admission webhook rejecting legacy wildcard hostnames.

### 2. Added Clear Documentation

**File:** `k8s/overlays/preview/README.md` (new)

**Content:**
- ⚠️ Clear warning: **DO NOT MANUALLY EDIT `kustomization.yaml`**
- Explanation of auto-generation workflow
- Template variable documentation
- Troubleshooting guide

### 3. Enhanced File Header

**File:** `k8s/overlays/preview/kustomization.yaml`

**Before:**
```yaml
# Preview overlay - updated by GitHub Actions
# PR: #6
# Image Tag: latest
# Commit: abeb431dae4b6a825e4cbc5e6d1cab0b3cf5577b
# Updated: 2026-01-11T15:14:44Z
```

**After:**
```yaml
# =============================================================================
# ⚠️  AUTO-GENERATED FILE - DO NOT EDIT MANUALLY  ⚠️
# =============================================================================
# This file is dynamically generated by GitHub Actions preview workflow.
# To make changes, edit: scripts/ci/templates/preview-kustomization-template.yaml
# See k8s/overlays/preview/README.md for details.
# =============================================================================
# Last updated by: github-actions[bot]
# PR: #__PR_NUMBER__ (placeholder - will be set by workflow)
# Image Tag: __IMAGE_TAG__ (placeholder - will be set by workflow)
# =============================================================================
```

**Reset to placeholders:**
```yaml
namespace: preview-pr-__PR_NUMBER__
images:
  - name: yt-summarizer-api
    newName: __ACR_SERVER__/yt-summarizer-api
    newTag: __IMAGE_TAG__
  - name: yt-summarizer-workers
    newName: __ACR_SERVER__/yt-summarizer-workers
    newTag: __IMAGE_TAG__
```

## How It Works Now

### For Each PR:

1. **Workflow triggers** (`preview.yml` on PR create/update)
2. **Template loaded** (`scripts/ci/templates/preview-kustomization-template.yaml`)
3. **Variables substituted** by `scripts/ci/generate_preview_kustomization.py`:
   - `__PR_NUMBER__` → `6`
   - `__IMAGE_TAG__` → `pr-6-abc1234` or `latest`
   - `__ACR_SERVER__` → `acrytsummprd.azurecr.io`
   - `__PREVIEW_HOST__` → `api-pr-6.yt-summarizer.apps.ashleyhollis.com`
   - `__TLS_SECRET__` → `wildcard-yt-summarizer-apps-tls`
4. **Generated overlay** written to `k8s/overlays/preview/kustomization.yaml`
5. **Validated** with `kustomize build` and AKS dry-run
6. **Committed** by `github-actions[bot]` with `[skip ci]` tag
7. **ArgoCD syncs** from the PR branch
8. **Preview deploys** to `preview-pr-{NUMBER}` namespace

### Making Changes:

**❌ OLD WAY (manual):**
```bash
# Edit k8s/overlays/preview/kustomization.yaml directly
git commit -m "update PR number"
git push
```

**✅ NEW WAY (template-based):**
```bash
# Edit the template
vim scripts/ci/templates/preview-kustomization-template.yaml

# Workflow regenerates overlay automatically on next PR build
# No manual updates needed!
```

## Benefits

✅ **Zero manual work** - PR number, tags, hostnames set automatically  
✅ **No merge conflicts** - Each PR branch has its own generated overlay  
✅ **Consistent previews** - All follow the same template structure  
✅ **Auditable** - Git history shows exact deployment configuration  
✅ **Clear ownership** - README + header make it obvious file is generated  
✅ **Gateway API compliant** - Removed old ingress patch, using HTTPRoute only

## Testing

Verified with PR #6:
1. Workflow generated overlay from updated template
2. No `ingress-patch.yaml` reference
3. ArgoCD successfully synced (previous sync failures resolved)
4. Preview deployed to `preview-pr-6` namespace
5. HTTPRoute created successfully
6. DNS and TLS working as expected

## Related Files

- **Template:** `scripts/ci/templates/preview-kustomization-template.yaml`
- **Generator:** `scripts/ci/generate_preview_kustomization.py`
- **Output:** `k8s/overlays/preview/kustomization.yaml`
- **Workflow:** `.github/workflows/preview.yml`
- **Actions:**
  - `.github/actions/update-preview-overlay/action.yml`
  - `.github/actions/commit-overlay-changes/action.yml`
  - `.github/actions/kustomize-validate/action.yml`
- **Documentation:** `k8s/overlays/preview/README.md`

## Future Improvements

1. **Consider `kustomize edit` commands** instead of Python template substitution (more idiomatic)
2. **Add CI check** to ensure `kustomization.yaml` matches generated template (detect manual edits)
3. **Template validation** in PR CI to catch errors before deployment

---

**Spec:** [003-preview-dns-cloudflare](../../specs/003-preview-dns-cloudflare/)  
**Commits:**
- `abeb431` - Remove old ingress patch conflicting with HTTPRoute
- `4f0be3d` - Make preview overlay fully dynamic, remove ingress patch
