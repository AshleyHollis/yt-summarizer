# Simple SWA deployment test - isolates SWA deployment from complex orchestration
# Based on successful test/swa-warmup-baseline workflow (Run #21157814189)
#
# This workflow tests if the SWA deployment timeout is caused by:
# - Complex workflow dependencies
# - Auth0 configuration timing
# - Job orchestration issues
#
# Key simplifications:
# - No job dependencies
# - No Auth0 configuration
# - No backend URL requirement
# - Minimal build configuration

name: SWA Simple Test

on:
  workflow_dispatch:
    inputs:
      pr_number:
        description: "PR number to deploy"
        required: true
        type: string
  push:
    branches:
      - fix/swa-backend-integration-baseline

permissions:
  id-token: write
  contents: read
  pull-requests: write

jobs:
  deploy-swa-simple:
    name: Simple SWA Deploy
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: apps/web/package-lock.json

      - name: Install dependencies
        working-directory: apps/web
        run: npm ci

      - name: Build frontend
        working-directory: apps/web
        env:
          # Use placeholder API URL to avoid backend dependency
          NEXT_PUBLIC_API_URL: "https://api-placeholder.example.com"
          NEXT_PUBLIC_ENVIRONMENT: "preview"
        run: |
          echo "Building Next.js app with placeholder configuration..."
          npm run build

      - name: Deploy to SWA
        id: deploy
        uses: Azure/static-web-apps-deploy@v1
        with:
          azure_static_web_apps_api_token: ${{ secrets.SWA_DEPLOYMENT_TOKEN }}
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          action: upload
          app_location: apps/web
          output_location: ""
          skip_app_build: true
          production_branch: main

      - name: Report deployment result
        if: always()
        run: |
          if [ "${{ steps.deploy.outcome }}" = "success" ]; then
            echo "‚úÖ SWA Deployment SUCCEEDED"
            echo "üìç URL: ${{ steps.deploy.outputs.static_web_app_url }}"
            echo ""
            echo "This proves the SWA deployment mechanism works when isolated."
            echo "The timeout issue is likely caused by:"
            echo "  - Complex workflow orchestration"
            echo "  - Auth0 configuration timing"
            echo "  - Job dependency issues"
          else
            echo "‚ùå SWA Deployment FAILED"
            echo "Outcome: ${{ steps.deploy.outcome }}"
            echo ""
            echo "This indicates a deeper issue with:"
            echo "  - SWA platform compatibility"
            echo "  - Build artifact structure"
            echo "  - Next.js configuration"
          fi

      - name: Post result to PR
        if: github.event.pull_request.number
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = context.payload.pull_request?.number || '${{ github.event.inputs.pr_number }}';
            const deployUrl = '${{ steps.deploy.outputs.static_web_app_url }}';
            const outcome = '${{ steps.deploy.outcome }}';

            const status = outcome === 'success' ? '‚úÖ SUCCESS' : '‚ùå FAILED';
            const body = `## SWA Simple Test Result: ${status}

            **Deployment URL:** ${deployUrl || 'N/A'}
            **Workflow:** Simple isolated test (no Auth0, no dependencies)
            **Commit:** ${context.sha}

            ${outcome === 'success' 
              ? '‚úÖ **Root cause identified:** Complex workflow orchestration or Auth0 timing\n\nThe SWA deployment works when isolated. The timeout issue is caused by the full preview workflow complexity.'
              : '‚ùå **Deeper issue:** SWA deployment fails even in isolation\n\nThis indicates a problem with the build artifacts, Next.js config, or SWA platform compatibility.'}

            [View workflow run](${context.payload.repository.html_url}/actions/runs/${context.runId})
            `;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: body
            });
