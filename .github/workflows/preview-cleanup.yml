# =============================================================================
# Preview Cleanup Workflow
# =============================================================================
# Posts cleanup status when PR is closed (merged or abandoned)
# Argo CD ApplicationSet with Pull Request Generator handles actual cleanup
# - No overlay files need to be deleted (they were in PR branch, not main)
# - Argo CD automatically deletes Application when PR closes

name: Preview Cleanup

on:
  pull_request:
    branches: [main]
    types: [closed]

permissions:
  id-token: write
  pull-requests: write

jobs:
  cleanup:
    name: Cleanup Preview
    runs-on: ubuntu-latest
    steps:
      - name: Post cleanup status
        uses: actions/github-script@v7
        with:
          script: |
            const merged = ${{ github.event.pull_request.merged }};
            const prNumber = ${{ github.event.pull_request.number }};
            const status = merged ? 'merged âœ…' : 'closed âŒ';
            const actionNote = merged 
              ? 'Code has been merged to main and will be deployed to production.'
              : 'PR was closed without merging.';
            
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## ðŸ—‘ï¸ Preview Cleanup

            The preview environment for this PR is being automatically removed.

            | Property | Value |
            |----------|-------|
            | **PR Status** | ${status} |
            | **Preview Application** | \`preview-pr-${prNumber}\` |
            | **Preview Namespace** | \`preview-pr-${prNumber}\` |

            ${actionNote}

            > Argo CD ApplicationSet with Pull Request Generator handles cleanup automatically.
            > The preview namespace and all resources will be removed within ~5 minutes.`
            });

      - name: Create cleanup summary
        run: |
          echo "## ðŸ—‘ï¸ Preview Cleanup Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **PR** | #${{ github.event.pull_request.number }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Merged** | ${{ github.event.pull_request.merged }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### â„¹ï¸ Automatic Cleanup" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "With Argo CD ApplicationSet using Pull Request Generator:" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Application deleted automatically when PR closes" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Namespace pruned automatically" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… No overlay files to delete (they lived in PR branch)" >> $GITHUB_STEP_SUMMARY

  # ---------------------------------------------------------------------------
  # Optional: Clean up ACR images for the PR
  # ---------------------------------------------------------------------------
  cleanup-images:
    name: Cleanup Images (Optional)
    runs-on: ubuntu-latest
    # Only run if we want to clean up images (can be disabled to save costs)
    if: false  # Set to true to enable image cleanup
    steps:
      - name: Azure Login via OIDC
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Delete PR images from ACR
        env:
          ACR_NAME: ${{ vars.ACR_NAME || 'acrytsummprd' }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
        run: |
          echo "Cleaning up images for PR #${PR_NUMBER}..."
          
          # Delete API images with pr-N- prefix
          az acr repository show-tags \
            --name $ACR_NAME \
            --repository yt-summarizer-api \
            --query "[?starts_with(@, 'pr-${PR_NUMBER}-')]" \
            --output tsv | while read tag; do
              echo "Deleting yt-summarizer-api:${tag}"
              az acr repository delete \
                --name $ACR_NAME \
                --image yt-summarizer-api:${tag} \
                --yes
            done
          
          # Delete Workers images with pr-N- prefix
          az acr repository show-tags \
            --name $ACR_NAME \
            --repository yt-summarizer-workers \
            --query "[?starts_with(@, 'pr-${PR_NUMBER}-')]" \
            --output tsv | while read tag; do
              echo "Deleting yt-summarizer-workers:${tag}"
              az acr repository delete \
                --name $ACR_NAME \
                --image yt-summarizer-workers:${tag} \
                --yes
            done
          
          echo "Image cleanup complete"
