# =============================================================================
# Preview Cleanup Workflow
# =============================================================================
# Posts cleanup status when PR is closed (merged or abandoned)
# Handles cleanup of:
# - SWA staging environment
# - Preview overlay files in the preview-overlays branch
# - Argo CD Application (handled automatically by ApplicationSet PR Generator)

name: PR Cleanup

on:
  pull_request:
    branches: [main]
    types: [closed]

permissions:
  id-token: write
  pull-requests: write
  contents: write # Need write to delete overlay files from preview-overlays branch

jobs:
  cleanup:
    name: Cleanup Preview
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Close SWA staging environment
        id: swa-cleanup
        uses: ./.github/actions/close-swa-environment
        with:
          pr-number: ${{ github.event.pull_request.number }}
          swa-deployment-token: ${{ secrets.SWA_DEPLOYMENT_TOKEN }}

      - name: Report SWA cleanup status
        if: always()
        run: scripts/workflows/preview-cleanup-swa-status.sh
        env:
          SWA_CLEANUP_OUTCOME: ${{ steps.swa-cleanup.outcome }}

      - name: Delete preview overlay from preview-overlays branch
        id: overlay-cleanup
        continue-on-error: true
        run: |
          PR_NUMBER="${{ github.event.pull_request.number }}"
          OVERLAY_DIR="k8s/overlays/preview-pr-${PR_NUMBER}"
          BRANCH="preview-overlays"

          echo "ðŸ—‘ï¸ Cleaning up preview overlay for PR #${PR_NUMBER}..."

          # Configure git
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Fetch and checkout the preview-overlays branch
          if ! git fetch origin "${BRANCH}" 2>/dev/null; then
            echo "â„¹ï¸ Branch ${BRANCH} does not exist, nothing to clean up"
            echo "deleted=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          git checkout "${BRANCH}"

          # Check if the overlay directory exists
          if [ ! -d "${OVERLAY_DIR}" ]; then
            echo "â„¹ï¸ Overlay directory ${OVERLAY_DIR} does not exist, nothing to clean up"
            echo "deleted=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          # Delete the PR-specific overlay directory
          git rm -rf "${OVERLAY_DIR}"
          git commit -m "ci(cleanup): remove preview overlay for PR #${PR_NUMBER}

          - PR was ${{ github.event.pull_request.merged && 'merged' || 'closed' }}
          - Auto-generated by GitHub Actions

          [skip ci]"

          git push origin "${BRANCH}"

          echo "âœ… Deleted overlay directory ${OVERLAY_DIR}"
          echo "deleted=true" >> "$GITHUB_OUTPUT"

      - name: Post cleanup status
        uses: actions/github-script@v7
        with:
          script: |
            const merged = ${{ github.event.pull_request.merged }};
            const prNumber = ${{ github.event.pull_request.number }};
            const overlayDeleted = '${{ steps.overlay-cleanup.outputs.deleted }}' === 'true';
            const status = merged ? 'merged âœ…' : 'closed âŒ';
            const actionNote = merged
              ? 'Code has been merged to main and will be deployed to production.'
              : 'PR was closed without merging.';
            const overlayStatus = overlayDeleted ? 'Deleted âœ…' : 'Not found (already cleaned)';

            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## ðŸ—‘ï¸ Preview Cleanup

            The preview environment for this PR is being automatically removed.

            | Property | Value |
            |----------|-------|
            | **PR Status** | ${status} |
            | **Preview Application** | \`preview-pr-${prNumber}\` |
            | **Preview Namespace** | \`preview-pr-${prNumber}\` |
            | **Preview Overlay** | ${overlayStatus} |
            | **SWA Staging Environment** | Being deleted |

            ${actionNote}

            > **Note:**
            > - Argo CD ApplicationSet with Pull Request Generator handles K8s cleanup automatically
            > - Preview overlay has been removed from the \`preview-overlays\` branch
            > - Azure Static Web Apps staging environment is being deleted
            > - All preview resources will be removed within ~5 minutes`
            });

      - name: Restore main branch for local actions
        if: always()
        uses: actions/checkout@v4
        with:
          ref: ${{ github.sha }}

      - name: Create cleanup summary
        uses: ./.github/actions/create-pipeline-summary
        with:
          summary-type: cleanup
          pr-number: ${{ github.event.pull_request.number }}
          pr-merged: ${{ github.event.pull_request.merged }}

  # ---------------------------------------------------------------------------
  # Optional: Clean up ACR images for the PR
  # ---------------------------------------------------------------------------
  cleanup-images:
    name: Cleanup Images (Optional)
    runs-on: ubuntu-latest
    # Only run if we want to clean up images (can be disabled to save costs)
    if: ${{ vars.CLEANUP_PR_IMAGES == 'true' }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Azure Login via OIDC
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Delete PR images from ACR
        uses: ./.github/actions/cleanup-acr-images
        with:
          acr-name: ${{ vars.ACR_NAME || 'acrytsummprd' }}
          pr-number: ${{ github.event.pull_request.number }}
