# =============================================================================
# Preview Cleanup Workflow
# =============================================================================
# Posts cleanup status when PR is closed (merged or abandoned)
# Argo CD ApplicationSet with Pull Request Generator handles actual cleanup
# - No overlay files need to be deleted (they were in PR branch, not main)
# - Argo CD automatically deletes Application when PR closes

name: PR Cleanup

on:
  pull_request:
    branches: [main]
    types: [closed]

permissions:
  id-token: write
  pull-requests: write

jobs:
  cleanup:
    name: Cleanup Preview
    runs-on: ubuntu-latest
    steps:
      - name: Post cleanup status
        uses: actions/github-script@v7
        with:
          script: |
            const merged = ${{ github.event.pull_request.merged }};
            const prNumber = ${{ github.event.pull_request.number }};
            const status = merged ? 'merged âœ…' : 'closed âŒ';
            const actionNote = merged 
              ? 'Code has been merged to main and will be deployed to production.'
              : 'PR was closed without merging.';
            
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## ðŸ—‘ï¸ Preview Cleanup

            The preview environment for this PR is being automatically removed.

            | Property | Value |
            |----------|-------|
            | **PR Status** | ${status} |
            | **Preview Application** | \`preview-pr-${prNumber}\` |
            | **Preview Namespace** | \`preview-pr-${prNumber}\` |

            ${actionNote}

            > Argo CD ApplicationSet with Pull Request Generator handles cleanup automatically.
            > The preview namespace and all resources will be removed within ~5 minutes.`
            });

      - name: Create cleanup summary
        uses: ./.github/actions/create-cleanup-summary
        with:
          pr-number: ${{ github.event.pull_request.number }}
          pr-merged: ${{ github.event.pull_request.merged }}

  # ---------------------------------------------------------------------------
  # Optional: Clean up ACR images for the PR
  # ---------------------------------------------------------------------------
  cleanup-images:
    name: Cleanup Images (Optional)
    runs-on: ubuntu-latest
    # Only run if we want to clean up images (can be disabled to save costs)
    if: false  # Set to true to enable image cleanup
    steps:
      - name: Azure Login via OIDC
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Delete PR images from ACR
        uses: ./.github/actions/cleanup-acr-images
        with:
          acr-name: ${{ vars.ACR_NAME || 'acrytsummprd' }}
          pr-number: ${{ github.event.pull_request.number }}

