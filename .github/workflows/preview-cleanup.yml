# =============================================================================
# Preview Cleanup Workflow
# =============================================================================
# Posts cleanup status when PR is closed (merged or abandoned)
# Argo CD ApplicationSet with Pull Request Generator handles actual cleanup
# - No overlay files need to be deleted (they were in PR branch, not main)
# - Argo CD automatically deletes Application when PR closes

name: PR Cleanup

on:
  pull_request:
    branches: [main]
    types: [closed]

permissions:
  id-token: write
  pull-requests: write
  contents: read

jobs:
  cleanup:
    name: Cleanup Preview
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Close SWA staging environment
        id: swa-cleanup
        uses: ./.github/actions/close-swa-environment
        with:
          pr-number: ${{ github.event.pull_request.number }}
          swa-deployment-token: ${{ secrets.SWA_DEPLOYMENT_TOKEN }}

      - name: Report SWA cleanup status
        if: always()
        run: |
          if [[ "${{ steps.swa-cleanup.outcome }}" == "success" ]]; then
            echo "âœ… SWA staging environment successfully deleted"
          else
            echo "âš ï¸  SWA cleanup completed with warnings (environment may not have existed)"
          fi
          
          cat >> $GITHUB_STEP_SUMMARY << 'EOF'
          ## ðŸ—‘ï¸ Azure Static Web Apps Cleanup
          
          **Status:** ${{ steps.swa-cleanup.outcome == 'success' && 'âœ… Success' || 'âš ï¸  Completed with warnings' }}
          **PR Number:** #${{ github.event.pull_request.number }}
          
          The staging environment for this PR has been processed for deletion.
          EOF

      - name: Post cleanup status
        uses: actions/github-script@v7
        with:
          script: |
            const merged = ${{ github.event.pull_request.merged }};
            const prNumber = ${{ github.event.pull_request.number }};
            const status = merged ? 'merged âœ…' : 'closed âŒ';
            const actionNote = merged 
              ? 'Code has been merged to main and will be deployed to production.'
              : 'PR was closed without merging.';
            
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## ðŸ—‘ï¸ Preview Cleanup

            The preview environment for this PR is being automatically removed.

            | Property | Value |
            |----------|-------|
            | **PR Status** | ${status} |
            | **Preview Application** | \`preview-pr-${prNumber}\` |
            | **Preview Namespace** | \`preview-pr-${prNumber}\` |
            | **SWA Staging Environment** | Being deleted |

            ${actionNote}

            > **Note:**
            > - Argo CD ApplicationSet with Pull Request Generator handles K8s cleanup automatically
            > - Azure Static Web Apps staging environment is being deleted
            > - All preview resources will be removed within ~5 minutes`
            });

      - name: Create cleanup summary
        uses: ./.github/actions/create-cleanup-summary
        with:
          pr-number: ${{ github.event.pull_request.number }}
          pr-merged: ${{ github.event.pull_request.merged }}

  # ---------------------------------------------------------------------------
  # Optional: Clean up ACR images for the PR
  # ---------------------------------------------------------------------------
  cleanup-images:
    name: Cleanup Images (Optional)
    runs-on: ubuntu-latest
    # Only run if we want to clean up images (can be disabled to save costs)
    if: false  # Set to true to enable image cleanup
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Azure Login via OIDC
        uses: azure/login@v2
        with:
          auth-type: OIDC
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Delete PR images from ACR
        uses: ./.github/actions/cleanup-acr-images
        with:
          acr-name: ${{ vars.ACR_NAME || 'acrytsummprd' }}
          pr-number: ${{ github.event.pull_request.number }}

