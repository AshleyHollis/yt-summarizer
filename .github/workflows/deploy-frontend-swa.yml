# =============================================================================
# Deploy Frontend to Azure Static Web Apps (Reusable Workflow)
# =============================================================================
# Unified frontend deployment workflow for both production and preview.
# Extracts common patterns from deploy-prod.yml and preview.yml to reduce
# duplication and ensure consistent SWA deployments.
#
# WORKFLOW STEPS:
#   1. Checkout code (with proper ref for preview)
#   2. Load shared environment
#   3. Verify SWA token is configured
#   4. (Preview only) Azure login for SWA cleanup
#   5. (Preview only) Cleanup stale SWA environments
#   6. Deploy frontend with CI artifact
#   7. Verify frontend deployment with health check
#
# USAGE:
#   Production:
#     uses: ./.github/workflows/deploy-frontend-swa.yml
#     with:
#       environment: prod
#       ci-run-id: ${{ needs.wait-for-ci.outputs.ci_run_id }}
#       api-url: https://api.yt-summarizer.example.com
#       deployment-environment: default
#
#   Preview:
#     uses: ./.github/workflows/deploy-frontend-swa.yml
#     with:
#       environment: preview
#       ci-run-id: ${{ needs.wait-for-ci.outputs.ci_run_id }}
#       api-url: https://pr-42.yt-summarizer.apps.ashleyhollis.com
#       deployment-environment: pr-42
#       pr-number: '42'
#       pr-head-sha: abc1234567890
#       cleanup-stale-environments: 'true'
# =============================================================================

name: Deploy Frontend to SWA

on:
  workflow_call:
    inputs:
      environment:
        description: "Environment type: prod or preview"
        required: true
        type: string
      ci-run-id:
        description: "CI workflow run ID to fetch build artifact"
        required: true
        type: string
      api-url:
        description: "API URL for runtime configuration"
        required: true
        type: string
      deployment-environment:
        description: "SWA deployment environment (default for prod, pr-N for preview)"
        required: true
        type: string
      # Preview-specific inputs
      pr-number:
        description: "PR number (preview only)"
        required: false
        type: string
        default: ""
      pr-head-sha:
        description: "PR head SHA for checkout (preview only)"
        required: false
        type: string
        default: ""
      cleanup-stale-environments:
        description: "Cleanup stale SWA environments before deploy (preview only)"
        required: false
        type: boolean
        default: false

    outputs:
      static_web_app_url:
        description: "The deployed SWA URL"
        value: ${{ jobs.deploy.outputs.static_web_app_url }}

    secrets:
      AZURE_CLIENT_ID:
        required: true
      AZURE_TENANT_ID:
        required: true
      AZURE_SUBSCRIPTION_ID:
        required: true
      SWA_DEPLOYMENT_TOKEN:
        required: true

jobs:
  deploy:
    name: Deploy Frontend (${{ inputs.environment }})
    runs-on: ubuntu-latest
    timeout-minutes: 45
    outputs:
      static_web_app_url: ${{ steps.resolve-url.outputs.url }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.pr-head-sha != '' && inputs.pr-head-sha || github.sha }}

      # Fail-fast if PR has been closed to avoid false failures and wasted resources
      - name: Check if PR is still open
        if: inputs.environment == 'preview' && inputs.pr-number != ''
        uses: AshleyHollis/shared-infra/.github/actions/check-pr-open@v1
        with:
          pr-number: ${{ inputs.pr-number }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
        continue-on-error: false

      - name: Load shared environment
        uses: AshleyHollis/shared-infra/.github/actions/load-shared-env@v1

      - name: Verify SWA token is configured
        uses: AshleyHollis/shared-infra/.github/actions/verify-secret@v1
        with:
          secret-name: "SWA_DEPLOYMENT_TOKEN"
          secret-value: ${{ secrets.SWA_DEPLOYMENT_TOKEN }}

      # Preview-only: Azure login for SWA cleanup operations
      - name: Azure Login for SWA cleanup
        if: inputs.cleanup-stale-environments
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      # Preview-only: Cleanup stale environments before deploy
      - name: Cleanup stale SWA environments
        if: inputs.cleanup-stale-environments
        id: cleanup-stale
        continue-on-error: true
        uses: AshleyHollis/shared-infra/.github/actions/cleanup-stale-swa-environments@v1
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          swa-name: ${{ vars.SWA_NAME || 'swa-ytsumm-prd' }}
          resource-group: ${{ vars.AZURE_RESOURCE_GROUP || 'rg-ytsumm-prd' }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          dry-run: "false"
          min-age-hours: "1"
          max-prs-to-check: "50"

      - name: Report cleanup results
        if: inputs.cleanup-stale-environments && steps.cleanup-stale.outputs.deleted-count != '0'
        run: |
          echo "âœ… Cleaned up ${{ steps.cleanup-stale.outputs.deleted-count }} stale SWA environment(s)"
          echo "ðŸ’¡ Deleted environments for PRs: ${{ steps.cleanup-stale.outputs.stale-prs }}"

      # Downloads CI artifact, applies it, writes runtime config, then deploys with retry:
      #   Attempts 1-2: 300s fail-fast timeout
      #   Attempt 3:    1200s extended timeout
      # SWA warm-up may time out on cold start (continue-on-error: true); deployment still succeeds.
      - name: Deploy frontend with CI artifact
        id: deploy-swa
        continue-on-error: true
        uses: ./.github/actions/deploy-frontend-swa
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          ci-run-id: ${{ inputs.ci-run-id }}
          api-url: ${{ inputs.api-url }}
          swa-token: ${{ secrets.SWA_DEPLOYMENT_TOKEN }}
          app-location: apps/web
          runtime-config-path: apps/web/public/runtime-config.js
          output_location: ""
          production-branch: main
          deployment-environment: ${{ inputs.deployment-environment != 'default' && inputs.deployment-environment || '' }}
          verbose: ${{ inputs.environment == 'preview' && 'true' || 'false' }}

      # Configure Auth0 app settings AFTER deploy so the SWA environment exists
      # (for preview, the environment is created by the deploy step above)
      - name: Azure Login (SWA app settings)
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Configure SWA app settings from Key Vault
        continue-on-error: true # don't block deploy if environment not yet ready
        shell: bash
        run: |
          KV_NAME="${{ vars.KEY_VAULT_NAME || 'kv-ytsumm-prd' }}"
          SWA_NAME="${{ vars.SWA_NAME || 'swa-ytsumm-prd' }}"
          RG="${{ vars.AZURE_RESOURCE_GROUP || 'rg-ytsumm-prd' }}"
          # Azure SWA environment name = PR number (e.g. '160'), not deployment-environment (e.g. 'pr-160')
          PR_NUM="${{ inputs.pr-number }}"

          if [[ "${{ inputs.environment }}" == "prod" ]]; then
            AUTH0_SECRET=$(az keyvault secret show --vault-name "$KV_NAME" --name "auth0-session-secret" --query value -o tsv)
            AUTH0_DOMAIN=$(az keyvault secret show --vault-name "$KV_NAME" --name "auth0-domain" --query value -o tsv)
            AUTH0_CLIENT_ID=$(az keyvault secret show --vault-name "$KV_NAME" --name "auth0-client-id" --query value -o tsv)
            AUTH0_CLIENT_SECRET=$(az keyvault secret show --vault-name "$KV_NAME" --name "auth0-client-secret" --query value -o tsv)
            ENV_FLAG=""
          else
            AUTH0_SECRET=$(az keyvault secret show --vault-name "$KV_NAME" --name "auth0-preview-session-secret" --query value -o tsv)
            AUTH0_DOMAIN=$(az keyvault secret show --vault-name "$KV_NAME" --name "auth0-preview-domain" --query value -o tsv)
            AUTH0_CLIENT_ID=$(az keyvault secret show --vault-name "$KV_NAME" --name "auth0-preview-client-id" --query value -o tsv)
            AUTH0_CLIENT_SECRET=$(az keyvault secret show --vault-name "$KV_NAME" --name "auth0-preview-client-secret" --query value -o tsv)
            # Azure SWA uses PR number as the environment name (not the deployment_environment value)
            ENV_FLAG="--environment-name ${PR_NUM}"
          fi

          SWA_HOSTNAME=$(az staticwebapp show --name "$SWA_NAME" --resource-group "$RG" --query defaultHostname -o tsv)

          # For preview: use the preview environment hostname pattern
          if [[ "${{ inputs.environment }}" == "preview" && -n "$PR_NUM" ]]; then
            PREVIEW_SUFFIX="${SWA_HOSTNAME#white-meadow-0b8e2e000.}"
            SWA_BASE_URL="https://white-meadow-0b8e2e000-${PR_NUM}.${PREVIEW_SUFFIX}"
          else
            SWA_BASE_URL="https://${SWA_HOSTNAME}"
          fi

          # shellcheck disable=SC2086
          az staticwebapp appsettings set \
            --name "$SWA_NAME" \
            --resource-group "$RG" \
            $ENV_FLAG \
            --setting-names \
              "AUTH0_SECRET=${AUTH0_SECRET}" \
              "AUTH0_BASE_URL=${SWA_BASE_URL}" \
              "AUTH0_ISSUER_BASE_URL=https://${AUTH0_DOMAIN}" \
              "AUTH0_CLIENT_ID=${AUTH0_CLIENT_ID}" \
              "AUTH0_CLIENT_SECRET=${AUTH0_CLIENT_SECRET}"

          echo "âœ… SWA app settings configured for ${{ inputs.environment }} environment (base URL: ${SWA_BASE_URL})"

      # Re-deploy after setting app settings so the managed function starts with correct env vars.
      # The first deploy creates the environment but warm-up times out without env vars.
      # This second deploy triggers a new warm-up with the env vars now in place.
      # Uses retry script directly (artifact already applied by first deploy).
      - name: Re-deploy frontend with CI artifact (with app settings)
        id: deploy-swa-2
        continue-on-error: true
        shell: bash
        env:
          AZURE_STATIC_WEB_APPS_API_TOKEN: ${{ secrets.SWA_DEPLOYMENT_TOKEN }}
          APP_LOCATION: apps/web
          OUTPUT_LOCATION: ""
          DEPLOYMENT_ENVIRONMENT: ${{ inputs.deployment-environment != 'default' && inputs.deployment-environment || '' }}
          VERBOSE: ${{ inputs.environment == 'preview' && 'true' || 'false' }}
          MAX_ATTEMPTS: "3"
          TIMEOUT_SECONDS: "1200"
        run: |
          chmod +x .github/actions/deploy-frontend-swa/deploy-with-retry.sh
          .github/actions/deploy-frontend-swa/deploy-with-retry.sh

      - name: Resolve deployment URL
        id: resolve-url
        shell: bash
        run: |
          DEPLOY_URL="${{ steps.deploy-swa-2.outputs.static_web_app_url || steps.deploy-swa.outputs.static_web_app_url }}"
          if [[ -n "$DEPLOY_URL" ]]; then
            echo "url=$DEPLOY_URL" >> "$GITHUB_OUTPUT"
          else
            # Warmup/cold-start timeout - deployment may still succeed; resolve URL from Azure
            SWA_NAME="${{ vars.SWA_NAME || 'swa-ytsumm-prd' }}"
            RG="${{ vars.AZURE_RESOURCE_GROUP || 'rg-ytsumm-prd' }}"
            PR_NUM="${{ inputs.pr-number }}"
            if [[ "${{ inputs.environment }}" == "prod" ]]; then
              HOSTNAME=$(az staticwebapp show --name "$SWA_NAME" --resource-group "$RG" --query defaultHostname -o tsv 2>/dev/null || echo "")
              if [[ -n "$HOSTNAME" ]]; then
                echo "url=https://$HOSTNAME" >> "$GITHUB_OUTPUT"
              else
                echo "::error::Could not resolve production deployment URL"
                exit 1
              fi
            else
              # For preview: construct URL from environment name (Azure uses PR number as env name)
              HOSTNAME=$(az staticwebapp environment show --name "$SWA_NAME" --resource-group "$RG" \
                --environment-name "$PR_NUM" --query hostname -o tsv 2>/dev/null || echo "")
              if [[ -n "$HOSTNAME" ]]; then
                echo "url=https://$HOSTNAME" >> "$GITHUB_OUTPUT"
              else
                echo "::error::Preview deployment failed - no URL available (environment '$PR_NUM' not found)"
                exit 1
              fi
            fi
          fi

      - name: Verify frontend deployment
        if: steps.resolve-url.outputs.url != ''
        uses: AshleyHollis/shared-infra/.github/actions/health-check@v1
        with:
          url: ${{ steps.resolve-url.outputs.url }}
          max-attempts: ${{ env.HEALTH_CHECK_MAX_ATTEMPTS }}
          interval-seconds: ${{ env.HEALTH_CHECK_INTERVAL }}
          timeout-seconds: ${{ env.HEALTH_CHECK_TIMEOUT }}
          expected-status: "200"
          service-name: "${{ inputs.environment == 'prod' && 'Production' || 'Preview' }} Web"
