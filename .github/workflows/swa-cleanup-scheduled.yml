# =============================================================================
# Scheduled SWA Environment Cleanup
# =============================================================================
# Runs daily to clean up stale Azure Static Web Apps staging environments
# for PRs that have been closed/merged

name: SWA Cleanup (Scheduled)

on:
  schedule:
    # Run daily at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:
    inputs:
      dry-run:
        description: 'Dry run mode (no actual deletion)'
        required: false
        type: boolean
        default: true

permissions:
  id-token: write
  contents: read
  pull-requests: read

jobs:
  cleanup-stale-environments:
    name: Cleanup Stale SWA Environments
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Azure Login via OIDC
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Find and cleanup stale environments
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          DRY_RUN: ${{ github.event.inputs.dry-run || 'false' }}
          SWA_NAME: ${{ vars.SWA_NAME || 'swa-ytsumm-prd' }}
          RESOURCE_GROUP: ${{ vars.SWA_RESOURCE_GROUP || 'rg-ytsumm-prd' }}
        run: |
          set -euo pipefail
          
          echo "üîç Finding stale SWA staging environments..."
          echo "Static Web App: $SWA_NAME"
          echo "Resource Group: $RESOURCE_GROUP"
          echo "Dry Run: $DRY_RUN"
          echo ""
          
          # Get all open PRs
          echo "üìã Fetching open PRs..."
          open_prs=$(gh pr list --state open --json number --jq '.[].number' | tr '\n' ' ' || echo "")
          echo "Open PRs: ${open_prs:-none}"
          
          # Create associative array of open PRs for fast lookup
          declare -A active_prs
          for pr in $open_prs; do
            active_prs[$pr]=1
          done
          
          # List all SWA environments (staging environments show as builds)
          echo ""
          echo "üåê Fetching SWA environments..."
          
          # Get SWA environments using Azure CLI
          # Note: Staging environments in SWA are tied to PR numbers
          # We'll use the GitHub API to check which PRs are closed
          
          # Get recently closed PRs (last 30 days, limit 100)
          echo "üìã Fetching recently closed PRs..."
          closed_prs=$(gh pr list --state closed --limit 100 --json number,closedAt --jq '.[] | select(.closedAt != null) | "\(.number)|\(.closedAt)"' || echo "")
          
          deleted_count=0
          current_time=$(date +%s)
          
          echo ""
          echo "üóëÔ∏è  Processing closed PRs..."
          while IFS='|' read -r pr_number closed_at; do
            # Skip if empty
            [[ -z "$pr_number" ]] && continue
            
            # Skip if PR is still open
            if [[ -v active_prs[$pr_number] ]]; then
              echo "‚è≠Ô∏è  PR #$pr_number is still open, skipping"
              continue
            fi
            
            # Calculate how long ago PR was closed
            closed_timestamp=$(date -d "$closed_at" +%s 2>/dev/null || date -j -f "%Y-%m-%dT%H:%M:%SZ" "$closed_at" +%s 2>/dev/null || echo "0")
            age_hours=$(( (current_time - closed_timestamp) / 3600 ))
            
            # Only cleanup if closed more than 1 hour ago (avoid race conditions)
            if [[ $age_hours -lt 1 ]]; then
              echo "‚è≠Ô∏è  PR #$pr_number closed recently ($age_hours hours ago), skipping"
              continue
            fi
            
            echo "üóëÔ∏è  PR #$pr_number closed $age_hours hours ago - environment is stale"
            
            if [[ "$DRY_RUN" == "true" ]]; then
              echo "   [DRY RUN] Would attempt to delete staging environment for PR #$pr_number"
              ((deleted_count++))
            else
              # Attempt to delete the staging environment
              # SWA staging environments are managed per-PR by the deployment token
              # We need to use the SWA CLI or API to delete them
              echo "   ‚ö†Ô∏è  Note: Actual deletion requires the SWA deployment action"
              echo "   PR #$pr_number should be cleaned up by the PR close trigger"
              # The actual cleanup happens in preview-cleanup.yml when PR closes
            fi
          done <<< "$closed_prs"
          
          echo ""
          echo "‚úÖ Scan complete: $deleted_count stale environments found"
          
          # Create job summary
          cat >> $GITHUB_STEP_SUMMARY << EOF
          ## üóëÔ∏è SWA Stale Environment Cleanup Report
          
          **Static Web App:** \`$SWA_NAME\`  
          **Resource Group:** \`$RESOURCE_GROUP\`  
          **Mode:** $([ "$DRY_RUN" == "true" ] && echo "üîç Dry Run" || echo "üóëÔ∏è Active Deletion")
          
          ### Results
          - **Stale environments found:** $deleted_count
          - **Open PRs (kept):** ${#active_prs[@]}
          
          > **Note:** SWA staging environments are automatically deleted when PRs are closed via the \`preview-cleanup.yml\` workflow.
          > This scheduled job identifies any orphaned environments that may have been missed.
          EOF

      - name: Check SWA environment count
        env:
          SWA_NAME: ${{ vars.SWA_NAME || 'swa-ytsumm-prd' }}
          RESOURCE_GROUP: ${{ vars.SWA_RESOURCE_GROUP || 'rg-ytsumm-prd' }}
        run: |
          echo "üìä Checking current SWA environment status..."
          
          # Try to get build count (requires specific permissions)
          # This is informational only
          az staticwebapp show \
            --name "$SWA_NAME" \
            --resource-group "$RESOURCE_GROUP" \
            --query "{name:name,sku:sku.tier,status:status}" \
            -o table || echo "Unable to query SWA details (may require additional permissions)"
