# =============================================================================
# Scheduled SWA Environment Detection
# =============================================================================
# Runs daily to detect stale Azure Static Web Apps staging environments
# for PRs that have been closed/merged
#
# NOTE: Cannot automatically delete environments due to Azure SWA API limitations.
# Environments can only be deleted via:
# 1. PR close event (triggers preview-cleanup.yml)
# 2. Manual deletion in Azure Portal

name: SWA Cleanup (Scheduled)

on:
  schedule:
    # Run daily at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:

permissions:
  id-token: write
  contents: read
  pull-requests: read

jobs:
  detect-stale-environments:
    name: Detect Stale SWA Environments
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Find stale PRs
        id: find-stale
        uses: ./.github/actions/find-stale-prs
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          min-age-hours: '168'  # 7 days
          max-prs-to-check: '100'
      
      - name: Report stale environments
        if: steps.find-stale.outputs.stale-count != '0'
        run: |
          echo "üîç Stale SWA Environment Report"
          echo "================================"
          echo ""
          echo "üìä Found ${{ steps.find-stale.outputs.stale-count }} stale environment(s)"
          echo ""
          echo "üìã Stale PRs:"
          echo "${{ steps.find-stale.outputs.stale-prs }}"
          echo ""
          echo "üí° Cleanup Instructions:"
          echo "1. Close stale PRs (triggers automatic cleanup):"
          echo "   gh pr close <PR_NUMBER>"
          echo ""
          echo "2. Or manually delete in Azure Portal:"
          echo "   - Navigate to portal.azure.com"
          echo "   - Find Static Web App resource"
          echo "   - Go to: Environments"
          echo "   - Delete environments for closed PRs"
          echo ""
          echo "‚ö†Ô∏è  Why can't we auto-delete?"
          echo "   Azure SWA environments can only be deleted via:"
          echo "   - PR close event (GitHub context required)"
          echo "   - Azure Portal (manual)"
      
      - name: No stale environments found
        if: steps.find-stale.outputs.stale-count == '0'
        run: |
          echo "‚úÖ No stale SWA environments found"
          echo "All environments are associated with active PRs"
