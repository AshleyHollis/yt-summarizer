# =============================================================================
# Scheduled SWA Environment Cleanup
# =============================================================================
# Runs daily to clean up stale Azure Static Web Apps staging environments
# for PRs that have been closed/merged
#
# Uses Azure CLI to list and delete environments by matching build metadata
# to closed PRs.

name: SWA Cleanup (Scheduled)

on:
  schedule:
    # Run daily at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:
    inputs:
      dry-run:
        description: 'Dry run mode (report only, no deletions)'
        required: false
        type: boolean
        default: false

permissions:
  id-token: write
  contents: read
  pull-requests: read

jobs:
  cleanup-stale-environments:
    name: Cleanup Stale SWA Environments
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v2
        with:
          auth-type: OIDC
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Cleanup stale SWA environments
        id: cleanup
        uses: ./.github/actions/cleanup-stale-swa-environments
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          swa-name: ${{ vars.SWA_NAME || 'swa-ytsumm-prd' }}
          resource-group: ${{ vars.AZURE_RESOURCE_GROUP || 'rg-ytsumm-prd' }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          dry-run: ${{ github.event.inputs.dry-run || 'false' }}
          min-age-hours: '168'  # 7 days
          max-prs-to-check: '100'
      
      - name: Report cleanup results
        if: always()
        run: |
          if [[ "${{ steps.cleanup.outputs.deleted-count }}" != "0" ]]; then
            echo "âœ… Cleaned up ${{ steps.cleanup.outputs.deleted-count }} stale environment(s)"
            echo "ðŸ’¡ Deleted environments for PRs: ${{ steps.cleanup.outputs.stale-prs }}"
          else
            echo "âœ… No stale environments found or all cleanup completed"
          fi

      - name: Set AKS Context for secret cleanup
        if: always() && steps.cleanup.outputs.stale-prs
        uses: azure/aks-set-context@v3
        with:
          resource-group: ${{ vars.AZURE_RESOURCE_GROUP || 'rg-ytsumm-prd' }}
          cluster-name: ${{ vars.AZURE_AKS_CLUSTER_NAME || 'aks-ytsumm-prd' }}

      - name: Cleanup image pull secrets for stale PR previews
        if: always() && steps.cleanup.outputs.stale-prs
        shell: bash
        run: |
          set -euo pipefail
          PRS="${{ steps.cleanup.outputs.stale-prs }}"
          echo "Stale PRs: $PRS"
          IFS=',' read -ra PR_ARR <<< "$PRS"
          for pr in "${PR_ARR[@]}"; do
            ns="preview-pr-$pr"
            echo "Processing namespace: $ns"
            if ! kubectl get ns "$ns" &>/dev/null; then
              echo "  Namespace $ns not found, skipping"
              continue
            fi
            mapfile -t secrets < <(kubectl get secret -n "$ns" -o json 2>/dev/null | jq -r '.items[] | select(.type=="kubernetes.io/dockerconfigjson") | .metadata.name' || true)
            if [ ${#secrets[@]} -eq 0 ]; then
              echo "  No docker-registry secrets found in $ns"
              continue
            fi
            for s in "${secrets[@]}"; do
              echo "  Deleting secret $s in $ns"
              kubectl delete secret "$s" -n "$ns" --ignore-not-found=true || true
            done
          done
