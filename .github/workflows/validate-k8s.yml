name: Validate Kubernetes Manifests

on:
  pull_request:
    paths:
      - 'k8s/**'
      - '.github/workflows/validate-k8s.yml'
  push:
    branches: [main]
    paths:
      - 'k8s/**'

jobs:
  validate:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup PowerShell
      uses: actions/setup-powershell@v1
      with:
        pwsh: true

    - name: Install kubectl
      uses: azure/setup-kubectl@v3
      with:
        version: 'v1.28.0'

    - name: Install kustomize
      run: |
        curl -s "https://raw.githubusercontent.com/kubernetes-sigs/kustomize/master/hack/install_kustomize.sh" | bash
        sudo mv kustomize /usr/local/bin/

    - name: Install PowerShell YAML module
      run: |
        pwsh -Command "Install-Module -Name powershell-yaml -Force -Scope CurrentUser"

    - name: Validate Kubernetes manifests
      run: |
        pwsh scripts/validate-k8s.ps1

    - name: Validate Argo CD applications
      run: |
        # Check that Argo CD applications can be parsed
        find k8s/argocd -name "*.yaml" -exec kubectl apply --dry-run=client -f {} \;

    - name: Test Kustomize builds
      run: |
        # Test all kustomization builds
        find k8s -name "kustomization.yaml" -execdir kustomize build . --dry-run \;