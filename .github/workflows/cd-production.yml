# Production Deployment Workflow
# Requires manual trigger and approval before deployment
# Uses Argo CD GitOps - updates production overlay, Argo CD syncs to cluster

name: Deploy to Production

on:
  workflow_dispatch:
    inputs:
      staging_sha:
        description: 'Staging image SHA to promote (from staging deployment)'
        required: true
        type: string
      confirm_deploy:
        description: 'Type "DEPLOY" to confirm production deployment'
        required: true
        type: string
      skip_health_check:
        description: 'Skip post-deployment health check (not recommended)'
        required: false
        type: boolean
        default: false

concurrency:
  group: production-deploy
  cancel-in-progress: false

env:
  ACR_NAME: ${{ vars.ACR_NAME }}
  AZURE_RESOURCE_GROUP: ${{ vars.AZURE_RESOURCE_GROUP }}
  SWA_NAME: ${{ vars.SWA_PRODUCTION_NAME }}
  PRODUCTION_URL: ${{ vars.PRODUCTION_URL }}

jobs:
  validate:
    name: Validate Deployment Request
    runs-on: ubuntu-latest
    outputs:
      image_tag: ${{ steps.validate.outputs.image_tag }}
    steps:
      - name: Validate confirmation
        id: validate
        run: |
          if [ "${{ inputs.confirm_deploy }}" != "DEPLOY" ]; then
            echo "::error::Deployment not confirmed. You must type 'DEPLOY' to proceed."
            exit 1
          fi
          
          # Validate SHA format
          SHA="${{ inputs.staging_sha }}"
          if [[ ! "$SHA" =~ ^[a-f0-9]{7,40}$ ]]; then
            echo "::error::Invalid SHA format: $SHA"
            exit 1
          fi
          
          echo "image_tag=sha-${SHA:0:7}" >> "$GITHUB_OUTPUT"
          echo "âœ… Deployment validated for SHA: $SHA"

  deploy-backend:
    name: Deploy Backend to Production
    runs-on: ubuntu-latest
    needs: validate
    environment: production
    permissions:
      id-token: write
      contents: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Azure Login via OIDC
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Login to ACR
        run: az acr login --name ${{ env.ACR_NAME }}

      - name: Verify images exist in ACR
        run: |
          IMAGE_TAG="${{ needs.validate.outputs.image_tag }}"
          ACR_URL="${{ env.ACR_NAME }}.azurecr.io"
          
          echo "Verifying API image..."
          az acr repository show-tags --name ${{ env.ACR_NAME }} --repository api | grep -q "${IMAGE_TAG}" || {
            echo "::error::API image with tag ${IMAGE_TAG} not found in ACR"
            exit 1
          }
          
          echo "Verifying Workers image..."
          az acr repository show-tags --name ${{ env.ACR_NAME }} --repository workers | grep -q "${IMAGE_TAG}" || {
            echo "::error::Workers image with tag ${IMAGE_TAG} not found in ACR"
            exit 1
          }
          
          echo "âœ… Both images verified: ${IMAGE_TAG}"

      - name: Update production kustomization
        run: |
          IMAGE_TAG="${{ needs.validate.outputs.image_tag }}"
          ACR_URL="${{ env.ACR_NAME }}.azurecr.io"
          TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          
          cd k8s/overlays/production
          
          # Update the kustomization.yaml with new image tags
          cat > kustomization.yaml << EOF
          apiVersion: kustomize.config.k8s.io/v1beta1
          kind: Kustomization
          
          namespace: yt-summarizer
          
          resources:
            - ../../base
          
          # Production image tags - promoted from staging
          # Last updated: ${TIMESTAMP}
          # Staging SHA: ${{ inputs.staging_sha }}
          images:
            - name: api
              newName: ${ACR_URL}/api
              newTag: ${IMAGE_TAG}
            - name: workers
              newName: ${ACR_URL}/workers
              newTag: ${IMAGE_TAG}
          
          # Production-specific patches
          patches:
            - path: patches/configmap-patch.yaml
            - path: patches/ingress-patch.yaml
            - path: patches/resources-patch.yaml
          
          # Production labels
          commonLabels:
            environment: production
            managed-by: argocd
          EOF
          
          echo "âœ… Updated production kustomization with tag: ${IMAGE_TAG}"

      - name: Commit and push changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          git add k8s/overlays/production/kustomization.yaml
          git commit -m "chore(prod): promote ${{ needs.validate.outputs.image_tag }} to production

          Staging SHA: ${{ inputs.staging_sha }}
          Triggered by: ${{ github.actor }}
          Workflow run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          
          git push origin main
          
          echo "âœ… Production manifest updated - Argo CD will sync automatically"

  deploy-frontend:
    name: Deploy Frontend to Production
    runs-on: ubuntu-latest
    needs: validate
    environment: production
    permissions:
      id-token: write
      contents: read
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.staging_sha }}

      - name: Setup Node.js
        uses: ./.github/actions/setup-node

      - name: Build frontend for production
        working-directory: apps/web
        env:
          NEXT_PUBLIC_API_URL: ${{ vars.PRODUCTION_API_URL }}
          NEXT_PUBLIC_ENVIRONMENT: production
        run: |
          npm ci
          npm run build

      - name: Azure Login via OIDC
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Deploy to Static Web Apps
        uses: Azure/static-web-apps-deploy@v1
        with:
          azure_static_web_apps_api_token: ${{ secrets.SWA_PRODUCTION_TOKEN }}
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          action: upload
          app_location: apps/web
          output_location: .next
          skip_app_build: true
          production_branch: main

  health-check:
    name: Verify Production Deployment
    runs-on: ubuntu-latest
    needs: [validate, deploy-backend, deploy-frontend]
    if: ${{ !inputs.skip_health_check }}
    steps:
      - name: Wait for Argo CD sync
        run: |
          echo "Waiting 60 seconds for Argo CD to sync..."
          sleep 60

      - name: Check API health
        run: |
          MAX_ATTEMPTS=10
          ATTEMPT=1
          
          while [ $ATTEMPT -le $MAX_ATTEMPTS ]; do
            echo "Health check attempt $ATTEMPT of $MAX_ATTEMPTS..."
            
            HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" \
              "${{ vars.PRODUCTION_API_URL }}/health" \
              --connect-timeout 10 \
              --max-time 30 || echo "000")
            
            if [ "$HTTP_STATUS" = "200" ]; then
              echo "âœ… API health check passed (HTTP $HTTP_STATUS)"
              break
            fi
            
            echo "âš ï¸ API returned HTTP $HTTP_STATUS, retrying in 15s..."
            ATTEMPT=$((ATTEMPT + 1))
            sleep 15
          done
          
          if [ $ATTEMPT -gt $MAX_ATTEMPTS ]; then
            echo "::error::API health check failed after $MAX_ATTEMPTS attempts"
            echo "::warning::Consider rolling back using Argo CD"
            exit 1
          fi

      - name: Check frontend health
        run: |
          HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" \
            "${{ env.PRODUCTION_URL }}" \
            --connect-timeout 10 \
            --max-time 30 || echo "000")
          
          if [ "$HTTP_STATUS" = "200" ]; then
            echo "âœ… Frontend health check passed (HTTP $HTTP_STATUS)"
          else
            echo "::warning::Frontend returned HTTP $HTTP_STATUS"
          fi

  summary:
    name: Deployment Summary
    runs-on: ubuntu-latest
    needs: [validate, deploy-backend, deploy-frontend, health-check]
    if: always()
    steps:
      - name: Generate summary
        run: |
          echo "# ðŸš€ Production Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Deployment Details" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Image Tag** | \`${{ needs.validate.outputs.image_tag }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Staging SHA** | \`${{ inputs.staging_sha }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Triggered By** | @${{ github.actor }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Timestamp** | $(date -u +"%Y-%m-%d %H:%M:%S UTC") |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "## Job Status" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Validation | ${{ needs.validate.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Backend Deploy | ${{ needs.deploy-backend.result == 'success' && 'âœ… Success' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Frontend Deploy | ${{ needs.deploy-frontend.result == 'success' && 'âœ… Success' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Health Check | ${{ needs.health-check.result == 'success' && 'âœ… Passed' || (needs.health-check.result == 'skipped' && 'â­ï¸ Skipped' || 'âŒ Failed') }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "## Quick Links" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸŒ [Production Site](${{ env.PRODUCTION_URL }})" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ“Š [Azure Portal](https://portal.azure.com/#@/resource/subscriptions/${{ secrets.AZURE_SUBSCRIPTION_ID }}/resourceGroups/${{ env.AZURE_RESOURCE_GROUP }})" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ”„ [Argo CD Dashboard](https://argocd.${{ vars.PRODUCTION_DOMAIN }})" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ needs.health-check.result }}" = "failure" ]; then
            echo "## âš ï¸ Rollback Instructions" >> $GITHUB_STEP_SUMMARY
            echo "If you need to rollback, use Argo CD:" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
            echo "argocd app rollback yt-summarizer-production" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          fi
