# =============================================================================
# Deploy to Production Workflow
# =============================================================================
# Automatically deploys to production when a PR is merged to main.
# Uses reusable workflows for common operations to ensure consistency
# with preview deployments and reduce maintenance burden.
#
# SIMPLIFIED STRATEGY:
# -------------------
# - Always runs terraform/deploy jobs (predictable behavior)
# - Uses CI-built images (sha-{commit}) for consistency
# - Removed detect-changes logic for reliability and debuggability
#
# IMAGE BUILD STRATEGY:
#   - CI builds images as sha-{commit} when code is pushed to main
#   - Production waits for CI and uses those tested images
#   - Each deployment is traceable to a specific git commit
#
# REUSABLE WORKFLOWS:
#   - update-k8s-overlay.yml: Updates and validates kustomization
#   - verify-k8s-deployment.yml: ArgoCD sync + health checks
#   - deploy-frontend-swa.yml: SWA deployment with health verification
#
# NOTE: We intentionally do NOT use paths-ignore for k8s/overlays/** because:
# 1. PR merges often include kustomization changes alongside code changes
# 2. paths-ignore would skip deployment entirely if ANY file matches
# 3. Instead, kustomization-only commits use [skip ci] in commit message
#
# See also: preview.yml for PR-scoped image strategy
#           ci.yml for image building logic
# =============================================================================

name: Deploy to Production

on:
  push:
    branches: [main]
    paths-ignore:
      - "*.md"
      - "docs/**"
      - "specs/**"
  workflow_dispatch:
    inputs:
      run_terraform:
        description: "Run terraform plan/apply"
        required: false
        type: boolean
        default: true
      run_deploy:
        description: "Build and deploy backend"
        required: false
        type: boolean
        default: true
      run_frontend:
        description: "Deploy frontend"
        required: false
        type: boolean
        default: true
      run_health_check:
        description: "Run post-deploy health checks"
        required: false
        type: boolean
        default: true

concurrency:
  group: deploy-prod
  cancel-in-progress: false

env:
  # Shared variables are loaded from .github/config/shared.env via load-shared-env action
  # Only environment-specific overrides and GitHub variables are set here

  # GitHub Variables (can override shared.env defaults)
  ACR_NAME: ${{ vars.ACR_NAME || 'acrytsummprd' }}
  ACR_LOGIN_SERVER: ${{ vars.ACR_LOGIN_SERVER || 'acrytsummprd.azurecr.io' }}

  # Production-specific values
  ARGOCD_APP_NAME_PROD: "yt-summarizer-prod"
  NAMESPACE_PROD: "yt-summarizer"
  PRODUCTION_URL: ${{ vars.PRODUCTION_URL || 'https://api.yt-summarizer.example.com' }}
  ARGOCD_SYNC_TIMEOUT: "360"
  KUSTOMIZE_OVERLAY_PROD: "k8s/overlays/prod"

permissions:
  id-token: write
  contents: write

jobs:
  # ---------------------------------------------------------------------------
  # Wait for CI to succeed (auto-apply gate)
  # ---------------------------------------------------------------------------
  wait-for-ci:
    name: Wait for CI
    runs-on: ubuntu-latest
    outputs:
      ci_run_id: ${{ steps.wait.outputs.ci_run_id }}
      image_tag: ${{ steps.wait.outputs.image_tag }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Wait for CI workflow to complete
        id: wait
        uses: ./.github/actions/wait-for-ci
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          commit-sha: ${{ github.sha }}
          timeout-seconds: "1800"

  # ---------------------------------------------------------------------------
  # Resolve Terraform Configuration
  # ---------------------------------------------------------------------------
  # Calls reusable workflow to resolve Terraform configuration from Actions Variables
  # See .github/workflows/resolve-terraform-config.yml for details
  tf-config:
    uses: ./.github/workflows/resolve-terraform-config.yml

  # ---------------------------------------------------------------------------
  # Terraform (Plan + Apply)
  # ---------------------------------------------------------------------------
  terraform:
    name: Terraform
    uses: ./.github/workflows/terraform-deploy.yml
    needs: [wait-for-ci]
    permissions:
      id-token: write
      contents: read
      pull-requests: write
    if: |
      needs.wait-for-ci.result == 'success' &&
      ((github.event_name == 'workflow_dispatch' && inputs.run_terraform != false) ||
       (github.event_name != 'workflow_dispatch'))
    with:
      environment: production
      terraform-version: ${{ vars.TERRAFORM_VERSION || '1.5.7' }}
      working-directory: infra/terraform/environments/prod
      run-plan: true
      run-apply: true
      require-changes: true
      post-to-pr: false
    secrets: inherit

  # ---------------------------------------------------------------------------
  # Sync Argo CD Manifests
  # ---------------------------------------------------------------------------
  sync-argocd-manifests:
    name: Sync Argo CD Manifests
    runs-on: ubuntu-latest
    needs: [terraform]
    if: |
      !cancelled() &&
      needs.terraform.result != 'failure'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Load shared environment
        uses: ./.github/actions/load-shared-env

      - name: Setup Azure and AKS
        uses: ./.github/actions/setup-azure-aks
        with:
          azure-client-id: ${{ secrets.AZURE_CLIENT_ID }}
          azure-tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          azure-subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          resource-group: ${{ vars.AZURE_RESOURCE_GROUP || 'rg-ytsumm-prd' }}
          cluster-name: ${{ vars.AKS_CLUSTER_NAME || 'aks-ytsumm-prd' }}

      - name: Sync Argo CD manifests
        uses: ./.github/actions/sync-argocd-manifests
        with:
          mode: all
          namespace: ${{ env.NAMESPACE_ARGOCD }}
          verbose: "true"

  # ---------------------------------------------------------------------------
  # Get Image Tag from CI
  # ---------------------------------------------------------------------------
  get-image-tag:
    name: Get Image Tag
    runs-on: ubuntu-latest
    needs: [wait-for-ci, terraform, sync-argocd-manifests]
    if: |
      !cancelled() &&
      needs.wait-for-ci.result == 'success' &&
      needs.terraform.result != 'failure' &&
      needs.sync-argocd-manifests.result != 'failure' &&
      ((github.event_name == 'workflow_dispatch' && inputs.run_deploy != false) ||
       (github.event_name != 'workflow_dispatch'))
    outputs:
      image_tag: ${{ steps.normalize-tag.outputs.image_tag }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Load shared environment
        uses: ./.github/actions/load-shared-env

      - name: Extract image tag from CI
        id: extract
        shell: bash
        run: scripts/workflows/prod-extract-ci-image-tag.sh

      - name: Normalize image tag
        id: normalize-tag
        shell: bash
        env:
          WAIT_FOR_CI_TAG: ${{ needs.wait-for-ci.outputs.image_tag }}
        run: |
          # Prefer image tag from wait-for-ci (correctly resolves [skip ci] bot commits)
          image_tag="${WAIT_FOR_CI_TAG:-}"
          if [ -z "$image_tag" ]; then
            image_tag="${{ steps.extract.outputs.image_tag }}"
          fi
          if [ -z "$image_tag" ]; then
            short_sha="${GITHUB_SHA:0:7}"
            image_tag="sha-${short_sha}"
            echo "::warning::Image tag output was empty; falling back to ${image_tag}"
          fi
          echo "image_tag=$image_tag" >> "$GITHUB_OUTPUT"

      - name: Azure Login and ACR authentication
        uses: ./.github/actions/azure-acr-login
        with:
          azure-client-id: ${{ secrets.AZURE_CLIENT_ID }}
          azure-tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          azure-subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          acr-name: ${{ env.ACR_NAME }}

      - name: Validate CI image exists in ACR
        uses: ./.github/actions/validate-docker-image
        with:
          validation-type: acr-exists
          image-tag: ${{ steps.normalize-tag.outputs.image_tag }}
          registry: ${{ env.ACR_NAME }}
          repository: ${{ env.API_IMAGE_NAME }}
          fail-if-missing: "true"

  # ---------------------------------------------------------------------------
  # Update Production Overlay (Reusable Workflow)
  # ---------------------------------------------------------------------------
  update-overlay:
    name: Update Production Overlay
    uses: ./.github/workflows/update-k8s-overlay.yml
    needs: [wait-for-ci, terraform, sync-argocd-manifests, get-image-tag]
    if: |
      always() && !cancelled() &&
      needs.wait-for-ci.result == 'success' &&
      needs.terraform.result != 'failure' &&
      needs.sync-argocd-manifests.result != 'failure' &&
      needs.get-image-tag.result == 'success'
    with:
      environment: prod
      overlay-path: k8s/overlays/prod
      image-tag: ${{ needs.get-image-tag.outputs.image_tag }}
      commit-sha: ${{ github.sha }}
      git-branch: main
      template-path: scripts/ci/templates/prod-kustomization-template.yaml
      run-k8s-pull-test: true
    secrets:
      AZURE_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
      AZURE_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
      AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
      DEPLOY_APP_ID: ${{ secrets.DEPLOY_APP_ID }}
      DEPLOY_APP_PRIVATE_KEY: ${{ secrets.DEPLOY_APP_PRIVATE_KEY }}

  # ---------------------------------------------------------------------------
  # Verify Deployment (Reusable Workflow)
  # ---------------------------------------------------------------------------
  verify-deployment:
    name: Verify Deployment
    uses: ./.github/workflows/verify-k8s-deployment.yml
    needs: [update-overlay, get-image-tag]
    if: |
      !cancelled() &&
      needs.update-overlay.result == 'success'
    with:
      environment: prod
      namespace: yt-summarizer
      argocd-app-name: yt-summarizer-prod
      expected-image-tag: ${{ needs.get-image-tag.outputs.image_tag }}
      api-url: ${{ vars.PRODUCTION_URL || 'https://api.yt-summarizer.example.com' }}
      host: api.yt-summarizer.apps.ashleyhollis.com
      max-wait-seconds: "360"
      auto-recovery: false
    secrets:
      AZURE_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
      AZURE_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
      AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

  # ---------------------------------------------------------------------------
  # Deploy Frontend to SWA (Reusable Workflow)
  # ---------------------------------------------------------------------------
  deploy-frontend:
    name: Deploy Frontend
    uses: ./.github/workflows/deploy-frontend-swa.yml
    needs: [wait-for-ci, terraform]
    if: |
      !cancelled() &&
      needs.wait-for-ci.result == 'success' &&
      (needs.terraform.result == 'success' || needs.terraform.result == 'skipped') &&
      ((github.event_name == 'workflow_dispatch' && inputs.run_frontend != false) ||
       (github.event_name != 'workflow_dispatch'))
    with:
      environment: prod
      ci-run-id: ${{ needs.wait-for-ci.outputs.ci_run_id }}
      api-url: ${{ vars.PRODUCTION_API_URL || vars.PRODUCTION_URL || 'https://api.yt-summarizer.example.com' }}
      deployment-environment: default
    secrets:
      AZURE_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
      AZURE_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
      AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
      SWA_DEPLOYMENT_TOKEN: ${{ secrets.SWA_DEPLOYMENT_TOKEN }}

  # ---------------------------------------------------------------------------
  # Deployment Summary
  # ---------------------------------------------------------------------------
  summary:
    name: Deployment Summary
    runs-on: ubuntu-latest
    needs:
      - get-image-tag
      - sync-argocd-manifests
      - update-overlay
      - verify-deployment
      - deploy-frontend
      - wait-for-ci
      - terraform
    if: always()
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Load shared environment
        uses: ./.github/actions/load-shared-env

      - name: Write execution rationale
        run: |
          {
            echo "## Prod Deployment Summary"
            echo ""
            echo "- Wait for CI: ${{ needs.wait-for-ci.result }}"
            terraform_plan_changes="n/a"
            if [[ "${{ needs.terraform.result }}" == 'success' ]]; then
              terraform_plan_changes="${{ fromJson(needs.terraform.outputs.plan-summary || '{}').has_changes || 'unknown' }}"
            fi
            echo "- Terraform plan: ${{ needs.terraform.result }}"
            echo "  changes: ${terraform_plan_changes}"
            echo "- Terraform apply: ${{ needs.terraform.result }}"
            echo "- Argo CD manifests sync: ${{ needs.sync-argocd-manifests.result }}"
            echo "- Backend deploy tag: ${{ needs.get-image-tag.outputs.image_tag || 'n/a' }}"
            echo "- Overlay update: ${{ needs.update-overlay.result }}"
            echo "- Deployment verification: ${{ needs.verify-deployment.result }}"
            echo "- Frontend deploy: ${{ needs.deploy-frontend.result }}"
          } >> "$GITHUB_STEP_SUMMARY"

      - name: Generate summary
        uses: ./.github/actions/create-pipeline-summary
        with:
          summary-type: prod
          image-tag: ${{ needs.get-image-tag.outputs.image_tag }}
          commit-sha: ${{ github.sha }}
          update-overlay-result: ${{ needs.update-overlay.result }}
          verify-deployment-result: ${{ needs.verify-deployment.result }}
          deploy-frontend-result: ${{ needs.deploy-frontend.result }}
