# =============================================================================
# CI Workflow - Automated Testing and Image Building
# =============================================================================
# TRIGGERS: PR opened/updated, push to main, manual dispatch
#
# EXECUTION FLOW:
#   → ALWAYS runs FULL validation (all tests, all checks, all builds)
#   → Purpose: Ensure all code is always in a validated state
#   → No conditional skipping based on changes
#
# BUILD MODES:
#   - ACR configured → Build and push images to Azure Container Registry
#
# For details on adding new workflow scripts, see: REFACTORING.md
# =============================================================================

name: CI

on:
  pull_request:
    branches: [main]
    types: [opened, synchronize, reopened]
  push:
    branches: [main]
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  PYTHON_VERSION: "3.11"
  NODE_VERSION: "20"
  ACR_NAME: ${{ vars.ACR_NAME || 'acrytsummprd' }}
  ACR_LOGIN_SERVER: ${{ vars.ACR_LOGIN_SERVER || 'acrytsummprd.azurecr.io' }}

defaults:
  run:
    shell: bash -e {0}  # Exit immediately if any command fails

jobs:
  # ===========================================================================
  # PHASE 1: LINTING
  # ===========================================================================
  # Python: services/api, services/workers, services/shared
  # Frontend: apps/web
  # Blocks tests if lint fails (fail-fast pattern)
  # ===========================================================================
  00-lint-python:
    name: 00 · Lint Python
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: ./.github/actions/setup-python-env
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          install-mode: service
          service-package: services/shared
          install-pytest-xdist: 'true'

      - name: Run ruff checks
        uses: ./.github/actions/run-ruff-check

  01-frontend-quality:
    name: Frontend Quality
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: ./.github/actions/setup-node
        with:
          node-version: ${{ env.NODE_VERSION }}
          working-directory: apps/web

      - name: Run ESLint
        working-directory: apps/web
        run: npm run lint

      - name: Scan JavaScript dependencies
        uses: ./.github/actions/scan-javascript-dependencies
        with:
          working-directory: apps/web
          check-missing-deps: 'true'
          check-security: 'true'
          audit-level: 'high'

      - name: Run Vitest
        uses: ./.github/actions/run-frontend-tests

      - name: Restore Next.js build cache
        uses: actions/cache@v4
        with:
          path: apps/web/.next/cache
          key: >-
            ${{ runner.os }}-nextjs-
            ${{ hashFiles('apps/web/package-lock.json') }}-
            ${{ hashFiles('apps/web/next.config.*') }}-
            ${{ hashFiles('apps/web/tsconfig.json') }}
          restore-keys: |
            ${{ runner.os }}-nextjs-

      - name: TypeScript type check
        working-directory: apps/web
        run: npx tsc --noEmit

      - name: Build Next.js application (standalone for SWA)
        working-directory: apps/web
        run: npm run build

      - name: Upload frontend build artifact
        uses: actions/upload-artifact@v4
        with:
          name: frontend-build
          include-hidden-files: true
          path: |
            apps/web/.next
            apps/web/public
            apps/web/package.json
            apps/web/staticwebapp.config.json

  # ===========================================================================
  # PHASE 2: SECURITY SCANNING
  # ===========================================================================
  # Runs after linting passes, before tests
  # Provides security feedback early in pipeline
  # Scans: bandit (code security), pip-audit (dependency vulnerabilities), deptry (dependency consistency)
  # ===========================================================================
  01-scan-python-security:
    name: Scan Python Security
    runs-on: ubuntu-latest
    needs: [00-01-lint-python]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python with uv
        uses: ./.github/actions/setup-python-env
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          install-mode: service
          service-package: services/api

      - name: Scan API security
        uses: ./.github/actions/scan-python-security
        with:
          service-path: services/api
          check-security: 'true'
          check-types: 'false'

      - name: Scan Workers security
        uses: ./.github/actions/scan-python-security
        with:
          service-path: services/workers
          check-security: 'true'
          check-types: 'false'

      - name: Validate API dependencies
        uses: ./.github/actions/validate-python-dependencies
        with:
          service-path: services/api
          check-missing: 'true'
          check-unused: 'false'
          check-security: 'true'
          fail-on-warnings: 'false'

      - name: Validate Workers dependencies
        uses: ./.github/actions/validate-python-dependencies
        with:
          service-path: services/workers
          check-missing: 'true'
          check-unused: 'false'
          check-security: 'true'
          fail-on-warnings: 'false'


  # ===========================================================================
  # PHASE 3: PYTHON UNIT TESTS (MATRIX)
  # ===========================================================================
  # All tests run in parallel for every PR/push
  # Dependencies: lint AND security must pass (fail-fast)
  #
  # Matrix runs all services in parallel:
  # - Shared: Base library tests
  # - API: FastAPI backend tests
  # - Workers: Background worker tests
  # ===========================================================================
  02-test-python:
    name: Test ${{ matrix.service.name }}
    runs-on: ubuntu-latest
    needs: [00-01-lint-python, 01-scan-python-security]
    strategy:
      fail-fast: false
      matrix:
        service:
          - name: Shared
            path: shared
            package: services/shared
            markers: ''
            pytest-args: ''
          - name: API
            path: api
            package: services/api
            markers: not integration and not live
            pytest-args: '-v --tb=short'
          - name: Workers
            path: workers
            package: services/workers
            markers: ''
            pytest-args: ''

    outputs:
      test_duration: ${{ steps.tests.outputs.test-duration }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run ${{ matrix.service.name }} tests
        id: tests
        uses: ./.github/actions/run-python-tests
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          service-package: ${{ matrix.service.package }}
          working-directory: ${{ matrix.service.package }}
          test-name: ${{ matrix.service.name }} Tests
          parallel: 'true'
          install-pytest-xdist: 'true'
          pytest-args: ${{ matrix.service.pytest-args }}
          markers: ${{ matrix.service.markers }}

  # ===========================================================================
  # PHASE 4: KUBERNETES VALIDATION
  # ===========================================================================
  # Validates:
  #   1. YAML syntax (all manifests)
  #   2. Kustomize builds (base + overlays)
  #   3. ArgoCD Application paths exist
  # Catches k8s config errors before they reach cluster
  #
  # Uses consolidated validate action for all checks
  # ===========================================================================
  03-kubernetes-validate:
    name: Kubernetes Validation
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Kustomize
        uses: ./.github/actions/setup-kustomize
        with:
          kustomize-version: '5.8.0'

      - name: Validate Kubernetes manifests
        uses: ./.github/actions/validate
        with:
          validators: yaml-syntax,kustomize-build,argocd-paths
          k8s-directory: k8s
          overlay-paths: k8s/overlays/preview,k8s/overlays/prod,k8s/overlays/prod-secretstore
          base-paths: k8s/base
          fail-fast: 'true'
          timeout-seconds: '90'

      - name: Validate Argo CD manifest syntax
        uses: ./.github/actions/validate
        with:
          validators: yaml-syntax
          k8s-directory: k8s/argocd
          fail-fast: 'true'
          timeout-seconds: '30'

      - name: Validate preview deployment manifests
        uses: ./.github/actions/deployment-validate
        with:
          overlay-path: k8s/overlays/preview
          target-namespace: preview-pr-test
          skip-image-validation: 'true'
          skip-secret-validation: 'true'
          max-cpu-millicores: '1500'
          max-memory-mi: '2560'


  # ===========================================================================
  # PHASE 5: IMAGE BUILDING
  # ===========================================================================
  # TWO-STAGE PROCESS:
  # 1. 04-build-images-meta: Generate image tag (pr-123-abc123f)
  # 2. 04-build-images: Build and push images with that tag
  #
  # FLOW (ACR configured):
  #   Lint → Security → Tests pass → build-images-meta generates tag → build-images builds + pushes
  #
  # Image Tags:
  # - PRs: pr-<number>-<sha> (e.g., pr-42-abc123f)
  # - Main: sha-<sha> (e.g., sha-abc123f)
  # ===========================================================================
  03-build-images-meta:
    name: Prepare Image Tag
    runs-on: ubuntu-latest
    if: vars.ACR_NAME != ''
    outputs:
      image_tag: ${{ steps.tag.outputs.image-tag }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Generate image tag
        id: tag
        uses: ./.github/actions/generate-image-tag
        with:
          pr-number: ${{ github.event.pull_request.number }}
          commit-sha: ${{ github.event.pull_request.head.sha || github.sha }}

      - name: Publish image tag artifact
        if: steps.tag.outputs.image-tag != ''
        uses: ./.github/actions/publish-image-tag
        with:
          image-tag: ${{ steps.tag.outputs.image-tag }}

      - name: Verify image-tag artifact is available
        if: steps.tag.outputs.image-tag != ''
        uses: actions/download-artifact@v4
        with:
          name: image-tag
          path: ./downloaded-artifacts

      - name: Assert downloaded image tag
        if: steps.tag.outputs.image-tag != ''
        uses: ./.github/actions/assert-image-tag-artifact

  03-build-images:
    name: Build Images (parallel)
    runs-on: ubuntu-latest
    needs: [04-build-images-meta, 00-01-lint-python, 01-scan-python-security]
    if: |
      needs.04-build-images-meta.result == 'success' &&
      vars.ACR_NAME != ''
    strategy:
      matrix:
        include:
          - service: api
            dockerfile: services/api/Dockerfile
            image: yt-summarizer-api
          - service: workers
            dockerfile: services/workers/Dockerfile
            image: yt-summarizer-workers
    permissions:
      id-token: write
      contents: read
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Login to Azure Container Registry
        uses: ./.github/actions/azure-acr-login
        with:
          azure-client-id: ${{ secrets.AZURE_CLIENT_ID }}
          azure-tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          azure-subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          acr-name: ${{ env.ACR_NAME }}

      - name: Build and push ${{ matrix.service }} image
        uses: ./.github/actions/build-images
        with:
          service: ${{ matrix.service }}
          image-tag: ${{ needs.04-build-images-meta.outputs.image_tag }}
          push: true

  # ===========================================================================
  # E2E TESTING - Runs in Preview Workflow
  # ===========================================================================
  # E2E tests run against live preview environments (preview.yml workflow)
  # Not run in CI because they require full deployed environment
  # Local testing: npm run e2e (with Aspire running)
  # ===========================================================================

  # ===========================================================================
  # PHASE 6: INFRASTRUCTURE VALIDATION
  # ===========================================================================
  # Terraform: Validates HCL syntax and plan
  # Note: Kustomize validation moved to Phase 4 (kubernetes-validate)
  # ===========================================================================
  04-validate-terraform:
    name: Validate Terraform
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Azure login (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "1.5"

      - name: Validate Terraform configuration
        uses: ./.github/actions/validate
        with:
          validators: terraform-config
          terraform-directory: infra/terraform/environments/prod
          fail-fast: 'true'
          timeout-seconds: '60'

  # ===========================================================================
  # PHASE 7: SECRET SCANNING
  # ===========================================================================
  # Runs gitleaks to detect secrets in code
  # ===========================================================================
  05-secret-scanning:
    name: Secret Scanning
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run Gitleaks
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITLEAKS_LICENSE: ${{ secrets.GITLEAKS_LICENSE }}

  # ===========================================================================
  # PHASE 8: WORKFLOW VALIDATION
  # ===========================================================================
  # Validates GitHub Actions workflow syntax and linting
  # ===========================================================================
  06-validate-workflows:
    name: Validate Workflows
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate SWA configuration
        uses: ./.github/actions/validate
        with:
          validators: swa-config
          swa-workflow-files: '.github/workflows/deploy-prod.yml,.github/workflows/swa-baseline-deploy.yml'
          swa-app-dir: 'apps/web'
          fail-fast: 'true'
          timeout-seconds: '30'

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Cache pip and pre-commit
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/pip
            ~/.cache/pre-commit
          key: ${{ runner.os }}-workflow-py-${{ hashFiles('.pre-commit-config.yaml') }}
          restore-keys: |
            ${{ runner.os }}-workflow-py-

      - name: Run actionlint
        uses: reviewdog/action-actionlint@v1
        continue-on-error: true
        with:
          fail_level: none
          filter_mode: nofilter

      - name: Install pre-commit
        run: pip install pre-commit

      - name: Run pre-commit on workflow files
        run: scripts/workflows/ci-run-precommit-workflows.sh

  # ===========================================================================
  # PHASE 9: FINAL STATUS CHECK
  # ===========================================================================

  # always() ensures this runs regardless of job results
  # Validates that:
  #   1. All jobs ran
  #   2. All jobs that ran passed (result == 'success')
  # ===========================================================================
  07-ci-status:
    name: CI Status
    runs-on: ubuntu-latest
    needs:
      - 00-01-lint-python
      - 01-scan-python-security
      - 00-frontend-quality
      - 06-secret-scanning
      - 02-test-python
      - 03-kubernetes-validate
      - 05-validate-terraform
      - 04-build-images
      - 04-build-images-meta
      - 07-validate-workflows

    if: always()
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Write execution rationale
        run: |
          {
            echo "## CI Execution Rationale"
            echo ""
            echo "- Mode: Full validation (all jobs always run)"
            echo "- Lint Python: ${{ needs.00-01-lint-python.result }}"
            echo "- Frontend Quality: ${{ needs.00-frontend-quality.result }}"
            echo "- Security Scans (Python): ${{ needs.01-scan-python-security.result }}"
            echo "- Tests (Python Matrix): ${{ needs.02-test-python.result }}"
            echo "- Build Images: ${{ needs.04-build-images.result }}"
            echo "  ACR: ${{ vars.ACR_NAME != '' && 'configured' || 'not configured' }}"
            echo "- Terraform Validate: ${{ needs.05-validate-terraform.result }}"
            echo "- K8s Validate: ${{ needs.03-kubernetes-validate.result }}"
            echo "- Secret Scanning: ${{ needs.06-secret-scanning.result }}"
            echo "- Workflow Validation: ${{ needs.07-validate-workflows.result }}"
          } >> "$GITHUB_STEP_SUMMARY"

      - name: Create CI Summary
        uses: ./.github/actions/create-pipeline-summary
        with:
          summary-type: ci
          changed-areas: ''
          commit-sha: ${{ github.event.pull_request.head.sha || github.sha }}
          pr-number: ${{ github.event.pull_request.number }}
          lint-python-result: ${{ needs.00-01-lint-python.result }}
          scan-python-security-result: ${{ needs.01-scan-python-security.result }}
          frontend-quality-result: ${{ needs.00-frontend-quality.result }}
          secret-scanning-result: ${{ needs.06-secret-scanning.result }}
          test-shared-result: ${{ needs.02-test-python.result }}
          test-shared-duration: ${{ needs.02-test-python.outputs.test_duration }}
          test-api-result: ${{ needs.02-test-python.result }}
          test-api-duration: ''
          test-workers-result: ${{ needs.02-test-python.result }}
          test-workers-duration: ''
          kubernetes-validate-result: ${{ needs.03-kubernetes-validate.result }}
          validate-terraform-result: ${{ needs.05-validate-terraform.result }}
          build-images-result: ${{ needs.04-build-images.result }}
          image-tag: ${{ needs.04-build-images-meta.outputs.image_tag }}
          repository: ${{ github.repository }}
          run-id: ${{ github.run_id }}


      - name: Check all jobs passed
        uses: ./.github/actions/validate-ci-results
        with:
          changed-areas: ''
          is-main-branch: 'false'
          test-shared-result: ${{ needs.02-test-python.result }}
          test-api-result: ${{ needs.02-test-python.result }}
          test-workers-result: ${{ needs.02-test-python.result }}
          frontend-quality-result: ${{ needs.00-frontend-quality.result }}
          validate-terraform-result: ${{ needs.05-validate-terraform.result }}
          kubernetes-validate-result: ${{ needs.03-kubernetes-validate.result }}
          secret-scanning-result: ${{ needs.06-secret-scanning.result }}
          secret-scanning-should-run: 'true'
          build-images-result: ${{ needs.04-build-images.result }}
          acr-configured: ${{ vars.ACR_NAME != '' }}
