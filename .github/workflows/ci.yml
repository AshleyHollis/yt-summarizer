# =============================================================================
# CI Workflow - Automated Testing and Image Building
# =============================================================================
# TRIGGERS: PR opened/updated, push to main, manual dispatch
#
# EXECUTION FLOWS:
#
# MAIN BRANCH (push to main):
#   â†’ ALWAYS runs FULL validation (all tests, all checks, all builds)
#   â†’ Purpose: Ensure merged code is always in a validated state
#   â†’ No conditional skipping based on changes
#
# PR BRANCHES (pull_request):
#   1. Code Changes â†’ Lint â†’ Test â†’ Build Images (if ACR configured)
#   2. K8s Only Changes â†’ Validate manifests (no images built)
#   3. Docs/CI Changes â†’ Validate YAML/workflows (no tests or builds)
#   4. Smart skipping: Only run jobs for changed areas
#
# BUILD MODES:
#   - ACR configured â†’ Build and push images to Azure Container Registry
#   - No ACR â†’ Validate builds locally without push
#
# KEY PATTERN - always() for conditional dependencies:
#   Jobs with always() run even when dependencies skip/fail
#   Used when job needs to evaluate complex conditions based on multiple dependency results
#   Downstream jobs depending on always() jobs must also use always() + check result
#
# EXTRACTED SCRIPTS:
#   - scripts/workflows/ci-check-branch.sh: Detect if main branch or PR
#   - scripts/workflows/ci-detect-changes.sh: Detect what areas changed
#   - scripts/workflows/ci-write-rationale.sh: Write job execution summary
#
# For details on adding new workflow scripts, see: REFACTORING.md
# =============================================================================

name: CI

on:
  pull_request:
    branches: [main]
    types: [opened, synchronize, reopened]
  push:
    branches: [main]
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  PYTHON_VERSION: "3.11"
  NODE_VERSION: "20"
  ACR_NAME: ${{ vars.ACR_NAME || 'acrytsummprd' }}
  ACR_LOGIN_SERVER: ${{ vars.ACR_LOGIN_SERVER || 'acrytsummprd.azurecr.io' }}

defaults:
  run:
    shell: bash -e {0}  # Exit immediately if any command fails

jobs:
  # ===========================================================================
  # PHASE 1: CHANGE DETECTION
  # ===========================================================================
  # Analyzes diff to determine what changed, enabling smart job execution
  #
  # MAIN BRANCH: Always outputs ALL areas (forces full validation)
  # PR BRANCHES: Outputs only changed areas (smart skipping)
  #
  # Outputs:
  #   - changed_areas: Space-separated list (e.g., "services/api k8s")
  #   - has_code_changes: Boolean for security scanning
  #   - is_main_branch: Boolean to indicate main branch (full validation mode)
  #
  # Used by all subsequent jobs to decide if they should run
  # ===========================================================================
  detect-changes:
      name: Detect Changes
      runs-on: ubuntu-latest
      outputs:
        changed_areas: ${{ steps.changes.outputs.changed_areas }}
        has_code_changes: ${{ steps.changes.outputs.has_code_changes }}
        is_main_branch: ${{ steps.check-branch.outputs.is_main_branch }}
      steps:
        - name: Checkout code
          uses: actions/checkout@v4
          with:
            fetch-depth: 0

        - name: Check if main branch
          id: check-branch
          shell: bash
          env:
            GITHUB_REF: ${{ github.ref }}
            GITHUB_REF_NAME: ${{ github.ref_name }}
            GITHUB_EVENT_NAME: ${{ github.event_name }}
          run: scripts/workflows/ci-check-branch.sh

        - name: Detect changes
          id: changes
          shell: bash
          env:
            IS_MAIN_BRANCH: ${{ steps.check-branch.outputs.is_main_branch }}
          run: scripts/workflows/ci-detect-changes.sh

  # ===========================================================================
  # PHASE 2: LINTING
  # ===========================================================================
  # Runs only when relevant code areas change
  # Python: services/api, services/workers, services/shared
  # Frontend: apps/web
  # Blocks tests if lint fails (fail-fast pattern)
  # ===========================================================================
  lint-python:
    name: Lint Python
    runs-on: ubuntu-latest
    needs: [detect-changes]
    # Main branch: Always run | PR: Run if Python services changed
    if: |
      needs.detect-changes.outputs.is_main_branch == 'true' ||
      contains(needs.detect-changes.outputs.changed_areas, 'services/api') ||
      contains(needs.detect-changes.outputs.changed_areas, 'services/workers') ||
      contains(needs.detect-changes.outputs.changed_areas, 'services/shared')
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: ./.github/actions/setup-python
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          working-directory: services/shared

      - name: Run ruff checks
        uses: ./.github/actions/run-ruff-check

  lint-frontend:
    name: Lint Frontend
    runs-on: ubuntu-latest
    needs: [detect-changes]
    # Main branch: Always run | PR: Run if frontend changed
    if: |
      needs.detect-changes.outputs.is_main_branch == 'true' ||
      contains(needs.detect-changes.outputs.changed_areas, 'apps/web')
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: ./.github/actions/setup-node
        with:
          node-version: ${{ env.NODE_VERSION }}
          working-directory: apps/web

      - name: Run ESLint
        working-directory: apps/web
        run: npm run lint

      - name: Validate required frontend files exist
        working-directory: apps/web
        run: |
          echo "ðŸ” Checking for critical frontend files..."

          # Check for commonly missing files that cause build failures
          missing_files=()

          # Check for lib directory files (common gitignore issue)
          if [ ! -f "src/lib/auth-utils.ts" ]; then
            missing_files+=("src/lib/auth-utils.ts")
          fi

          # Check for other critical files
          critical_files=(
            "src/lib/logger.ts"
            "src/services/api.ts"
            "src/types/index.ts"
          )

          for file in "${critical_files[@]}"; do
            if [ -f "$file" ]; then
              echo "âœ“ $file exists"
            else
              echo "âš ï¸  Warning: $file not found (may be optional)"
            fi
          done

          if [ ${#missing_files[@]} -gt 0 ]; then
            echo "âŒ ERROR: Missing critical files:"
            printf '  - %s\n' "${missing_files[@]}"
            echo ""
            echo "This is often caused by .gitignore patterns ignoring source code."
            echo "Check .gitignore for overly broad patterns like 'lib/' instead of '/lib/'"
            exit 1
          fi

          echo "âœ… All critical files present"

  # ===========================================================================
  # PHASE 3: SECURITY SCANNING
  # ===========================================================================
  # Runs after linting passes, before tests
  # Provides security feedback early in pipeline
  # Scans: bandit (code security), pip-audit (dependency vulnerabilities), deptry (dependency consistency)
  # ===========================================================================
  scan-python-security:
    name: Scan Python Security
    runs-on: ubuntu-latest
    needs: [detect-changes, lint-python]
    # Main branch: Always run | PR: Run if Python services changed
    # Requires lint-python to pass (or skip if not needed)
    if: |
      (needs.detect-changes.outputs.is_main_branch == 'true' ||
       contains(needs.detect-changes.outputs.changed_areas, 'services/api') ||
       contains(needs.detect-changes.outputs.changed_areas, 'services/workers') ||
       contains(needs.detect-changes.outputs.changed_areas, 'services/shared')) &&
      (needs.lint-python.result == 'success' || needs.lint-python.result == 'skipped')
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python with uv
        uses: ./.github/actions/setup-python-uv
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          service-package: services/api

      - name: Scan API security
        if: contains(needs.detect-changes.outputs.changed_areas, 'services/api')
        uses: ./.github/actions/scan-python-security
        with:
          service-path: services/api
          check-security: 'true'
          check-types: 'false'

      - name: Scan Workers security
        if: contains(needs.detect-changes.outputs.changed_areas, 'services/workers')
        uses: ./.github/actions/scan-python-security
        with:
          service-path: services/workers
          check-security: 'true'
          check-types: 'false'

      - name: Validate API dependencies
        if: contains(needs.detect-changes.outputs.changed_areas, 'services/api')
        uses: ./.github/actions/validate-python-dependencies
        with:
          service-path: services/api
          check-missing: 'true'
          check-unused: 'false'
          check-security: 'true'
          fail-on-warnings: 'false'

      - name: Validate Workers dependencies
        if: contains(needs.detect-changes.outputs.changed_areas, 'services/workers')
        uses: ./.github/actions/validate-python-dependencies
        with:
          service-path: services/workers
          check-missing: 'true'
          check-unused: 'false'
          check-security: 'true'
          fail-on-warnings: 'false'

  scan-javascript-security:
    name: Scan JavaScript Security
    runs-on: ubuntu-latest
    needs: [detect-changes, lint-frontend]
    # Main branch: Always run | PR: Run if frontend changed
    # Requires lint-frontend to pass (or skip if not needed)
    if: |
      (needs.detect-changes.outputs.is_main_branch == 'true' ||
       contains(needs.detect-changes.outputs.changed_areas, 'apps/web')) &&
      (needs.lint-frontend.result == 'success' || needs.lint-frontend.result == 'skipped')
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: ./.github/actions/setup-node
        with:
          node-version: ${{ env.NODE_VERSION }}
          working-directory: apps/web

      - name: Scan JavaScript dependencies
        uses: ./.github/actions/scan-javascript-dependencies
        with:
          working-directory: apps/web
          check-missing-deps: 'true'
          check-security: 'true'
          audit-level: 'high'

  # ===========================================================================
  # PHASE 4: TESTING
  # ===========================================================================
  # Runs only when relevant code changes
  # Dependencies: lint AND security must pass (fail-fast)
  #
  # Test Execution Rules:
  # - test-shared: runs if services/shared changed
  # - test-api: runs if services/api OR services/shared changed
  # - test-workers: runs if services/workers OR services/shared changed
  # - test-frontend: runs if apps/web changed
  #
  # Shared changes trigger API + Workers tests (they depend on shared code)
  # ===========================================================================
  test-shared:
    name: Test Shared Package
    runs-on: ubuntu-latest
    needs: [detect-changes, lint-python, scan-python-security]
    # Main branch: Always run | PR: Run if shared package changed
    # Requires lint and security scans to pass
    if: |
      (needs.detect-changes.outputs.is_main_branch == 'true' ||
       contains(needs.detect-changes.outputs.changed_areas, 'services/shared')) &&
      (needs.lint-python.result == 'success' || needs.lint-python.result == 'skipped') &&
      (needs.scan-python-security.result == 'success' || needs.scan-python-security.result == 'skipped')
    outputs:
      test_duration: ${{ steps.finish.outputs.test_duration }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: ./.github/actions/setup-python
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          working-directory: services/shared

      - name: Record tests start
        id: start
        uses: ./.github/actions/record-test-duration
        with:
          test-name: Shared Tests

      - name: Run shared tests
        uses: ./.github/actions/run-pytest
        with:
          working-directory: services/shared

      - name: Record tests finish
        id: finish
        uses: ./.github/actions/record-test-duration
        with:
          start-time: ${{ steps.start.outputs.started_at }}
          test-name: Shared Tests

  test-api:
    name: Test API
    runs-on: ubuntu-latest
    needs: [detect-changes, lint-python, scan-python-security]
    # Main branch: Always run | PR: Run if API or shared changed
    # Note: Shared changes trigger API tests (dependency)
    # Requires lint and security scans to pass
    if: |
      (needs.detect-changes.outputs.is_main_branch == 'true' ||
       contains(needs.detect-changes.outputs.changed_areas, 'services/api') ||
       contains(needs.detect-changes.outputs.changed_areas, 'services/shared')) &&
      (needs.lint-python.result == 'success' || needs.lint-python.result == 'skipped') &&
      (needs.scan-python-security.result == 'success' || needs.scan-python-security.result == 'skipped')
    outputs:
      test_duration: ${{ steps.finish.outputs.test_duration }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python with uv
        uses: ./.github/actions/setup-python-uv
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          service-package: services/api
          install-pytest-xdist: 'true'

      - name: Record tests start
        id: start
        uses: ./.github/actions/record-test-duration
        with:
          test-name: API Tests

      - name: Run API tests
        uses: ./.github/actions/run-pytest
        with:
          working-directory: services/api
          parallel: 'false'
          pytest-args: '-v --tb=short'
          markers: 'not integration and not live'

      - name: Record tests finish
        id: finish
        uses: ./.github/actions/record-test-duration
        with:
          start-time: ${{ steps.start.outputs.started_at }}
          test-name: API Tests

  test-workers:
    name: Test Workers
    runs-on: ubuntu-latest
    needs: [detect-changes, lint-python, scan-python-security]
    # Main branch: Always run | PR: Run if workers or shared changed
    # Note: Shared changes trigger workers tests (dependency)
    # Requires lint and security scans to pass
    if: |
      (needs.detect-changes.outputs.is_main_branch == 'true' ||
       contains(needs.detect-changes.outputs.changed_areas, 'services/workers') ||
       contains(needs.detect-changes.outputs.changed_areas, 'services/shared')) &&
      (needs.lint-python.result == 'success' || needs.lint-python.result == 'skipped') &&
      (needs.scan-python-security.result == 'success' || needs.scan-python-security.result == 'skipped')
    outputs:
      test_duration: ${{ steps.finish.outputs.test_duration }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python with uv
        uses: ./.github/actions/setup-python-uv
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          service-package: services/workers
          install-pytest-xdist: 'true'

      - name: Record tests start
        id: start
        uses: ./.github/actions/record-test-duration
        with:
          test-name: Workers Tests

      - name: Run workers tests (parallel)
        uses: ./.github/actions/run-pytest
        with:
          working-directory: services/workers
          parallel: 'true'

      - name: Record tests finish
        id: finish
        uses: ./.github/actions/record-test-duration
        with:
          start-time: ${{ steps.start.outputs.started_at }}
          test-name: Workers Tests

  test-frontend:
    name: Test Frontend
    runs-on: ubuntu-latest
    needs: [detect-changes, lint-frontend, scan-javascript-security]
    # Main branch: Always run | PR: Run if frontend changed
    # Requires lint and security scans to pass
    if: |
      (needs.detect-changes.outputs.is_main_branch == 'true' ||
       contains(needs.detect-changes.outputs.changed_areas, 'apps/web')) &&
      (needs.lint-frontend.result == 'success' || needs.lint-frontend.result == 'skipped') &&
      (needs.scan-javascript-security.result == 'success' || needs.scan-javascript-security.result == 'skipped')
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: ./.github/actions/setup-node
        with:
          node-version: ${{ env.NODE_VERSION }}
          working-directory: apps/web

      - name: Run Vitest
        uses: ./.github/actions/run-frontend-tests

  # ===========================================================================
  # PHASE 5: KUBERNETES VALIDATION
  # ===========================================================================
  # Runs only when k8s/ directory changes
  # Validates:
  #   1. YAML syntax (all manifests)
  #   2. Kustomize builds (base + overlays)
  #   3. ArgoCD Application paths exist
  # Catches k8s config errors before they reach cluster
  #
  # Uses consolidated validate action for all checks
  # ===========================================================================
  kubernetes-validate:
    name: Kubernetes Validation
    runs-on: ubuntu-latest
    needs: [detect-changes]
    # Main branch: Always run | PR: Run if k8s changed
    if: |
      needs.detect-changes.outputs.is_main_branch == 'true' ||
      contains(needs.detect-changes.outputs.changed_areas, 'k8s')
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Kustomize
        uses: ./.github/actions/setup-kustomize
        with:
          kustomize-version: '5.8.0'

      - name: Validate Kubernetes manifests
        uses: ./.github/actions/validate
        with:
          validators: yaml-syntax,kustomize-build,argocd-paths
          k8s-directory: k8s
          overlay-paths: k8s/overlays/preview,k8s/overlays/prod,k8s/overlays/prod-secretstore
          base-paths: k8s/base
          fail-fast: 'true'
          timeout-seconds: '90'

      - name: Validate Argo CD manifest syntax
        if: contains(needs.detect-changes.outputs.changed_areas, 'k8s/argocd')
        shell: bash
        run: |
          echo "Validating Argo CD manifest files..."

          # Validate YAML syntax
          for file in k8s/argocd/*.yaml; do
            if [[ -f "$file" ]]; then
              echo "Checking $file..."
              if ! yq eval '.' "$file" > /dev/null 2>&1; then
                echo "::error::Invalid YAML syntax in $file"
                exit 1
              fi

              # Check for Application/ApplicationSet kind
              kind=$(yq eval '.kind' "$file" 2>/dev/null || echo "")
              if [[ -n "$kind" ]] && [[ "$kind" != "Application" ]] && [[ "$kind" != "ApplicationSet" ]]; then
                echo "::warning::Unexpected kind '$kind' in $file (expected Application or ApplicationSet)"
              fi

              echo "  âœ“ $file is valid"
            fi
          done

          echo ""
          echo "All Argo CD manifests passed validation!"


  # ===========================================================================
  # PHASE 6: IMAGE BUILDING (Conditional)
  # ===========================================================================
  # WHEN: Only when code requiring images changes (services/, apps/web, docker/)
  # WHY: Avoid rebuilding images for k8s manifest or docs changes
  #
  # TWO-STAGE PROCESS:
  # 1. build-images-meta: Generate image tag (pr-123-abc123f)
  # 2. build-images: Build and push images with that tag
  #
  # CRITICAL always() PATTERN:
  # - build-images-meta uses always() to run when lint/security/test jobs skip
  # - build-images MUST also use always() + check meta result == 'success'
  # - Without this, build-images skips even when meta succeeds
  #
  # FLOW 1 (ACR configured):
  #   Lint â†’ Security â†’ Tests pass â†’ build-images-meta generates tag â†’ build-images builds + pushes
  # FLOW 2 (No ACR):
  #   Lint â†’ Security â†’ Tests pass â†’ build-images-validate builds without pushing (validation only)
  #
  # Image Tags:
  # - PRs: pr-<number>-<sha> (e.g., pr-42-abc123f)
  # - Main: sha-<sha> (e.g., sha-abc123f)
  # ===========================================================================
  build-images-meta:
    name: Prepare Image Tag
    runs-on: ubuntu-latest
    needs: [detect-changes, lint-python, lint-frontend, scan-python-security, scan-javascript-security, test-shared, test-api, test-workers, test-frontend]
    # IMAGE BUILDING CONDITIONS:
    # - ACR must be configured (vars.ACR_NAME != '')
    # - Main branch: Always build images after tests pass
    # - PR branch: Build only if code/docker areas changed
    # - All lint, security scans, and tests must pass (or skip if not run)
    # - always(): Run even if some dependencies were skipped, then check their results
    if: |
      always() &&
      vars.ACR_NAME != '' &&
      (needs.detect-changes.outputs.is_main_branch == 'true' ||
       contains(needs.detect-changes.outputs.changed_areas, 'services/api') ||
       contains(needs.detect-changes.outputs.changed_areas, 'services/workers') ||
       contains(needs.detect-changes.outputs.changed_areas, 'services/shared') ||
       contains(needs.detect-changes.outputs.changed_areas, 'apps/web') ||
       contains(needs.detect-changes.outputs.changed_areas, 'docker')) &&
      (needs.lint-python.result == 'success' || needs.lint-python.result == 'skipped') &&
      (needs.lint-frontend.result == 'success' || needs.lint-frontend.result == 'skipped') &&
      (needs.scan-python-security.result == 'success' || needs.scan-python-security.result == 'skipped') &&
      (needs.scan-javascript-security.result == 'success' || needs.scan-javascript-security.result == 'skipped') &&
      (needs.test-shared.result == 'success' || needs.test-shared.result == 'skipped') &&
      (needs.test-api.result == 'success' || needs.test-api.result == 'skipped') &&
      (needs.test-workers.result == 'success' || needs.test-workers.result == 'skipped') &&
      (needs.test-frontend.result == 'success' || needs.test-frontend.result == 'skipped')
    outputs:
      image_tag: ${{ steps.tag.outputs.image-tag }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Generate image tag
        id: tag
        uses: ./.github/actions/generate-image-tag
        with:
          pr-number: ${{ github.event.pull_request.number }}
          commit-sha: ${{ github.event.pull_request.head.sha || github.sha }}

      - name: Publish image tag artifact
        if: steps.tag.outputs.image-tag != ''
        uses: ./.github/actions/publish-image-tag
        with:
          image-tag: ${{ steps.tag.outputs.image-tag }}

      - name: Verify image-tag artifact is available
        if: steps.tag.outputs.image-tag != ''
        uses: actions/download-artifact@v4
        with:
          name: image-tag
          path: ./downloaded-artifacts

      - name: Assert downloaded image tag
        if: steps.tag.outputs.image-tag != ''
        uses: ./.github/actions/assert-image-tag-artifact

  build-images:
    name: Build Images (parallel)
    runs-on: ubuntu-latest
    needs: [detect-changes, build-images-meta]
    # CRITICAL always() dependency:
    # - build-images-meta uses always() so it runs when some tests skip
    # - This job MUST use always() + check meta result, or it will skip
    # - GitHub Actions won't run jobs depending on always() jobs unless they also use always()
    #
    # IMAGE BUILDING:
    # - Main branch: Always build after meta succeeds
    # - PR branch: Build only if code/docker areas changed
    if: |
      always() &&
      needs.build-images-meta.result == 'success' &&
      vars.ACR_NAME != '' &&
      (needs.detect-changes.outputs.is_main_branch == 'true' ||
       contains(needs.detect-changes.outputs.changed_areas, 'services/api') ||
       contains(needs.detect-changes.outputs.changed_areas, 'services/workers') ||
       contains(needs.detect-changes.outputs.changed_areas, 'services/shared') ||
       contains(needs.detect-changes.outputs.changed_areas, 'apps/web') ||
       contains(needs.detect-changes.outputs.changed_areas, 'docker'))
    strategy:
      matrix:
        include:
          - service: api
            dockerfile: services/api/Dockerfile
            image: yt-summarizer-api
          - service: workers
            dockerfile: services/workers/Dockerfile
            image: yt-summarizer-workers
    permissions:
      id-token: write
      contents: read
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Login to Azure Container Registry
        uses: ./.github/actions/azure-acr-login
        with:
          azure-client-id: ${{ secrets.AZURE_CLIENT_ID }}
          azure-tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          azure-subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          acr-name: ${{ env.ACR_NAME }}

      - name: Build and push ${{ matrix.service }} image
        uses: ./.github/actions/build-images
        with:
          service: ${{ matrix.service }}
          image-tag: ${{ needs.build-images-meta.outputs.image_tag }}
          push: true


  # ---------------------------------------------------------------------------
  # BUILD VALIDATION (No ACR)
  # ---------------------------------------------------------------------------
  # FLOW: No ACR configured â†’ Build images locally without pushing
  # PURPOSE: Validate Dockerfiles work without requiring Azure credentials
  # WHEN: ACR_NAME is empty AND code changes require images
  # ---------------------------------------------------------------------------
  build-images-validate:
    name: Build Images (Validate - parallel)
    runs-on: ubuntu-latest
    needs: [detect-changes, lint-python, lint-frontend]
    # Only run if ACR is NOT configured (validation mode)
    # Main branch: Always validate | PR: Validate if code/docker changed
    if: |
      vars.ACR_NAME == '' &&
      (needs.detect-changes.outputs.is_main_branch == 'true' ||
       contains(needs.detect-changes.outputs.changed_areas, 'services/api') ||
       contains(needs.detect-changes.outputs.changed_areas, 'services/workers') ||
       contains(needs.detect-changes.outputs.changed_areas, 'services/shared') ||
       contains(needs.detect-changes.outputs.changed_areas, 'apps/web') ||
       contains(needs.detect-changes.outputs.changed_areas, 'docker'))
    strategy:
      matrix:
        include:
          - service: api
            dockerfile: services/api/Dockerfile
            image: yt-summarizer-api
          - service: workers
            dockerfile: services/workers/Dockerfile
            image: yt-summarizer-workers
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Build ${{ matrix.service }} image (no push)
        uses: ./.github/actions/build-images
        with:
          service: ${{ matrix.service }}
          image-tag: validate
          push: false

  # ===========================================================================
  # E2E TESTING - Runs in Preview Workflow
  # ===========================================================================
  # E2E tests run against live preview environments (preview.yml workflow)
  # Not run in CI because they require full deployed environment
  # Local testing: npm run e2e (with Aspire running)
  # ===========================================================================

  # ===========================================================================
  # PHASE 6: INFRASTRUCTURE VALIDATION
  # ===========================================================================
  # Terraform: Validates HCL syntax and plan (when infra/terraform/ changes)
  # Note: Kustomize validation moved to Phase 5 (kubernetes-validate)
  # ===========================================================================
  validate-terraform:
    name: Validate Terraform
    runs-on: ubuntu-latest
    needs: [detect-changes]
    permissions:
      id-token: write
      contents: read
    # Main branch: Always run | PR: Run if terraform changed
    if: |
      needs.detect-changes.outputs.is_main_branch == 'true' ||
      contains(needs.detect-changes.outputs.changed_areas, 'infra/terraform')
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Azure login (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "1.5"

      - name: Validate Terraform configuration
        uses: ./.github/actions/validate
        with:
          validators: terraform-config
          terraform-directory: infra/terraform/environments/prod
          fail-fast: 'true'
          timeout-seconds: '60'

  # ===========================================================================
  # PHASE 7: SECRET SCANNING
  # ===========================================================================
  # Runs gitleaks to detect secrets in code
  # Only runs when has_code_changes == true (skips for pure k8s/docs changes)
  # ===========================================================================
  secret-scanning:
    name: Secret Scanning
    runs-on: ubuntu-latest
    needs: [detect-changes]
    # Main branch: Always run | PR: Run if code changed (not just docs)
    if: |
      needs.detect-changes.outputs.is_main_branch == 'true' ||
      needs.detect-changes.outputs.has_code_changes == 'true'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run Gitleaks
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITLEAKS_LICENSE: ${{ secrets.GITLEAKS_LICENSE }}

  # ===========================================================================
  # PHASE 8: WORKFLOW VALIDATION
  # ===========================================================================
  # Validates GitHub Actions workflow syntax and linting
  # Runs when workflow/CI files change (or always on main)
  # ===========================================================================
  validate-workflows:
    name: Validate Workflows
    runs-on: ubuntu-latest
    needs: [detect-changes]
    if: |
      needs.detect-changes.outputs.is_main_branch == 'true' ||
      contains(needs.detect-changes.outputs.changed_areas, 'ci')
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install PyYAML
        run: pip install pyyaml

      - name: Validate workflow YAML syntax
        run: python scripts/validate_workflows.py

      - name: Run actionlint
        uses: reviewdog/action-actionlint@v1
        continue-on-error: true
        with:
          fail_level: none
          filter_mode: nofilter

      - name: Install pre-commit
        run: pip install pre-commit

      - name: Run pre-commit on workflow files
        run: scripts/workflows/ci-run-precommit-workflows.sh

  # ===========================================================================
  # PHASE 9: FINAL STATUS CHECK
  # ===========================================================================

  # always() ensures this runs regardless of job results
  # Validates that:
  #   1. Required jobs ran (based on changed_areas)
  #   2. All jobs that ran passed (result == 'success')
  #   3. Jobs that should skip did skip (result == 'skipped')
  #
  # Replicates job conditions to ensure pipeline executed correctly
  # Fails if expected jobs didn't run or ran when they shouldn't
  # ===========================================================================
  ci-status:
    name: CI Status
    runs-on: ubuntu-latest
    needs:
      - detect-changes
      - lint-python
      - lint-frontend
      - scan-python-security
      - scan-javascript-security
      - test-shared
      - test-api
      - test-workers
      - test-frontend
      - build-images
      - build-images-meta
      - build-images-validate
      - validate-terraform
      - kubernetes-validate
      - secret-scanning
      - validate-workflows

    if: always()
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Write execution rationale
        run: |
          {
            echo "## CI Execution Rationale"
            echo ""
            echo "- Mode: ${{ needs.detect-changes.outputs.is_main_branch == 'true' && 'main branch (full validation)' || 'PR (change-based)' }}"
            echo "- Changed areas: ${{ needs.detect-changes.outputs.changed_areas }}"
            echo "- Lint Python: ${{ needs.lint-python.result }} (reason: ${{ needs.detect-changes.outputs.is_main_branch == 'true' && 'main branch' || (contains(needs.detect-changes.outputs.changed_areas, 'services/api') || contains(needs.detect-changes.outputs.changed_areas, 'services/workers') || contains(needs.detect-changes.outputs.changed_areas, 'services/shared')) && 'python changes' || 'no python changes' }})"
            echo "- Lint Frontend: ${{ needs.lint-frontend.result }} (reason: ${{ needs.detect-changes.outputs.is_main_branch == 'true' && 'main branch' || contains(needs.detect-changes.outputs.changed_areas, 'apps/web') && 'frontend changes' || 'no frontend changes' }})"
            echo "- Security Scans (Python/JS): ${{ needs.scan-python-security.result }}/${{ needs.scan-javascript-security.result }}"
            echo "- Tests (shared/api/workers/frontend): ${{ needs.test-shared.result }}/${{ needs.test-api.result }}/${{ needs.test-workers.result }}/${{ needs.test-frontend.result }}"
            echo "- Build Images: ${{ needs.build-images.result }} (ACR: ${{ vars.ACR_NAME != '' && 'configured' || 'not configured' }})"
            echo "- Build Images (validate): ${{ needs.build-images-validate.result }}"
            echo "- Terraform Validate: ${{ needs.validate-terraform.result }}"
            echo "- K8s Validate: ${{ needs.kubernetes-validate.result }}"
            echo "- Secret Scanning: ${{ needs.secret-scanning.result }}"
            echo "- Workflow Validation: ${{ needs.validate-workflows.result }} (reason: ${{ needs.detect-changes.outputs.is_main_branch == 'true' && 'main branch' || contains(needs.detect-changes.outputs.changed_areas, 'ci') && 'ci/workflow changes' || 'no ci changes' }})"
          } >> "$GITHUB_STEP_SUMMARY"

      - name: Create CI Summary
        uses: ./.github/actions/create-ci-summary
        with:
          changed-areas: ${{ needs.detect-changes.outputs.changed_areas }}
          commit-sha: ${{ github.event.pull_request.head.sha || github.sha }}
          pr-number: ${{ github.event.pull_request.number }}
          lint-python-result: ${{ needs.lint-python.result }}
          lint-frontend-result: ${{ needs.lint-frontend.result }}
          scan-python-security-result: ${{ needs.scan-python-security.result }}
          scan-javascript-security-result: ${{ needs.scan-javascript-security.result }}
          secret-scanning-result: ${{ needs.secret-scanning.result }}
          test-shared-result: ${{ needs.test-shared.result }}
          test-shared-duration: ${{ needs.test-shared.outputs.test_duration }}
          test-api-result: ${{ needs.test-api.result }}
          test-api-duration: ${{ needs.test-api.outputs.test_duration }}
          test-workers-result: ${{ needs.test-workers.result }}
          test-workers-duration: ${{ needs.test-workers.outputs.test_duration }}
          test-frontend-result: ${{ needs.test-frontend.result }}
          kubernetes-validate-result: ${{ needs.kubernetes-validate.result }}
          validate-terraform-result: ${{ needs.validate-terraform.result }}
          build-images-result: ${{ needs.build-images.result }}
          image-tag: ${{ needs.build-images-meta.outputs.image_tag }}
          repository: ${{ github.repository }}
          run-id: ${{ github.run_id }}


      - name: Check all jobs passed
        uses: ./.github/actions/validate-ci-results
        with:
          changed-areas: ${{ needs.detect-changes.outputs.changed_areas }}
          is-main-branch: ${{ needs.detect-changes.outputs.is_main_branch }}
          test-shared-result: ${{ needs.test-shared.result }}
          test-api-result: ${{ needs.test-api.result }}
          test-workers-result: ${{ needs.test-workers.result }}
          test-frontend-result: ${{ needs.test-frontend.result }}
          validate-terraform-result: ${{ needs.validate-terraform.result }}
          kubernetes-validate-result: ${{ needs.kubernetes-validate.result }}
          secret-scanning-result: ${{ needs.secret-scanning.result }}
          secret-scanning-should-run: ${{ needs.detect-changes.outputs.has_code_changes }}
          build-images-result: ${{ needs.build-images.result }}
          build-images-validate-result: ${{ needs.build-images-validate.result }}
          acr-configured: ${{ vars.ACR_NAME != '' }}
