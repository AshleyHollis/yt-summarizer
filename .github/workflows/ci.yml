# =============================================================================
# CI Workflow - Automated Testing and Image Building
# =============================================================================
# TRIGGERS: PR opened/updated, push to main, manual dispatch
#
# EXECUTION FLOWS:
# 1. Code Changes → Lint → Test → Build Images (if ACR configured)
# 2. K8s Only Changes → Validate manifests (no images built)
# 3. Docs/CI Changes → Validate YAML/workflows (no tests or builds)
# 4. No ACR → Validate builds without push
#
# KEY PATTERN - always() for conditional dependencies:
#   Jobs with always() run even when dependencies skip/fail
#   Used when job needs to evaluate complex conditions based on multiple dependency results
#   Downstream jobs depending on always() jobs must also use always() + check result
#
# =============================================================================

name: CI

on:
  pull_request:
    branches: [main]
    types: [opened, synchronize, reopened]
  push:
    branches: [main]
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false

env:
  PYTHON_VERSION: "3.11"
  NODE_VERSION: "20"
  ACR_NAME: ${{ vars.ACR_NAME || 'acrytsummprd' }}
  ACR_LOGIN_SERVER: ${{ vars.ACR_LOGIN_SERVER || 'acrytsummprd.azurecr.io' }}

defaults:
  run:
    shell: bash -e {0}  # Exit immediately if any command fails

jobs:
  # ===========================================================================
  # PHASE 1: CHANGE DETECTION
  # ===========================================================================
  # Analyzes PR diff to determine what changed, enabling smart job execution
  # Outputs:
  #   - changed_areas: Space-separated list (e.g., "services/api k8s")
  #   - has_code_changes: Boolean for security scanning
  # Used by all subsequent jobs to decide if they should run
  # ===========================================================================
  detect-changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    outputs:
      changed_areas: ${{ steps.changes.outputs.changed_areas }}
      has_code_changes: ${{ steps.changes.outputs.has_code_changes }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect changes
        id: changes
        uses: ./.github/actions/detect-pipeline-changes

  # ===========================================================================
  # PHASE 2: LINTING
  # ===========================================================================
  # Runs only when relevant code areas change
  # Python: services/api, services/workers, services/shared
  # Frontend: apps/web
  # Blocks tests if lint fails (fail-fast pattern)
  # ===========================================================================
  lint-python:
    name: Lint Python
    runs-on: ubuntu-latest
    needs: [detect-changes]
    if: |
      contains(needs.detect-changes.outputs.changed_areas, 'services/api') ||
      contains(needs.detect-changes.outputs.changed_areas, 'services/workers') ||
      contains(needs.detect-changes.outputs.changed_areas, 'services/shared')
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: ./.github/actions/setup-python
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          working-directory: services/shared

      - name: Run ruff checks
        uses: ./.github/actions/run-ruff-check

  lint-frontend:
    name: Lint Frontend
    runs-on: ubuntu-latest
    needs: [detect-changes]
    if: contains(needs.detect-changes.outputs.changed_areas, 'apps/web')
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: ./.github/actions/setup-node
        with:
          node-version: ${{ env.NODE_VERSION }}
          working-directory: apps/web

      - name: Run ESLint
        working-directory: apps/web
        run: npm run lint

  # ===========================================================================
  # PHASE 3: TESTING
  # ===========================================================================
  # Runs only when relevant code changes
  # Dependencies: lint must pass (fail-fast)
  # 
  # Test Execution Rules:
  # - test-shared: runs if services/shared changed
  # - test-api: runs if services/api OR services/shared changed
  # - test-workers: runs if services/workers OR services/shared changed
  # - test-frontend: runs if apps/web changed
  #
  # Shared changes trigger API + Workers tests (they depend on shared code)
  # ===========================================================================
  test-shared:
    name: Test Shared Package
    runs-on: ubuntu-latest
    needs: [detect-changes, lint-python]
    if: |
      contains(needs.detect-changes.outputs.changed_areas, 'services/shared') &&
      (needs.lint-python.result == 'success' || needs.lint-python.result == 'skipped')
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: ./.github/actions/setup-python
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          working-directory: services/shared

      - name: Run shared tests
        uses: ./.github/actions/run-pytest
        with:
          working-directory: services/shared

  test-api:
    name: Test API
    runs-on: ubuntu-latest
    needs: [detect-changes, lint-python]
    if: |
      (contains(needs.detect-changes.outputs.changed_areas, 'services/api') || contains(needs.detect-changes.outputs.changed_areas, 'services/shared')) &&
      (needs.lint-python.result == 'success' || needs.lint-python.result == 'skipped')
    outputs:
      test_duration: ${{ steps.finish.outputs.test_duration }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python with uv
        uses: ./.github/actions/setup-python-uv
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          service-package: services/api
          install-pytest-xdist: 'true'

      - name: Record tests start
        id: start
        uses: ./.github/actions/record-test-duration
        with:
          test-name: API Tests

      - name: Run API tests (parallel)
        uses: ./.github/actions/run-pytest
        with:
          working-directory: services/api
          parallel: 'true'
          pytest-args: '-v --tb=short -m "not integration and not live"'

      - name: Record tests finish
        id: finish
        uses: ./.github/actions/record-test-duration
        with:
          start-time: ${{ steps.start.outputs.started_at }}
          test-name: API Tests

  test-workers:
    name: Test Workers
    runs-on: ubuntu-latest
    needs: [detect-changes, lint-python]
    if: |
      (contains(needs.detect-changes.outputs.changed_areas, 'services/workers') || contains(needs.detect-changes.outputs.changed_areas, 'services/shared')) &&
      (needs.lint-python.result == 'success' || needs.lint-python.result == 'skipped')
    outputs:
      test_duration: ${{ steps.finish.outputs.test_duration }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python with uv
        uses: ./.github/actions/setup-python-uv
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          service-package: services/workers
          install-pytest-xdist: 'true'

      - name: Record tests start
        id: start
        uses: ./.github/actions/record-test-duration
        with:
          test-name: Workers Tests

      - name: Run workers tests (parallel)
        uses: ./.github/actions/run-pytest
        with:
          working-directory: services/workers
          parallel: 'true'

      - name: Record tests finish
        id: finish
        uses: ./.github/actions/record-test-duration
        with:
          start-time: ${{ steps.start.outputs.started_at }}
          test-name: Workers Tests

  # ===========================================================================
  # PHASE 3B: FRONTEND TESTING
  # ===========================================================================
  test-frontend:
    name: Test Frontend
    runs-on: ubuntu-latest
    needs: [detect-changes, lint-frontend]
    if: |
      contains(needs.detect-changes.outputs.changed_areas, 'apps/web') &&
      (needs.lint-frontend.result == 'success' || needs.lint-frontend.result == 'skipped')
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: ./.github/actions/setup-node
        with:
          node-version: ${{ env.NODE_VERSION }}
          working-directory: apps/web

      - name: Run Vitest
        uses: ./.github/actions/run-frontend-tests

  # ===========================================================================
  # PHASE 4: KUBERNETES VALIDATION
  # ===========================================================================
  # Runs only when k8s/ directory changes
  # Validates:
  #   1. YAML syntax (all manifests)
  #   2. Kustomize builds (base + overlays)
  #   3. ArgoCD Application paths exist
  # Catches k8s config errors before they reach cluster
  # ===========================================================================
  kubernetes-validate:
    name: Kubernetes Validation
    runs-on: ubuntu-latest
    needs: [detect-changes]
    if: contains(needs.detect-changes.outputs.changed_areas, 'k8s')
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Kustomize
        uses: ./.github/actions/setup-kustomize
        with:
          kustomize-version: '5.8.0'

      # -----------------------------------------------------------------------
      # Step 1: YAML Syntax Validation
      # -----------------------------------------------------------------------
      - name: Validate YAML syntax (all K8s manifests)
        uses: ./.github/actions/validate-k8s-yaml
        with:
          directory: k8s

      # -----------------------------------------------------------------------
      # Step 2: Kustomize Build Validation (using composite action)
      # -----------------------------------------------------------------------
      - name: Validate preview overlay
        uses: ./.github/actions/kustomize-validate
        with:
          overlay-path: k8s/overlays/preview
          overlay-name: preview
          max-cpu: '1500'
          output-file: /tmp/preview.yaml

      - name: Validate prod overlay
        uses: ./.github/actions/kustomize-validate
        with:
          overlay-path: k8s/overlays/prod
          overlay-name: prod

      - name: Validate prod-secretstore overlay
        uses: ./.github/actions/kustomize-validate
        with:
          overlay-path: k8s/overlays/prod-secretstore
          overlay-name: prod-secretstore

      # -----------------------------------------------------------------------
      # Step 3: ArgoCD Application Path Validation
      # -----------------------------------------------------------------------
      - name: Validate ArgoCD Application paths exist
        uses: ./.github/actions/validate-argocd-paths


  # ===========================================================================
  # PHASE 5: IMAGE BUILDING (Conditional)
  # ===========================================================================
  # WHEN: Only when code requiring images changes (services/, apps/web, docker/)
  # WHY: Avoid rebuilding images for k8s manifest or docs changes
  # 
  # TWO-STAGE PROCESS:
  # 1. build-images-meta: Generate image tag (pr-123-abc123f)
  # 2. build-images: Build and push images with that tag
  #
  # CRITICAL always() PATTERN:
  # - build-images-meta uses always() to run when lint/test jobs skip
  # - build-images MUST also use always() + check meta result == 'success'
  # - Without this, build-images skips even when meta succeeds
  # 
  # FLOW 1 (ACR configured):
  #   Tests pass → build-images-meta generates tag → build-images builds + pushes
  # FLOW 2 (No ACR):
  #   Tests pass → build-images-validate builds without pushing (validation only)
  # 
  # Image Tags:
  # - PRs: pr-<number>-<sha> (e.g., pr-42-abc123f)
  # - Main: sha-<sha> (e.g., sha-abc123f)
  # ===========================================================================
  build-images-meta:
    name: Prepare Image Tag
    runs-on: ubuntu-latest
    needs: [detect-changes, lint-python, lint-frontend, test-shared, test-api, test-workers, test-frontend]
    # CONDITIONAL IMAGE BUILDING: Only runs when changes require new images
    # vars.ACR_NAME != '': Azure Container Registry must be configured
    # changed_areas contains: Only these areas trigger image builds (MUST match preview workflow logic)
    # lint and test results: Ensure code passes basic checks before building images
    # always(): Run even if some dependencies were skipped, then check their results
    if: |
      always() &&
      vars.ACR_NAME != '' &&
      (contains(needs.detect-changes.outputs.changed_areas, 'services/api') ||
       contains(needs.detect-changes.outputs.changed_areas, 'services/workers') ||
       contains(needs.detect-changes.outputs.changed_areas, 'services/shared') ||
       contains(needs.detect-changes.outputs.changed_areas, 'apps/web') ||
       contains(needs.detect-changes.outputs.changed_areas, 'docker')) &&
      (needs.lint-python.result == 'success' || needs.lint-python.result == 'skipped') &&
      (needs.lint-frontend.result == 'success' || needs.lint-frontend.result == 'skipped') &&
      (needs.test-shared.result == 'success' || needs.test-shared.result == 'skipped') &&
      (needs.test-api.result == 'success' || needs.test-api.result == 'skipped') &&
      (needs.test-workers.result == 'success' || needs.test-workers.result == 'skipped') &&
      (needs.test-frontend.result == 'success' || needs.test-frontend.result == 'skipped')
    outputs:
      image_tag: ${{ steps.tag.outputs.image-tag }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Generate image tag
        id: tag
        uses: ./.github/actions/generate-image-tag
        with:
          pr-number: ${{ github.event.pull_request.number }}
          commit-sha: ${{ github.event.pull_request.head.sha || github.sha }}

      - name: Publish image tag artifact
        if: steps.tag.outputs.image-tag != ''
        uses: ./.github/actions/publish-image-tag
        with:
          image-tag: ${{ steps.tag.outputs.image-tag }}

      - name: Verify image-tag artifact is available
        if: steps.tag.outputs.image-tag != ''
        uses: actions/download-artifact@v4
        with:
          name: image-tag
          path: ./downloaded-artifacts

      - name: Assert downloaded image tag
        if: steps.tag.outputs.image-tag != ''
        uses: ./.github/actions/assert-image-tag-artifact

  build-images:
    name: Build Images (parallel)
    runs-on: ubuntu-latest
    needs: [detect-changes, build-images-meta]
    # CRITICAL always() dependency:
    # - build-images-meta uses always() so it runs when frontend tests skip
    # - This job MUST use always() + check meta result, or it will skip
    # - GitHub Actions won't run jobs depending on always() jobs unless they also use always()
    if: |
      always() &&
      needs.build-images-meta.result == 'success' &&
      vars.ACR_NAME != '' &&
      (contains(needs.detect-changes.outputs.changed_areas, 'services/api') ||
       contains(needs.detect-changes.outputs.changed_areas, 'services/workers') ||
       contains(needs.detect-changes.outputs.changed_areas, 'services/shared') ||
       contains(needs.detect-changes.outputs.changed_areas, 'apps/web') ||
       contains(needs.detect-changes.outputs.changed_areas, 'docker'))
    strategy:
      matrix:
        include:
          - service: api
            dockerfile: services/api/Dockerfile
            image: yt-summarizer-api
          - service: workers
            dockerfile: services/workers/Dockerfile
            image: yt-summarizer-workers
    permissions:
      id-token: write
      contents: read
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Login to Azure Container Registry
        uses: ./.github/actions/azure-acr-login
        with:
          azure-client-id: ${{ secrets.AZURE_CLIENT_ID }}
          azure-tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          azure-subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          acr-name: ${{ env.ACR_NAME }}

      - name: Build and push ${{ matrix.service }} image
        uses: ./.github/actions/build-images
        with:
          service: ${{ matrix.service }}
          image-tag: ${{ needs.build-images-meta.outputs.image_tag }}
          push: true


  # ---------------------------------------------------------------------------
  # BUILD VALIDATION (No ACR)
  # ---------------------------------------------------------------------------
  # FLOW: No ACR configured → Build images locally without pushing
  # PURPOSE: Validate Dockerfiles work without requiring Azure credentials
  # WHEN: ACR_NAME is empty AND code changes require images
  # ---------------------------------------------------------------------------
  build-images-validate:
    name: Build Images (Validate - parallel)
    runs-on: ubuntu-latest
    needs: [detect-changes, lint-python, lint-frontend]
    # Only run if ACR is NOT configured (validation mode)
    if: |
      vars.ACR_NAME == '' &&
      (contains(needs.detect-changes.outputs.changed_areas, 'services/api') ||
       contains(needs.detect-changes.outputs.changed_areas, 'services/workers') ||
       contains(needs.detect-changes.outputs.changed_areas, 'services/shared') ||
       contains(needs.detect-changes.outputs.changed_areas, 'apps/web') ||
       contains(needs.detect-changes.outputs.changed_areas, 'docker'))
    strategy:
      matrix:
        include:
          - service: api
            dockerfile: services/api/Dockerfile
            image: yt-summarizer-api
          - service: workers
            dockerfile: services/workers/Dockerfile
            image: yt-summarizer-workers
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Build ${{ matrix.service }} image (no push)
        uses: ./.github/actions/build-images
        with:
          service: ${{ matrix.service }}
          image-tag: validate
          push: false

  # ===========================================================================
  # E2E TESTING - Runs in Preview Workflow
  # ===========================================================================
  # E2E tests run against live preview environments (preview.yml workflow)
  # Not run in CI because they require full deployed environment
  # Local testing: npm run e2e (with Aspire running)
  # ===========================================================================

  # ===========================================================================
  # PHASE 6: INFRASTRUCTURE VALIDATION
  # ===========================================================================
  # Terraform: Validates HCL syntax and plan (when infra/terraform/ changes)
  # Kustomize: Validates base and overlays build correctly (always runs)
  # ===========================================================================
  validate-terraform:
    name: Validate Terraform
    runs-on: ubuntu-latest
    needs: [detect-changes]
    if: contains(needs.detect-changes.outputs.changed_areas, 'infra/terraform')
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "1.5"

      - name: Validate Terraform configuration
        uses: ./.github/actions/validate-terraform-config
        with:
          working-directory: infra/terraform/environments/prod

  validate-kustomize:
    name: Validate Kustomize
    runs-on: ubuntu-latest
    needs: [lint-python]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Kustomize
        uses: imranismail/setup-kustomize@v2

      - name: Validate base manifests
        uses: ./.github/actions/kustomize-validate
        with:
          overlay-path: k8s/base
          overlay-name: base

      - name: Validate prod overlay
        uses: ./.github/actions/kustomize-validate
        with:
          overlay-path: k8s/overlays/prod
          overlay-name: prod

  # ===========================================================================
  # PHASE 7: SECURITY SCANNING
  # ===========================================================================
  # Runs gitleaks to detect secrets in code
  # Only runs when has_code_changes == true (skips for pure k8s/docs changes)
  # ===========================================================================
  secret-scanning:
    name: Secret Scanning
    runs-on: ubuntu-latest
    needs: [detect-changes]
    if: needs.detect-changes.outputs.has_code_changes == 'true'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run Gitleaks
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITLEAKS_LICENSE: ${{ secrets.GITLEAKS_LICENSE }}

  # ===========================================================================
  # PHASE 8: FINAL STATUS CHECK
  # ===========================================================================
  # always() ensures this runs regardless of job results
  # Validates that:
  #   1. Required jobs ran (based on changed_areas)
  #   2. All jobs that ran passed (result == 'success')
  #   3. Jobs that should skip did skip (result == 'skipped')
  # 
  # Replicates job conditions to ensure pipeline executed correctly
  # Fails if expected jobs didn't run or ran when they shouldn't
  # ===========================================================================
  ci-status:
    name: CI Status
    runs-on: ubuntu-latest
    needs:
      - detect-changes
      - test-shared
      - test-api
      - test-workers
      - test-frontend
      - build-images
      - build-images-validate
      - validate-terraform
      - validate-kustomize
      - kubernetes-validate
      - secret-scanning
    if: always()
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check all jobs passed
        uses: ./.github/actions/validate-ci-results
        with:
          changed-areas: ${{ needs.detect-changes.outputs.changed_areas }}
          test-shared-result: ${{ needs.test-shared.result }}
          test-api-result: ${{ needs.test-api.result }}
          test-workers-result: ${{ needs.test-workers.result }}
          test-frontend-result: ${{ needs.test-frontend.result }}
          validate-terraform-result: ${{ needs.validate-terraform.result }}
          validate-kustomize-result: ${{ needs.validate-kustomize.result }}
          kubernetes-validate-result: ${{ needs.kubernetes-validate.result }}
          secret-scanning-result: ${{ needs.secret-scanning.result }}
          secret-scanning-should-run: ${{ needs.detect-changes.outputs.has_code_changes }}
          build-images-result: ${{ needs.build-images.result }}
          build-images-validate-result: ${{ needs.build-images-validate.result }}
          acr-configured: ${{ vars.ACR_NAME != '' }}

