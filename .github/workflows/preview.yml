# =============================================================================
# Preview Workflow - Deploy PR Preview Environment
# =============================================================================
# Builds Docker images, creates preview overlay, triggers Argo CD sync
# Runs on PR opened/synchronize/reopened after CI passes

name: Preview

on:
  pull_request:
    branches: [main]
    types: [opened, synchronize, reopened]
    # Note: paths-ignore checks entire PR diff, not latest commit
    # We use commit-level detection in detect-changes job for efficiency

concurrency:
  group: preview-${{ github.event.pull_request.number }}
  cancel-in-progress: true

env:
  ACR_NAME: ${{ vars.ACR_NAME || 'acrytsummprd' }}
  ACR_LOGIN_SERVER: ${{ vars.ACR_LOGIN_SERVER || 'acrytsummprd.azurecr.io' }}
  MAX_PREVIEWS: 3

permissions:
  id-token: write
  contents: write
  pull-requests: write

jobs:
  # ---------------------------------------------------------------------------
  # Detect Changes (commit-level check for docs-only changes)
  # ---------------------------------------------------------------------------
  detect-changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    outputs:
      has_code_changes: ${{ steps.check.outputs.has_code_changes }}
    steps:
      - name: Check if commit has code changes
        id: check
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # Get files changed in the latest commit (not entire PR)
          COMMIT_SHA="${{ github.event.pull_request.head.sha }}"
          echo "Checking commit: $COMMIT_SHA"
          
          # Fetch commit details from GitHub API
          FILES=$(gh api repos/${{ github.repository }}/commits/${COMMIT_SHA} --jq '.files[].filename')
          
          echo "Files changed in this commit:"
          echo "$FILES"
          
          # Check if any file is NOT docs/specs/markdown
          HAS_CODE=false
          while IFS= read -r file; do
            if [[ -n "$file" ]]; then
              # Skip docs, specs, and markdown files
              if [[ "$file" == docs/* ]] || [[ "$file" == specs/* ]] || [[ "$file" == *.md ]]; then
                echo "  [skip] $file (docs/specs/markdown)"
              else
                echo "  [CODE] $file"
                HAS_CODE=true
              fi
            fi
          done <<< "$FILES"
          
          echo "has_code_changes=$HAS_CODE" >> $GITHUB_OUTPUT
          
          if [ "$HAS_CODE" = "true" ]; then
            echo "‚úÖ Commit contains code changes - proceeding with preview"
          else
            echo "üìù Commit only contains docs/specs/markdown - skipping preview build"
          fi

  # ---------------------------------------------------------------------------
  # Check CI Status (wait for CI to pass)
  # ---------------------------------------------------------------------------
  wait-for-ci:
    name: Wait for CI
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.has_code_changes == 'true'
    steps:
      - name: Wait for CI workflow
        uses: fountainhead/action-wait-for-check@v1.2.0
        id: wait-for-ci
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          checkName: CI Status
          ref: ${{ github.event.pull_request.head.sha }}
          timeoutSeconds: 900
          intervalSeconds: 30

      - name: Fail if CI did not pass
        if: steps.wait-for-ci.outputs.conclusion != 'success'
        run: |
          echo "::error::CI workflow did not pass. Preview deployment blocked."
          exit 1

  # ---------------------------------------------------------------------------
  # Check Concurrency Limit
  # ---------------------------------------------------------------------------
  check-concurrency:
    name: Check Preview Limit
    runs-on: ubuntu-latest
    needs: wait-for-ci
    outputs:
      can_deploy: ${{ steps.check.outputs.can_deploy }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Count active previews
        id: check
        run: |
          # Count existing preview directories (excluding _template)
          PREVIEW_COUNT=$(find k8s/overlays/previews -maxdepth 1 -type d -name "pr-*" | wc -l)
          PR_NUMBER=${{ github.event.pull_request.number }}
          
          # Check if this PR already has a preview
          if [ -d "k8s/overlays/previews/pr-${PR_NUMBER}" ]; then
            echo "Preview already exists for PR #${PR_NUMBER}, updating..."
            echo "can_deploy=true" >> $GITHUB_OUTPUT
          elif [ "$PREVIEW_COUNT" -lt "${{ env.MAX_PREVIEWS }}" ]; then
            echo "Preview slot available (${PREVIEW_COUNT}/${{ env.MAX_PREVIEWS }})"
            echo "can_deploy=true" >> $GITHUB_OUTPUT
          else
            echo "::warning::Maximum previews reached (${PREVIEW_COUNT}/${{ env.MAX_PREVIEWS }}). Waiting for slot..."
            echo "can_deploy=false" >> $GITHUB_OUTPUT
          fi

      - name: Post queue status
        if: steps.check.outputs.can_deploy == 'false'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `‚è≥ **Preview Queued**\n\nMaximum concurrent previews (${{ env.MAX_PREVIEWS }}) reached. Your preview will deploy when a slot becomes available.\n\nClose another PR or wait for an existing preview to be cleaned up.`
            })

  # ---------------------------------------------------------------------------
  # Build and Push Docker Images
  # ---------------------------------------------------------------------------
  build-images:
    name: Build Images
    runs-on: ubuntu-latest
    needs: check-concurrency
    if: needs.check-concurrency.outputs.can_deploy == 'true'
    outputs:
      image_tag: ${{ steps.meta.outputs.image_tag }}
      api_digest: ${{ steps.build-api.outputs.digest }}
      workers_digest: ${{ steps.build-workers.outputs.digest }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Azure Login via OIDC
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Login to ACR
        run: az acr login --name ${{ env.ACR_NAME }}

      - name: Generate image tag
        id: meta
        run: |
          SHORT_SHA=$(echo "${{ github.event.pull_request.head.sha }}" | cut -c1-7)
          IMAGE_TAG="pr-${{ github.event.pull_request.number }}-${SHORT_SHA}"
          echo "image_tag=${IMAGE_TAG}" >> $GITHUB_OUTPUT
          echo "Generated image tag: ${IMAGE_TAG}"

      - name: Build and push API image
        id: build-api
        uses: docker/build-push-action@v5
        with:
          context: .
          file: services/api/Dockerfile
          push: true
          tags: |
            ${{ env.ACR_LOGIN_SERVER }}/yt-summarizer-api:${{ steps.meta.outputs.image_tag }}
          labels: |
            org.opencontainers.image.source=https://github.com/${{ github.repository }}
            org.opencontainers.image.revision=${{ github.event.pull_request.head.sha }}
            preview.pr=${{ github.event.pull_request.number }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          platforms: linux/amd64

      - name: Build and push Workers image
        id: build-workers
        uses: docker/build-push-action@v5
        with:
          context: .
          file: services/workers/Dockerfile
          push: true
          tags: |
            ${{ env.ACR_LOGIN_SERVER }}/yt-summarizer-workers:${{ steps.meta.outputs.image_tag }}
          labels: |
            org.opencontainers.image.source=https://github.com/${{ github.repository }}
            org.opencontainers.image.revision=${{ github.event.pull_request.head.sha }}
            preview.pr=${{ github.event.pull_request.number }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          platforms: linux/amd64

  # ---------------------------------------------------------------------------
  # Create/Update Preview Overlay
  # ---------------------------------------------------------------------------
  create-overlay:
    name: Create Preview Overlay
    runs-on: ubuntu-latest
    needs: build-images
    outputs:
      preview_url: ${{ steps.overlay.outputs.preview_url }}
    steps:
      - name: Generate GitHub App token
        id: app-token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.APP_ID }}
          private-key: ${{ secrets.APP_PRIVATE_KEY }}

      - name: Checkout main branch
        uses: actions/checkout@v4
        with:
          token: ${{ steps.app-token.outputs.token }}
          ref: main

      - name: Check for k8s overlay template
        id: check-template
        run: |
          if [ -d "k8s/overlays/previews/_template" ]; then
            echo "template_exists=true" >> $GITHUB_OUTPUT
          else
            echo "template_exists=false" >> $GITHUB_OUTPUT
            echo "::warning::Preview overlay template not found on main branch. Preview overlays will be available after Azure CI/CD infrastructure is merged."
          fi

      - name: Create preview overlay from template
        if: steps.check-template.outputs.template_exists == 'true'
        id: overlay
        env:
          PR_NUMBER: ${{ github.event.pull_request.number }}
          IMAGE_TAG: ${{ needs.build-images.outputs.image_tag }}
          ACR_SERVER: ${{ env.ACR_LOGIN_SERVER }}
        run: |
          PREVIEW_DIR="k8s/overlays/previews/pr-${PR_NUMBER}"
          TEMPLATE_DIR="k8s/overlays/previews/_template"
          
          # Remove existing preview overlay if it exists
          rm -rf "${PREVIEW_DIR}"
          
          # Copy template to preview directory
          cp -r "${TEMPLATE_DIR}" "${PREVIEW_DIR}"
          
          # Replace placeholders in all files
          find "${PREVIEW_DIR}" -type f -name "*.yaml" | while read file; do
            sed -i "s/{{PR_NUMBER}}/${PR_NUMBER}/g" "$file"
            sed -i "s/{{IMAGE_TAG}}/${IMAGE_TAG}/g" "$file"
            sed -i "s|{{ACR_LOGIN_SERVER}}|${ACR_SERVER}|g" "$file"
          done
          
          # Generate preview URL
          PREVIEW_URL="https://pr-${PR_NUMBER}.preview.yt-summarizer.example.com"
          echo "preview_url=${PREVIEW_URL}" >> $GITHUB_OUTPUT
          
          echo "Created preview overlay at ${PREVIEW_DIR}"
          echo "Preview URL: ${PREVIEW_URL}"
          
          # Show generated files
          echo "Generated files:"
          find "${PREVIEW_DIR}" -type f -name "*.yaml" -exec echo "  {}" \;

      - name: Commit and push overlay
        if: steps.check-template.outputs.template_exists == 'true'
        run: |
          PR_NUMBER=${{ github.event.pull_request.number }}
          
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          git add k8s/overlays/previews/pr-${PR_NUMBER}/
          
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "chore(preview): create/update overlay for PR #${PR_NUMBER}
            
            Preview URL: ${{ steps.overlay.outputs.preview_url }}
            Image tag: ${{ needs.build-images.outputs.image_tag }}
            Commit: ${{ github.event.pull_request.head.sha }}
            
            [skip ci]"
            
            git push origin main
          fi

  # ---------------------------------------------------------------------------
  # Post Preview Status
  # ---------------------------------------------------------------------------
  post-status:
    name: Post Preview Status
    runs-on: ubuntu-latest
    needs: [build-images, create-overlay]
    if: needs.create-overlay.outputs.preview_url != ''
    steps:
      - name: Post preview URL to PR
        uses: actions/github-script@v7
        with:
          script: |
            const previewUrl = '${{ needs.create-overlay.outputs.preview_url }}';
            const imageTag = '${{ needs.build-images.outputs.image_tag }}';
            const sha = '${{ github.event.pull_request.head.sha }}'.substring(0, 7);
            
            // Find and update existing comment or create new one
            const { data: comments } = await github.rest.issues.listComments({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
            });
            
            const botComment = comments.find(comment => 
              comment.user.type === 'Bot' && 
              comment.body.includes('Preview Environment')
            );
            
            const body = `## üöÄ Preview Environment

            | Property | Value |
            |----------|-------|
            | **Status** | ‚úÖ Deployed |
            | **URL** | [${previewUrl}](${previewUrl}) |
            | **API** | [${previewUrl}/health](${previewUrl}/health) |
            | **Image Tag** | \`${imageTag}\` |
            | **Commit** | \`${sha}\` |
            | **Updated** | ${new Date().toISOString()} |

            > üîÑ This preview will be automatically updated when you push new commits.
            > üóëÔ∏è Preview will be cleaned up when this PR is closed or merged.
            
            ---
            <details>
            <summary>üîß Argo CD Sync Status</summary>
            
            The preview is managed by Argo CD ApplicationSet. Check the Argo CD dashboard for sync status.
            
            Application name: \`preview-pr-${{ github.event.pull_request.number }}\`
            </details>`;
            
            if (botComment) {
              await github.rest.issues.updateComment({
                comment_id: botComment.id,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: body
              });
            } else {
              await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: body
              });
            }

      - name: Create deployment summary
        run: |
          echo "## üöÄ Preview Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **PR** | #${{ github.event.pull_request.number }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Preview URL** | ${{ needs.create-overlay.outputs.preview_url }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Image Tag** | \`${{ needs.build-images.outputs.image_tag }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Commit** | \`${{ github.event.pull_request.head.sha }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üîó Quick Links" >> $GITHUB_STEP_SUMMARY
          echo "- [Preview Site](${{ needs.create-overlay.outputs.preview_url }})" >> $GITHUB_STEP_SUMMARY
          echo "- [Argo CD Dashboard](https://argocd.yt-summarizer.example.com)" >> $GITHUB_STEP_SUMMARY
