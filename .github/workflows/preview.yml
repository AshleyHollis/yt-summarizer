# =============================================================================
# Preview Workflow - Deploy PR Preview Environment
# =============================================================================
# Deploys preview environment using images already built by CI workflow
# Argo CD ApplicationSet with Pull Request Generator picks up the changes
# Runs E2E tests after deployment to validate changes
# Runs on PR opened/synchronize/reopened after CI passes

name: Deploy Preview

on:
  workflow_run:
    types: [completed]
  workflow_dispatch:

concurrency:
  group: preview-${{ env.PR_NUMBER }}
  cancel-in-progress: true

env:
  ACR_NAME: ${{ vars.ACR_NAME || 'acrytsummprd' }}
  ACR_LOGIN_SERVER: ${{ vars.ACR_LOGIN_SERVER || 'acrytsummprd.azurecr.io' }}
  MAX_PREVIEWS: 3
  PR_NUMBER: ${{ github.event.pull_request.number || github.event.workflow_run.pull_requests[0].number }}

permissions:
  id-token: write
  contents: write
  pull-requests: write
  checks: write

jobs:
  # ---------------------------------------------------------------------------
  # Detect Changes (commit-level check for docs-only changes)
  # ---------------------------------------------------------------------------
  detect-changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    outputs:
      has_code_changes: ${{ steps.check.outputs.has_code_changes }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check if commit has code changes
        id: check
        uses: ./.github/actions/detect-pr-code-changes
        with:
          github-token: ${{ github.token }}
          repository: ${{ github.repository }}
          event-name: ${{ github.event_name }}
          pr-number: ${{ env.PR_NUMBER }}


  # ---------------------------------------------------------------------------
  # Wait for CI to Pass (CI builds and pushes images) or verify CI result when triggered by workflow_run
  # ---------------------------------------------------------------------------
  wait-for-ci:
    name: Wait for CI
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.has_code_changes == 'true'
    outputs:
      image_tag: ${{ steps.image-tag.outputs.image_tag }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Verify CI workflow passed (workflow_run trigger)
        if: ${{ github.event_name == 'workflow_run' }}
        uses: ./.github/actions/verify-ci-workflow
        with:
          workflow-conclusion: ${{ github.event.workflow_run.conclusion }}
          workflow-name: ${{ github.event.workflow_run.name }}


      - name: Wait for CI workflow (pull_request trigger)
        if: ${{ github.event_name == 'pull_request' }}
        uses: ./.github/actions/wait-for-ci
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          commit-sha: ${{ github.event.pull_request.head.sha }}

      - name: Determine image tag from CI
        id: image-tag
        uses: ./.github/actions/generate-image-tag
        with:
          commit-sha: ${{ github.event.pull_request.head.sha || github.event.workflow_run.pull_requests[0].head.sha }}
          pr-number: ${{ env.PR_NUMBER }}

  # ---------------------------------------------------------------------------
  # Check Active Preview Count
  # ---------------------------------------------------------------------------
  check-concurrency:
    name: Check Preview Limit
    runs-on: ubuntu-latest
    needs: wait-for-ci
    outputs:
      can_deploy: ${{ steps.check.outputs.can_deploy }}
      image_tag: ${{ steps.export-image.outputs.image_tag }}
    steps:
      - name: Check preview concurrency limit
        id: check
        uses: ./.github/actions/check-preview-concurrency
        with:
          github-token: ${{ github.token }}
          max-previews: ${{ env.MAX_PREVIEWS }}
          repository: ${{ github.repository }}
          pr-number: ${{ env.PR_NUMBER }}

      - name: Export computed image tag
        id: export-image
        uses: ./.github/actions/export-image-tag
        with:
          image-tag: ${{ needs.wait-for-ci.outputs.image_tag }}


      - name: Post queue status
        if: steps.check.outputs.can_deploy == 'false'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `‚è≥ **Preview Queued**\n\nMaximum concurrent previews (${{ env.MAX_PREVIEWS }}) reached. Your preview will deploy when a slot becomes available.\n\nClose another PR or wait for an existing preview to be cleaned up.`
            })

  # ---------------------------------------------------------------------------
  # Update Preview Overlay in PR Branch
  # ---------------------------------------------------------------------------
  get-ingress:
    name: Get Ingress Info
    runs-on: ubuntu-latest
    needs: check-concurrency
    if: needs.check-concurrency.outputs.can_deploy == 'true'
    outputs:
      ingress_ip: ${{ steps.get-ip.outputs.ingress-ip }}
      preview_url: ${{ steps.compute.outputs.preview-url }}
      preview_host: ${{ steps.compute.outputs.preview-host }}
      tls_secret: ${{ steps.compute.outputs.tls-secret }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Get Ingress Controller IP
        id: get-ip
        uses: ./.github/actions/get-aks-ingress-ip
        with:
          azure-client-id: ${{ secrets.AZURE_CLIENT_ID }}
          azure-tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          azure-subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          resource-group: ${{ vars.AZURE_RESOURCE_GROUP || 'rg-ytsumm-prd' }}
          cluster-name: ${{ vars.AKS_CLUSTER_NAME || 'aks-ytsumm-prd' }}

      - name: Compute Preview URLs
        id: compute
        uses: ./.github/actions/compute-preview-urls
        with:
          pr-number: ${{ env.PR_NUMBER }}
          ingress-ip: ${{ steps.get-ip.outputs.ingress-ip }}

  update-overlay:
    name: Update Preview Overlay
    runs-on: ubuntu-latest
    needs: [check-concurrency, get-ingress]
    if: needs.check-concurrency.outputs.can_deploy == 'true'
    outputs:
      preview_url: ${{ steps.overlay.outputs.preview_url }}
      image_tag: ${{ needs.check-concurrency.outputs.image_tag }}
    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.ref || github.event.workflow_run.pull_requests[0].head.ref }}
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Python with dependencies
        uses: ./.github/actions/setup-kustomize
        with:
          install-python: 'true'

      - name: Azure ACR Login
        uses: ./.github/actions/azure-acr-login
        with:
          azure-client-id: ${{ secrets.AZURE_CLIENT_ID }}
          azure-tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          azure-subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          acr-name: ${{ env.ACR_NAME }}

      - name: Set AKS Context
        uses: azure/aks-set-context@v3
        with:
          resource-group: ${{ vars.AZURE_RESOURCE_GROUP || 'rg-ytsumm-prd' }}
          cluster-name: ${{ vars.AZURE_AKS_CLUSTER_NAME || 'aks-ytsumm-prd' }}

      - name: Get Ingress Controller IP
        id: ingress-ip
        uses: ./.github/actions/get-aks-ingress-ip
        with:
          azure-client-id: ${{ secrets.AZURE_CLIENT_ID }}
          azure-subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          azure-tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          resource-group: ${{ vars.AZURE_RESOURCE_GROUP || 'rg-ytsumm-prd' }}
          cluster-name: ${{ vars.AZURE_AKS_CLUSTER_NAME || 'aks-ytsumm-prd' }}


      - name: Update preview overlay with image tags
        id: overlay
        uses: ./.github/actions/update-preview-overlay
        with:
          pr-number: ${{ env.PR_NUMBER }}
          image-tag: ${{ needs.check-concurrency.outputs.image_tag }}
          acr-server: ${{ env.ACR_LOGIN_SERVER }}
          preview-host: ${{ needs.get-ingress.outputs.preview_host }}
          tls-secret: ${{ needs.get-ingress.outputs.tls_secret }}
          preview-url: ${{ needs.get-ingress.outputs.preview_url }}

      - name: Validate generated overlay (kustomize + dry-run)
        uses: ./.github/actions/validate-kustomize-overlay

      - name: Commit and push overlay update
        uses: ./.github/actions/commit-overlay-changes
        with:
          pr-number: ${{ env.PR_NUMBER }}
          image-tag: ${{ needs.check-concurrency.outputs.image_tag }}
          commit-sha: ${{ github.event.pull_request.head.sha || github.event.workflow_run.pull_requests[0].head.sha }}
          pr-branch: ${{ github.event.pull_request.head.ref || github.event.workflow_run.pull_requests[0].head.ref }}

  # ---------------------------------------------------------------------------
  # Verify Deployment
  # ---------------------------------------------------------------------------
  # Waits for Argo CD to sync and verifies pods are running the correct images
  verify-deployment:
    name: Verify Deployment
    runs-on: ubuntu-latest
    needs: [update-overlay, check-concurrency]
    steps:
      - name: Azure Login
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Set AKS Context
        uses: azure/aks-set-context@v3
        with:
          resource-group: ${{ vars.AZURE_RESOURCE_GROUP || 'rg-ytsumm-prd' }}
          cluster-name: ${{ vars.AKS_CLUSTER_NAME || 'aks-ytsumm-prd' }}

      - name: Wait for Argo CD to sync
        uses: ./.github/actions/wait-for-argocd-sync
        with:
          namespace: preview-pr-${{ env.PR_NUMBER }}
          pr-number: ${{ env.PR_NUMBER }}
          timeout-seconds: '180'

      - name: Verify API deployment image
        uses: ./.github/actions/verify-deployment-image
        with:
          namespace: preview-pr-${{ env.PR_NUMBER }}
          deployment-name: api
          expected-tag: ${{ needs.check-concurrency.outputs.image_tag }}
      - name: Verify workers deployment image
        uses: ./.github/actions/verify-worker-deployments
        with:
          namespace: preview-pr-${{ env.PR_NUMBER }}
          expected-tag: ${{ needs.check-concurrency.outputs.image_tag }}
          registry: ${{ vars.ACR_LOGIN_SERVER || 'acrytsummprd.azurecr.io' }}
          workers: 'transcribe-worker,summarize-worker,embed-worker,relationships-worker'
          fail-on-mismatch: 'false'


      - name: Run basic API health check
        if: needs.update-overlay.outputs.preview_url != ''
        uses: ./.github/actions/health-check
        with:
          url: ${{ needs.update-overlay.outputs.preview_url }}/health/live
          max-attempts: '10'
          interval-seconds: '10'
          timeout-seconds: '5'
          expected-status: '200'
          service-name: 'Preview API'

      - name: Verify API Certificate
        uses: ./.github/actions/verify-tls-certificate
        with:
          host: ${{ needs.get-ingress.outputs.preview_host }}

  # ---------------------------------------------------------------------------
  # Deploy Frontend Preview to SWA
  # ---------------------------------------------------------------------------
  deploy-frontend-preview:
    name: Deploy Frontend Preview
    runs-on: ubuntu-latest
    needs: get-ingress
    outputs:
      frontend_preview_url: ${{ steps.deploy.outputs.static_web_app_url }}
    steps:
      - name: Verify SWA token is configured
        uses: ./.github/actions/verify-secret
        with:
          secret-name: 'SWA_DEPLOYMENT_TOKEN'
          secret-value: ${{ secrets.SWA_DEPLOYMENT_TOKEN }}

      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.ref || github.event.workflow_run.pull_requests[0].head.ref }}

      - name: Setup Node.js
        uses: ./.github/actions/setup-node
        with:
          node-version: "20"
          working-directory: apps/web

      - name: Build frontend for preview
        uses: ./.github/actions/build-frontend
        with:
          api-url: ${{ needs.get-ingress.outputs.preview_url }}
          environment: 'preview'
          working-directory: 'apps/web'

      - name: Deploy to SWA staging environment
        id: deploy
        uses: Azure/static-web-apps-deploy@v1
        env:
          # Set the backend API URL for runtime
          NEXT_PUBLIC_API_URL: ${{ needs.get-ingress.outputs.preview_url || '' }}
          NEXT_PUBLIC_ENVIRONMENT: preview
        with:
          azure_static_web_apps_api_token: ${{ secrets.SWA_DEPLOYMENT_TOKEN }}
          repo_token: ${{ secrets.GITHUB_TOKEN }}

          action: upload
          # For Next.js hybrid, app_location is the Next.js app root
          app_location: apps/web
          # For Next.js hybrid, output_location MUST be empty
          # SWA handles the .next folder internally
          output_location: ""
          skip_app_build: true
          # Deploying to a PR creates a staging environment automatically
          production_branch: main

  # ---------------------------------------------------------------------------
  # Post Preview Comment
  # ---------------------------------------------------------------------------
  # Posts preview information to the PR for reviewers (human-facing).
  # This is intentionally separate from the preview status check to avoid
  # blocking merges if posting a comment fails.
  post-preview-comment:
    name: Post Preview Comment
    runs-on: ubuntu-latest
    needs: [update-overlay, verify-deployment, deploy-frontend-preview]
    steps:
      - name: Post preview URL to PR
        uses: ./.github/actions/post-preview-comment
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          pr-number: ${{ env.PR_NUMBER }}
          preview-url: ${{ needs.get-ingress.outputs.preview_url }}
          image-tag: ${{ needs.update-overlay.outputs.image_tag }}
          commit-sha: ${{ github.event.pull_request.head.sha || github.event.workflow_run.pull_requests[0].head.sha }}
          frontend-url: ${{ needs.deploy-frontend-preview.outputs.frontend_preview_url }}

      - name: Create deployment summary
        uses: ./.github/actions/create-preview-summary
        with:
          pr-number: ${{ env.PR_NUMBER }}
          preview-url: ${{ needs.get-ingress.outputs.preview_url }}
          image-tag: ${{ needs.update-overlay.outputs.image_tag }}
          commit-sha: ${{ github.event.pull_request.head.sha || github.event.workflow_run.pull_requests[0].head.sha }}


  # ---------------------------------------------------------------------------
  # E2E Tests on Preview Environment
  # ---------------------------------------------------------------------------
  e2e-tests:
    name: E2E Tests
    runs-on: ubuntu-latest
    needs: [update-overlay, verify-deployment, deploy-frontend-preview, post-preview-comment]
    # Skip E2E tests if no API URL is configured
    if: needs.get-ingress.outputs.preview_url != ''
    outputs:
      result: ${{ steps.run-tests.outcome }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: 'npm'
          cache-dependency-path: apps/web/package-lock.json

      - name: Install dependencies
        working-directory: apps/web
        run: npm ci

      - name: Wait for ArgoCD sync
        uses: ./.github/actions/wait-for-argocd-sync
        with:
          namespace: preview-pr-${{ env.PR_NUMBER }}
          pr-number: ${{ env.PR_NUMBER }}
          timeout-seconds: '60'

      - name: Wait for API to be ready
        uses: ./.github/actions/health-check
        with:
          url: ${{ needs.get-ingress.outputs.preview_url }}/health/live
          max-attempts: '20'
          interval-seconds: '15'
          timeout-seconds: '5'
          expected-status: '200'
          service-name: 'Preview API (E2E)'

      - name: Run E2E tests
        id: run-tests
        uses: ./.github/actions/run-playwright-tests
        env:
          USE_EXTERNAL_SERVER: "true"
          BASE_URL: ${{ needs.deploy-frontend-preview.outputs.frontend_preview_url || needs.get-ingress.outputs.preview_url }}
          NEXT_PUBLIC_API_URL: ${{ needs.get-ingress.outputs.preview_url }}
          API_URL: ${{ needs.get-ingress.outputs.preview_url }}

      - name: Upload Playwright report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: playwright-report-pr-${{ env.PR_NUMBER }}
          path: apps/web/playwright-report/
          retention-days: 7

      - name: Comment E2E results on PR
        if: always()
        uses: ./.github/actions/post-e2e-results
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          pr-number: ${{ env.PR_NUMBER }}
          test-outcome: ${{ steps.run-tests.outcome }}
          preview-url: ${{ needs.get-ingress.outputs.preview_url }}
          commit-sha: ${{ github.event.pull_request.head.sha || github.event.workflow_run.pull_requests[0].head.sha }}
          run-id: ${{ github.run_id }}
          repository: ${{ github.repository }}

  # ---------------------------------------------------------------------------
  # Preview Status Check - Required Check for Merge
  # ---------------------------------------------------------------------------
  # Aggregates preview job results and produces a single, deterministic
  # required check used to gate merges (machine-facing/gating).
  # E2E tests are optional (skipped if no backend API URL is configured).
  # ---------------------------------------------------------------------------
  preview-status-check:
    name: Preview Status Check
    runs-on: ubuntu-latest
    needs: [detect-changes, update-overlay, verify-deployment, deploy-frontend-preview, e2e-tests]
    if: always()
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check preview pipeline status
        uses: ./.github/actions/check-preview-status
        with:
          has-code-changes: ${{ needs.detect-changes.outputs.has_code_changes }}
          update-overlay-result: ${{ needs.update-overlay.result }}
          verify-deployment-result: ${{ needs.verify-deployment.result }}
          deploy-frontend-result: ${{ needs.deploy-frontend-preview.result }}
          e2e-tests-result: ${{ needs.e2e-tests.result }}
          api-url-configured: ${{ needs.get-ingress.outputs.preview_url }}

