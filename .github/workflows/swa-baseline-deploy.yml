# Simple SWA deployment for baseline warmup testing
# This workflow bypasses all the complex orchestration to test SWA in isolation

name: SWA Baseline Deploy

on:
  workflow_dispatch:
    inputs:
      pr_number:
        description: 'PR number to deploy'
        required: true
        type: string
  push:
    branches:
      - test/swa-warmup-baseline
      - fix/swa-working-baseline
      - migration/phase-1-env-vars

permissions:
  id-token: write
  contents: read

jobs:
  deploy-swa:
    name: Deploy SWA Baseline
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: ./.github/actions/setup-node
        with:
          node-version: "20"
          working-directory: apps/web

      # PHASE 1: Add Azure login and Auth0 secret fetch (without using them yet)
      - name: Azure Login (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Fetch Auth0 credentials from Key Vault
        id: fetch-auth0
        run: |
          echo "Fetching Auth0 credentials from Key Vault..."
          
          # Fetch Auth0 preview environment credentials
          AUTH0_DOMAIN=$(az keyvault secret show --vault-name "kv-ytsumm-prd" --name "auth0-preview-domain" --query "value" -o tsv)
          AUTH0_CLIENT_ID=$(az keyvault secret show --vault-name "kv-ytsumm-prd" --name "auth0-preview-client-id" --query "value" -o tsv)
          AUTH0_CLIENT_SECRET=$(az keyvault secret show --vault-name "kv-ytsumm-prd" --name "auth0-preview-client-secret" --query "value" -o tsv)
          AUTH0_SESSION_SECRET=$(az keyvault secret show --vault-name "kv-ytsumm-prd" --name "auth0-preview-session-secret" --query "value" -o tsv)
          
          # Mask secrets in logs
          echo "::add-mask::$AUTH0_CLIENT_SECRET"
          echo "::add-mask::$AUTH0_SESSION_SECRET"
          
          # Export as outputs for potential future use
          echo "auth0-domain=$AUTH0_DOMAIN" >> $GITHUB_OUTPUT
          echo "auth0-client-id=$AUTH0_CLIENT_ID" >> $GITHUB_OUTPUT
          echo "auth0-client-secret=$AUTH0_CLIENT_SECRET" >> $GITHUB_OUTPUT
          echo "auth0-session-secret=$AUTH0_SESSION_SECRET" >> $GITHUB_OUTPUT
          
          echo "‚úÖ Auth0 credentials fetched successfully (not used in build yet)"

      - name: Build frontend
        working-directory: apps/web
        env:
          # Still using placeholder API URL - no Auth0 in build yet
          NEXT_PUBLIC_API_URL: "https://api-placeholder.example.com"
          NEXT_PUBLIC_ENVIRONMENT: "preview"
        run: |
          echo "Building Next.js app..."
          echo "Note: Auth0 secrets fetched but not used in this phase"
          npm run build

      - name: Deploy to SWA
        id: deploy
        uses: Azure/static-web-apps-deploy@v1
        with:
          azure_static_web_apps_api_token: ${{ secrets.SWA_DEPLOYMENT_TOKEN }}
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          action: upload
          app_location: apps/web
          output_location: ""
          skip_app_build: true
          production_branch: main

      - name: Report deployment URL
        run: |
          echo "‚úÖ SWA Deployment completed"
          echo "üìç URL: ${{ steps.deploy.outputs.static_web_app_url }}"
