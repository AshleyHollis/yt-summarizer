# =============================================================================
# E2E Tests against Preview Environments
# =============================================================================
# Runs Playwright E2E tests against a deployed preview environment.
# Triggered after Argo CD deploys a PR preview environment.

name: Preview E2E Tests

on:
  # Triggered by deployment workflow or manually
  workflow_dispatch:
    inputs:
      environment_url:
        description: 'Base URL of the preview environment (e.g., https://pr-123.preview.ytsumm.dev)'
        required: true
        type: string
      api_url:
        description: 'API URL of the preview environment (e.g., https://api-pr-123.preview.ytsumm.dev)'
        required: true
        type: string
      pr_number:
        description: 'PR number for status reporting'
        required: false
        type: string

  # Can also be called by other workflows
  workflow_call:
    inputs:
      environment_url:
        description: 'Base URL of the preview environment'
        required: true
        type: string
      api_url:
        description: 'API URL of the preview environment'
        required: true
        type: string
      pr_number:
        description: 'PR number for status reporting'
        required: false
        type: string

env:
  NODE_VERSION: "22"

jobs:
  e2e-tests:
    name: E2E Tests
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Azure login (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Retrieve Auth0 test credentials from Key Vault
        uses: azure/CLI@v2
        with:
          inlineScript: |
            # Retrieve test user credentials from Azure Key Vault
            # These are created by Terraform in infra/terraform/environments/prod/auth0.tf
            
            AUTH0_ADMIN_EMAIL=$(az keyvault secret show --vault-name "yt-summarizer-kv" --name "auth0-admin-test-email" --query "value" -o tsv)
            AUTH0_ADMIN_PASSWORD=$(az keyvault secret show --vault-name "yt-summarizer-kv" --name "auth0-admin-test-password" --query "value" -o tsv)
            AUTH0_USER_EMAIL=$(az keyvault secret show --vault-name "yt-summarizer-kv" --name "auth0-user-test-email" --query "value" -o tsv)
            AUTH0_USER_PASSWORD=$(az keyvault secret show --vault-name "yt-summarizer-kv" --name "auth0-user-test-password" --query "value" -o tsv)
            
            # Export to GitHub Actions environment
            echo "AUTH0_ADMIN_TEST_EMAIL=$AUTH0_ADMIN_EMAIL" >> $GITHUB_ENV
            echo "::add-mask::$AUTH0_ADMIN_PASSWORD"
            echo "AUTH0_ADMIN_TEST_PASSWORD=$AUTH0_ADMIN_PASSWORD" >> $GITHUB_ENV
            echo "AUTH0_USER_TEST_EMAIL=$AUTH0_USER_EMAIL" >> $GITHUB_ENV
            echo "::add-mask::$AUTH0_USER_PASSWORD"
            echo "AUTH0_USER_TEST_PASSWORD=$AUTH0_USER_PASSWORD" >> $GITHUB_ENV

      - name: Setup Node.js
        uses: ./.github/actions/setup-node
        with:
          node-version: ${{ env.NODE_VERSION }}
          working-directory: apps/web

      - name: Wait for Frontend to be ready
        uses: ./.github/actions/health-check
        with:
          url: ${{ inputs.environment_url }}
          max-attempts: '30'
          interval-seconds: '10'
          timeout-seconds: '5'
          expected-status: '200'
          service-name: 'Preview Frontend'

      - name: Wait for API to be ready
        uses: ./.github/actions/health-check
        with:
          url: ${{ inputs.api_url }}/health/live
          max-attempts: '30'
          interval-seconds: '10'
          timeout-seconds: '5'
          expected-status: '200'
          service-name: 'Preview API'

      - name: Run E2E tests
        uses: ./.github/actions/run-playwright-tests
        env:
          USE_EXTERNAL_SERVER: "true"
          BASE_URL: ${{ inputs.environment_url }}
          NEXT_PUBLIC_API_URL: ${{ inputs.api_url }}
          API_URL: ${{ inputs.api_url }}
          # Auth0 configuration (needed for login page and OAuth)
          AUTH0_SECRET: ${{ secrets.AUTH0_SECRET }}
          AUTH0_BASE_URL: ${{ inputs.environment_url }}
          AUTH0_ISSUER_BASE_URL: ${{ secrets.AUTH0_ISSUER_BASE_URL }}
          AUTH0_CLIENT_ID: ${{ secrets.AUTH0_CLIENT_ID }}
          AUTH0_CLIENT_SECRET: ${{ secrets.AUTH0_CLIENT_SECRET }}
          # Test user credentials from Key Vault
          AUTH0_ADMIN_TEST_EMAIL: ${{ env.AUTH0_ADMIN_TEST_EMAIL }}
          AUTH0_ADMIN_TEST_PASSWORD: ${{ env.AUTH0_ADMIN_TEST_PASSWORD }}
          AUTH0_USER_TEST_EMAIL: ${{ env.AUTH0_USER_TEST_EMAIL }}
          AUTH0_USER_TEST_PASSWORD: ${{ env.AUTH0_USER_TEST_PASSWORD }}

      - name: Upload Playwright report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: playwright-report-pr-${{ inputs.pr_number || 'manual' }}
          path: apps/web/playwright-report/
          retention-days: 7

      - name: Comment on PR with results
        if: inputs.pr_number && always()
        uses: actions/github-script@v7
        with:
          script: |
            const status = '${{ job.status }}' === 'success' ? '✅' : '❌';
            const reportUrl = `https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}`;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: parseInt('${{ inputs.pr_number }}'),
              body: `## E2E Test Results ${status}\n\n` +
                    `**Environment:** ${{ inputs.environment_url }}\n` +
                    `**Status:** ${{ job.status }}\n\n` +
                    `[View Playwright Report](${reportUrl})`
            });
