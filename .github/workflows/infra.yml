# Infrastructure Deployment Workflow
# Runs Terraform plan on PRs, applies on merge to main

name: Infrastructure

on:
  push:
    branches: [main]
    paths:
      - 'infra/terraform/**'
  pull_request:
    branches: [main]
    paths:
      - 'infra/terraform/**'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy'
        required: true
        type: choice
        options:
          - staging
          - production
      action:
        description: 'Terraform action'
        required: true
        type: choice
        options:
          - plan
          - apply
          - destroy

concurrency:
  group: infra-${{ github.event.inputs.environment || 'staging' }}
  cancel-in-progress: false

env:
  TF_VERSION: '1.5.7'
  ARM_USE_OIDC: true
  ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
  ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
  ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

jobs:
  detect-changes:
    name: Detect Changed Environments
    runs-on: ubuntu-latest
    outputs:
      staging: ${{ steps.changes.outputs.staging }}
      production: ${{ steps.changes.outputs.production }}
      modules: ${{ steps.changes.outputs.modules }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect changes
        id: changes
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            # Manual trigger - deploy specified environment
            if [ "${{ inputs.environment }}" = "staging" ]; then
              echo "staging=true" >> "$GITHUB_OUTPUT"
              echo "production=false" >> "$GITHUB_OUTPUT"
            else
              echo "staging=false" >> "$GITHUB_OUTPUT"
              echo "production=true" >> "$GITHUB_OUTPUT"
            fi
            echo "modules=false" >> "$GITHUB_OUTPUT"
          else
            # Automatic trigger - detect changed files
            BASE_SHA="${{ github.event.pull_request.base.sha || github.event.before }}"
            HEAD_SHA="${{ github.sha }}"
            
            CHANGED_FILES=$(git diff --name-only $BASE_SHA $HEAD_SHA 2>/dev/null || echo "")
            
            if echo "$CHANGED_FILES" | grep -q "infra/terraform/environments/staging"; then
              echo "staging=true" >> "$GITHUB_OUTPUT"
            else
              echo "staging=false" >> "$GITHUB_OUTPUT"
            fi
            
            if echo "$CHANGED_FILES" | grep -q "infra/terraform/environments/production"; then
              echo "production=true" >> "$GITHUB_OUTPUT"
            else
              echo "production=false" >> "$GITHUB_OUTPUT"
            fi
            
            if echo "$CHANGED_FILES" | grep -q "infra/terraform/modules"; then
              echo "modules=true" >> "$GITHUB_OUTPUT"
            else
              echo "modules=false" >> "$GITHUB_OUTPUT"
            fi
          fi

  terraform-staging:
    name: Terraform Staging
    runs-on: ubuntu-latest
    needs: detect-changes
    if: |
      needs.detect-changes.outputs.staging == 'true' ||
      needs.detect-changes.outputs.modules == 'true' ||
      github.event.inputs.environment == 'staging'
    permissions:
      id-token: write
      contents: read
      pull-requests: write
    defaults:
      run:
        working-directory: infra/terraform/environments/staging
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Azure Login via OIDC
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Terraform Init
        id: init
        run: terraform init -input=false

      - name: Terraform Validate
        id: validate
        run: terraform validate -no-color

      - name: Terraform Plan
        id: plan
        run: |
          terraform plan -no-color -input=false -out=tfplan 2>&1 | tee plan_output.txt
          echo "plan_output<<EOF" >> "$GITHUB_OUTPUT"
          cat plan_output.txt >> "$GITHUB_OUTPUT"
          echo "EOF" >> "$GITHUB_OUTPUT"
        continue-on-error: true

      - name: Post Plan to PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const planOutput = `${{ steps.plan.outputs.plan_output }}`;
            const truncatedPlan = planOutput.length > 60000 
              ? planOutput.substring(0, 60000) + '\n\n... (truncated)'
              : planOutput;
            
            const body = `### üèóÔ∏è Terraform Plan - Staging
            
            #### Initialization: \`${{ steps.init.outcome }}\`
            #### Validation: \`${{ steps.validate.outcome }}\`
            #### Plan: \`${{ steps.plan.outcome }}\`
            
            <details><summary>Show Plan Output</summary>
            
            \`\`\`hcl
            ${truncatedPlan}
            \`\`\`
            
            </details>
            
            *Pushed by: @${{ github.actor }}, Action: \`${{ github.event_name }}\`*`;
            
            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: body
            });

      - name: Plan Status
        if: steps.plan.outcome == 'failure'
        run: exit 1

      - name: Terraform Apply
        if: |
          (github.ref == 'refs/heads/main' && github.event_name == 'push') ||
          (github.event.inputs.action == 'apply')
        run: terraform apply -auto-approve tfplan

      - name: Terraform Destroy
        if: github.event.inputs.action == 'destroy'
        run: terraform destroy -auto-approve

  terraform-production:
    name: Terraform Production
    runs-on: ubuntu-latest
    needs: [detect-changes, terraform-staging]
    if: |
      always() &&
      (needs.terraform-staging.result == 'success' || needs.terraform-staging.result == 'skipped') &&
      (needs.detect-changes.outputs.production == 'true' ||
       needs.detect-changes.outputs.modules == 'true' ||
       github.event.inputs.environment == 'production')
    environment: production
    permissions:
      id-token: write
      contents: read
      pull-requests: write
    defaults:
      run:
        working-directory: infra/terraform/environments/production
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Azure Login via OIDC
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Terraform Init
        id: init
        run: terraform init -input=false

      - name: Terraform Validate
        id: validate
        run: terraform validate -no-color

      - name: Terraform Plan
        id: plan
        run: |
          terraform plan -no-color -input=false -out=tfplan 2>&1 | tee plan_output.txt
          echo "plan_output<<EOF" >> "$GITHUB_OUTPUT"
          cat plan_output.txt >> "$GITHUB_OUTPUT"
          echo "EOF" >> "$GITHUB_OUTPUT"
        continue-on-error: true

      - name: Post Plan to PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const planOutput = `${{ steps.plan.outputs.plan_output }}`;
            const truncatedPlan = planOutput.length > 60000 
              ? planOutput.substring(0, 60000) + '\n\n... (truncated)'
              : planOutput;
            
            const body = `### üèóÔ∏è Terraform Plan - Production
            
            #### Initialization: \`${{ steps.init.outcome }}\`
            #### Validation: \`${{ steps.validate.outcome }}\`
            #### Plan: \`${{ steps.plan.outcome }}\`
            
            <details><summary>Show Plan Output</summary>
            
            \`\`\`hcl
            ${truncatedPlan}
            \`\`\`
            
            </details>
            
            *Pushed by: @${{ github.actor }}, Action: \`${{ github.event_name }}\`*`;
            
            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: body
            });

      - name: Plan Status
        if: steps.plan.outcome == 'failure'
        run: exit 1

      - name: Terraform Apply
        if: |
          (github.ref == 'refs/heads/main' && github.event_name == 'push') ||
          (github.event.inputs.action == 'apply')
        run: terraform apply -auto-approve tfplan

      - name: Terraform Destroy
        if: github.event.inputs.action == 'destroy'
        run: terraform destroy -auto-approve

  summary:
    name: Infrastructure Summary
    runs-on: ubuntu-latest
    needs: [terraform-staging, terraform-production]
    if: always()
    steps:
      - name: Generate summary
        run: |
          echo "# üèóÔ∏è Infrastructure Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Environment | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Staging | ${{ needs.terraform-staging.result == 'success' && '‚úÖ Success' || (needs.terraform-staging.result == 'skipped' && '‚è≠Ô∏è Skipped' || '‚ùå Failed') }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Production | ${{ needs.terraform-production.result == 'success' && '‚úÖ Success' || (needs.terraform-production.result == 'skipped' && '‚è≠Ô∏è Skipped' || '‚ùå Failed') }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Triggered by: @${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
