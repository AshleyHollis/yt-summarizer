name: 'Create CI Summary'
description: 'Creates a rich GitHub step summary with test results, timings, and change detection'

inputs:
  changed-areas:
    description: 'Space-separated list of changed areas'
    required: true
  commit-sha:
    description: 'Git commit SHA'
    required: true
  pr-number:
    description: 'Pull request number (empty for push to main)'
    required: false
    default: ''
  # Lint results
  lint-python-result:
    description: 'Result of lint-python job'
    required: false
    default: 'skipped'
  lint-frontend-result:
    description: 'Result of lint-frontend job'
    required: false
    default: 'skipped'
  # Security results
  scan-python-security-result:
    description: 'Result of scan-python-security job'
    required: false
    default: 'skipped'
  scan-javascript-security-result:
    description: 'Result of scan-javascript-security job'
    required: false
    default: 'skipped'
  secret-scanning-result:
    description: 'Result of secret-scanning job'
    required: false
    default: 'skipped'
  # Test results with metadata
  test-shared-result:
    description: 'Result of test-shared job'
    required: false
    default: 'skipped'
  test-shared-duration:
    description: 'Duration of test-shared job'
    required: false
    default: ''
  test-api-result:
    description: 'Result of test-api job'
    required: false
    default: 'skipped'
  test-api-duration:
    description: 'Duration of test-api job'
    required: false
    default: ''
  test-workers-result:
    description: 'Result of test-workers job'
    required: false
    default: 'skipped'
  test-workers-duration:
    description: 'Duration of test-workers job'
    required: false
    default: ''
  test-frontend-result:
    description: 'Result of test-frontend job'
    required: false
    default: 'skipped'
  # Validation results
  kubernetes-validate-result:
    description: 'Result of kubernetes-validate job'
    required: false
    default: 'skipped'
  validate-kustomize-result:
    description: 'Result of validate-kustomize job'
    required: false
    default: 'skipped'
  validate-terraform-result:
    description: 'Result of validate-terraform job'
    required: false
    default: 'skipped'
  # Build results
  build-images-result:
    description: 'Result of build-images job'
    required: false
    default: 'skipped'
  image-tag:
    description: 'Docker image tag generated'
    required: false
    default: ''
  # Repository info
  repository:
    description: 'GitHub repository (owner/repo)'
    required: true
  run-id:
    description: 'GitHub Actions run ID'
    required: true

runs:
  using: composite
  steps:
    - name: Generate CI Summary
      shell: bash
      run: |
        # Helper to format job status
        format_status() {
          case "$1" in
            "success") echo "âœ… Passed" ;;
            "failure") echo "âŒ Failed" ;;
            "skipped") echo "â­ï¸ Skipped" ;;
            "cancelled") echo "ðŸš« Cancelled" ;;
            *) echo "â“ Unknown" ;;
          esac
        }

        # Helper to format duration
        format_duration() {
          if [ -n "$1" ] && [ "$1" != "" ]; then
            echo "$1"
          else
            echo "-"
          fi
        }

        # Determine overall status
        OVERALL_STATUS="âœ… Success"
        HAS_FAILURES=false

        for result in "${{ inputs.lint-python-result }}" "${{ inputs.lint-frontend-result }}" \
                      "${{ inputs.scan-python-security-result }}" "${{ inputs.scan-javascript-security-result }}" \
                      "${{ inputs.test-shared-result }}" "${{ inputs.test-api-result }}" \
                      "${{ inputs.test-workers-result }}" "${{ inputs.test-frontend-result }}" \
                      "${{ inputs.kubernetes-validate-result }}" "${{ inputs.validate-kustomize-result }}" \
                      "${{ inputs.build-images-result }}"; do
          if [ "$result" = "failure" ]; then
            HAS_FAILURES=true
            OVERALL_STATUS="âŒ Failed"
            break
          fi
        done

        # Write summary header
        echo "# ðŸ”§ CI Pipeline Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        # Meta information
        echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
        echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
        echo "| **Status** | $OVERALL_STATUS |" >> $GITHUB_STEP_SUMMARY
        if [ -n "${{ inputs.pr-number }}" ]; then
          echo "| **Pull Request** | [#${{ inputs.pr-number }}](https://github.com/${{ inputs.repository }}/pull/${{ inputs.pr-number }}) |" >> $GITHUB_STEP_SUMMARY
        fi
        echo "| **Commit** | \`${{ inputs.commit-sha }}\` |" >> $GITHUB_STEP_SUMMARY
        if [ -n "${{ inputs.image-tag }}" ]; then
          echo "| **Image Tag** | \`${{ inputs.image-tag }}\` |" >> $GITHUB_STEP_SUMMARY
        fi
        echo "" >> $GITHUB_STEP_SUMMARY

        # Changed areas section
        echo "## ðŸ“ Changes Detected" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        AREAS="${{ inputs.changed-areas }}"
        if [ -z "$AREAS" ]; then
          echo "_No changes detected_" >> $GITHUB_STEP_SUMMARY
        else
          for area in $AREAS; do
            case "$area" in
              "services/api") echo "- ðŸ **API Service** (\`services/api/\`)" >> $GITHUB_STEP_SUMMARY ;;
              "services/workers") echo "- âš™ï¸ **Workers** (\`services/workers/\`)" >> $GITHUB_STEP_SUMMARY ;;
              "services/shared") echo "- ðŸ“¦ **Shared Package** (\`services/shared/\`)" >> $GITHUB_STEP_SUMMARY ;;
              "apps/web") echo "- ðŸŒ **Frontend** (\`apps/web/\`)" >> $GITHUB_STEP_SUMMARY ;;
              "k8s") echo "- â˜¸ï¸ **Kubernetes** (\`k8s/\`)" >> $GITHUB_STEP_SUMMARY ;;
              "infra/terraform") echo "- ðŸ—ï¸ **Terraform** (\`infra/terraform/\`)" >> $GITHUB_STEP_SUMMARY ;;
              "docker") echo "- ðŸ³ **Docker** (\`docker/\`)" >> $GITHUB_STEP_SUMMARY ;;
              ".github") echo "- ðŸ”„ **CI/CD** (\`.github/\`)" >> $GITHUB_STEP_SUMMARY ;;
              *) echo "- ðŸ“„ \`$area\`" >> $GITHUB_STEP_SUMMARY ;;
            esac
          done
        fi
        echo "" >> $GITHUB_STEP_SUMMARY

        # Linting section
        echo "## ðŸ§¹ Linting" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
        echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
        echo "| Python (ruff) | $(format_status '${{ inputs.lint-python-result }}') |" >> $GITHUB_STEP_SUMMARY
        echo "| Frontend (ESLint) | $(format_status '${{ inputs.lint-frontend-result }}') |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        # Security section
        echo "## ðŸ”’ Security" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Scan | Status |" >> $GITHUB_STEP_SUMMARY
        echo "|------|--------|" >> $GITHUB_STEP_SUMMARY
        echo "| Python (bandit/pip-audit) | $(format_status '${{ inputs.scan-python-security-result }}') |" >> $GITHUB_STEP_SUMMARY
        echo "| JavaScript (npm audit) | $(format_status '${{ inputs.scan-javascript-security-result }}') |" >> $GITHUB_STEP_SUMMARY
        echo "| Secrets (gitleaks) | $(format_status '${{ inputs.secret-scanning-result }}') |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        # Testing section
        echo "## ðŸ§ª Tests" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Test Suite | Status | Duration |" >> $GITHUB_STEP_SUMMARY
        echo "|------------|--------|----------|" >> $GITHUB_STEP_SUMMARY
        echo "| Shared Package | $(format_status '${{ inputs.test-shared-result }}') | $(format_duration '${{ inputs.test-shared-duration }}') |" >> $GITHUB_STEP_SUMMARY
        echo "| API Service | $(format_status '${{ inputs.test-api-result }}') | $(format_duration '${{ inputs.test-api-duration }}') |" >> $GITHUB_STEP_SUMMARY
        echo "| Workers | $(format_status '${{ inputs.test-workers-result }}') | $(format_duration '${{ inputs.test-workers-duration }}') |" >> $GITHUB_STEP_SUMMARY
        echo "| Frontend | $(format_status '${{ inputs.test-frontend-result }}') | - |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        # Validation section
        echo "## âœ… Validation" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
        echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
        echo "| Kubernetes Manifests | $(format_status '${{ inputs.kubernetes-validate-result }}') |" >> $GITHUB_STEP_SUMMARY
        echo "| Kustomize Overlays | $(format_status '${{ inputs.validate-kustomize-result }}') |" >> $GITHUB_STEP_SUMMARY
        echo "| Terraform | $(format_status '${{ inputs.validate-terraform-result }}') |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        # Build section
        if [ -n "${{ inputs.image-tag }}" ] || [ "${{ inputs.build-images-result }}" != "skipped" ]; then
          echo "## ðŸ³ Docker Images" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Build | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Build & Push | $(format_status '${{ inputs.build-images-result }}') |" >> $GITHUB_STEP_SUMMARY
          if [ -n "${{ inputs.image-tag }}" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Images built:**" >> $GITHUB_STEP_SUMMARY
            echo "- \`acrytsummprd.azurecr.io/yt-summarizer-api:${{ inputs.image-tag }}\`" >> $GITHUB_STEP_SUMMARY
            echo "- \`acrytsummprd.azurecr.io/yt-summarizer-workers:${{ inputs.image-tag }}\`" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
        fi

        # Links section
        echo "## ðŸ”— Links" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- [View Workflow Run](https://github.com/${{ inputs.repository }}/actions/runs/${{ inputs.run-id }})" >> $GITHUB_STEP_SUMMARY
        if [ -n "${{ inputs.pr-number }}" ]; then
          echo "- [View Pull Request](https://github.com/${{ inputs.repository }}/pull/${{ inputs.pr-number }})" >> $GITHUB_STEP_SUMMARY
        fi
        echo "" >> $GITHUB_STEP_SUMMARY
