name: Manage Kustomization
description: |
  Unified action for updating and committing Kubernetes kustomization overlays (preview/prod)

  IMPORTANT: This action uses different input parameters for different operations:
  - Preview operations: Uses pr-number to auto-generate overlay path (k8s/overlays/preview-pr-{number})
  - Production operations: Uses kustomization-path to specify overlay directory

  Both operations set OVERLAY_PATH environment variable for validation and commit scripts.

inputs:
  operation:
    description: 'Operation mode: update-preview|update-prod|commit-only'
    required: true

  # Common inputs
  image-tag:
    description: 'Docker image tag to deploy'
    required: false

  # Preview-specific inputs
  pr-number:
    description: 'Pull request number (for preview)'
    required: false
  acr-server:
    description: 'Azure Container Registry server (for preview)'
    required: false
  preview-host:
    description: 'Preview environment hostname (for preview)'
    required: false
  tls-secret:
    description: 'TLS secret name (for preview)'
    required: false
  preview-url:
    description: 'Full preview URL (for preview)'
    required: false
  commit-sha:
    description: 'Commit SHA (for preview and commit operations)'
    required: false

  # Production-specific inputs
  kustomization-path:
    description: 'Path to kustomization overlay directory (for prod and commit-only)'
    required: false
    default: 'k8s/overlays/prod'
  template-path:
    description: 'Path to kustomization template (for prod)'
    required: false
    default: 'scripts/ci/templates/prod-kustomization-template.yaml'

  # Commit-specific inputs
  file-path:
    description: 'Path to file to commit (for commit-only)'
    required: false
  commit-message:
    description: 'Custom commit message (for commit-only)'
    required: false
  git-branch:
    description: 'Branch to push to (for commit-only and prod)'
    required: false
    default: 'main'
  pr-branch:
    description: 'PR branch name (for preview commit)'
    required: false

  auto-commit:
    description: 'Automatically commit and push changes'
    required: false
    default: 'true'

outputs:
  preview_url:
    description: 'Preview environment URL (preview only)'
    value: ${{ steps.update-preview.outputs.preview_url }}
  preview_host:
    description: 'Preview environment host (preview only)'
    value: ${{ steps.update-preview.outputs.preview_host }}
  tls_secret:
    description: 'TLS secret name (preview only)'
    value: ${{ steps.update-preview.outputs.tls_secret }}
  committed:
    description: 'Whether changes were committed (true/false)'
    value: ${{ steps.commit.outputs.committed || 'false' }}

runs:
  using: composite
  steps:
    # Preview operation: Generate preview overlay
    - name: Update preview overlay
      id: update-preview
      if: inputs.operation == 'update-preview'
      shell: bash
      env:
        PR_NUMBER: ${{ inputs.pr-number }}
        IMAGE_TAG: ${{ inputs.image-tag }}
        ACR_SERVER: ${{ inputs.acr-server }}
        PREVIEW_HOST: ${{ inputs.preview-host }}
        TLS_SECRET: ${{ inputs.tls-secret }}
        PREVIEW_URL: ${{ inputs.preview-url }}
        COMMIT_SHA: ${{ inputs.commit-sha }}
        OVERLAY_PATH: k8s/overlays/preview-pr-${{ inputs.pr-number }}
      run: |
        # Validate inputs
        if [ -z "$IMAGE_TAG" ]; then
          echo "::error::image-tag is required for update-preview operation"
          exit 1
        fi

        # Generate preview overlay
        bash ${{ github.action_path }}/update-preview.sh

        # Set outputs
        echo "preview_url=$PREVIEW_URL" >> "$GITHUB_OUTPUT"
        echo "preview_host=$PREVIEW_HOST" >> "$GITHUB_OUTPUT"
        echo "tls_secret=$TLS_SECRET" >> "$GITHUB_OUTPUT"

    # Production operation: Update prod kustomization
    - name: Update production kustomization
      if: inputs.operation == 'update-prod'
      shell: bash
      env:
        IMAGE_TAG: ${{ inputs.image-tag }}
        KUSTOMIZATION_PATH: ${{ inputs.kustomization-path }}
        TEMPLATE_PATH: ${{ inputs.template-path }}
      run: |
        if [ -z "$IMAGE_TAG" ]; then
          echo "::error::image-tag is required for update-prod operation"
          exit 1
        fi

        bash ${{ github.action_path }}/update-prod.sh

    # Validate generated overlay before committing
    # This catches kustomize errors early, regardless of which branch the overlay lives on
    - name: Validate generated overlay
      shell: bash
      env:
        OVERLAY_PATH: ${{ inputs.operation == 'update-preview' && format('k8s/overlays/preview-pr-{0}', inputs.pr-number) || inputs.kustomization-path }}
      run: |
        echo "ðŸ” Validating overlay at ${OVERLAY_PATH}..."

        if [ ! -f "${OVERLAY_PATH}/kustomization.yaml" ]; then
          echo "::error::Overlay file not found at ${OVERLAY_PATH}/kustomization.yaml"
          exit 1
        fi

        # Validate kustomize build
        if ! kustomize build "${OVERLAY_PATH}" > /dev/null 2>&1; then
          echo "::error::Kustomize build failed for ${OVERLAY_PATH}"
          kustomize build "${OVERLAY_PATH}"  # Show the error
          exit 1
        fi

        echo "âœ… Overlay validation passed"

    # Commit operation (all modes if auto-commit enabled)
    - name: Commit and push changes
      id: commit
      if: inputs.auto-commit == 'true'
      shell: bash
      env:
        OPERATION: ${{ inputs.operation }}
        FILE_PATH: ${{ inputs.file-path }}
        COMMIT_MESSAGE: ${{ inputs.commit-message }}
        GIT_BRANCH: ${{ inputs.git-branch }}
        PR_BRANCH: ${{ inputs.pr-branch }}
        PR_NUMBER: ${{ inputs.pr-number }}
        IMAGE_TAG: ${{ inputs.image-tag }}
        COMMIT_SHA: ${{ inputs.commit-sha }}
        # For preview: use PR-specific path; for prod: use kustomization-path
        OVERLAY_PATH: ${{ inputs.operation == 'update-preview' && format('k8s/overlays/preview-pr-{0}', inputs.pr-number) || inputs.kustomization-path }}
        KUSTOMIZATION_PATH: ${{ inputs.kustomization-path }}
      run: bash ${{ github.action_path }}/commit-changes.sh
