#!/bin/bash
# Unified commit script for kustomization changes
# Handles preview, prod, and generic commit operations

set -euo pipefail

# Determine what to commit based on operation
case "$OPERATION" in
  update-preview)
    FILE_TO_COMMIT="${OVERLAY_PATH:-k8s/overlays/preview}/kustomization.yaml"
    BRANCH="${PR_BRANCH}"
    MESSAGE="ci(preview): update overlay for PR #${PR_NUMBER} with image ${IMAGE_TAG}

- Image: ${IMAGE_TAG}
- Commit: ${COMMIT_SHA:0:7}
- Auto-generated by GitHub Actions"
    ;;

  update-prod)
    FILE_TO_COMMIT="${KUSTOMIZATION_PATH}/kustomization.yaml"
    BRANCH="${GIT_BRANCH}"
    MESSAGE="ci(prod): update kustomization with image ${IMAGE_TAG}

- Image: ${IMAGE_TAG}
- Auto-generated by GitHub Actions"
    ;;

  commit-only)
    FILE_TO_COMMIT="${FILE_PATH}"
    BRANCH="${GIT_BRANCH}"
    MESSAGE="${COMMIT_MESSAGE}"
    ;;

  *)
    echo "::error::Invalid operation: $OPERATION"
    exit 1
    ;;
esac

echo "ðŸ“ Committing changes..."
echo "  File: $FILE_TO_COMMIT"
echo "  Branch: $BRANCH"

# Check if file exists
if [ ! -f "$FILE_TO_COMMIT" ]; then
  echo "::error::File not found: $FILE_TO_COMMIT"
  exit 1
fi

# Configure git
git config user.name "github-actions[bot]"
git config user.email "github-actions[bot]@users.noreply.github.com"

# Check if there are changes
if git diff --quiet "$FILE_TO_COMMIT"; then
  echo "â„¹ï¸  No changes to commit"
  echo "committed=false" >> "$GITHUB_OUTPUT"
  exit 0
fi

# Add and commit
git add "$FILE_TO_COMMIT"
git commit -m "$MESSAGE"

# Handle detached HEAD - checkout branch if needed
if ! git symbolic-ref HEAD > /dev/null 2>&1; then
  echo "â„¹ï¸  Detached HEAD detected, checking out branch..."
  git checkout -B "$BRANCH"
fi

echo "ðŸš€ Pushing to $BRANCH..."
git push origin "HEAD:$BRANCH"

echo "âœ… Changes committed and pushed"
echo "committed=true" >> "$GITHUB_OUTPUT"
