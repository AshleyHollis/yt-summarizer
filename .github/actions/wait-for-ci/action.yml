name: Wait for CI Workflow
description: Wait for CI workflow to complete successfully before proceeding with deployment

inputs:
  github-token:
    description: GitHub token for API access
    required: true
  commit-sha:
    description: Commit SHA to check
    required: true
  timeout-seconds:
    description: Maximum time to wait in seconds
    required: false
    default: '1800'
  interval-seconds:
    description: Interval between checks in seconds
    required: false
    default: '30'

runs:
  using: composite
  steps:
    - name: Wait for CI workflow (exit early on failure)
      shell: bash
      run: |
        # Exit early on CI failure to avoid wasting CPU cycles
        # This polls GitHub API and stops immediately when CI concludes with failure/cancelled

        GITHUB_TOKEN="${{ inputs.github-token }}"
        COMMIT_SHA="${{ inputs.commit-sha }}"
        TIMEOUT_SECONDS="${{ inputs.timeout-seconds }}"
        INTERVAL_SECONDS="${{ inputs.interval-seconds }}"

        echo "‚è≥ Waiting for CI workflow to complete..."
        echo "   Commit: $COMMIT_SHA"
        echo "   Timeout: $TIMEOUT_SECONDS seconds"
        echo "   Check interval: $INTERVAL_SECONDS seconds"

        start_time=$(date +%s)
        end_time=$((start_time + TIMEOUT_SECONDS))
        attempt=1

        while [ $(date +%s) -lt $end_time ]; do
          current_time=$(date +%s)
          elapsed=$((current_time - start_time))
          echo "üîç [$(date '+%H:%M:%S')] Attempt $attempt (elapsed: ${elapsed}s) - Checking CI status..."

          # Get CI workflow runs for this commit (remove event filter to catch all triggers)
          response=$(curl -s -H "Authorization: token $GITHUB_TOKEN" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/$GITHUB_REPOSITORY/actions/runs?head_sha=$COMMIT_SHA")

          # Debug: Show total workflow runs found
          total_runs=$(echo "$response" | jq -r '.total_count // 0')
          echo "   üìä Found $total_runs total workflow runs for commit $COMMIT_SHA"

          # Extract CI workflow run (filter by workflow name "CI")
          ci_run=$(echo "$response" | jq -r '.workflow_runs[] | select(.name == "CI") | .id' | head -1)
          if [ -z "$ci_run" ]; then
            echo "   ‚ùå No CI workflow run found yet for commit $COMMIT_SHA"
          else
            ci_status=$(echo "$response" | jq -r ".workflow_runs[] | select(.id == ($ci_run | tonumber)) | .status")
            ci_conclusion=$(echo "$response" | jq -r ".workflow_runs[] | select(.id == ($ci_run | tonumber)) | .conclusion")
            echo "   üîó CI Run ID: $ci_run | Status: $ci_status | Conclusion: $ci_conclusion"

            if [ "$ci_status" = "completed" ]; then
              if [ "$ci_conclusion" = "success" ]; then
                echo "‚úÖ CI workflow completed successfully (took ${elapsed}s)"
                exit 0
              elif [ "$ci_conclusion" = "failure" ]; then
                echo "::error::CI workflow failed. Stopping preview deployment."
                exit 1
              elif [ "$ci_conclusion" = "cancelled" ]; then
                echo "::error::CI workflow was cancelled. Stopping preview deployment."
                exit 1
              else
                echo "::error::CI workflow completed with unexpected conclusion: $ci_conclusion"
                exit 1
              fi
            fi
          fi

          # Wait before next check
          attempt=$((attempt + 1))
          sleep $INTERVAL_SECONDS
        done

        echo "::error::Timeout waiting for CI workflow to complete after $TIMEOUT_SECONDS seconds"
        exit 1
