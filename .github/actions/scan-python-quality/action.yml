# Scan Python Code Quality
# Runs comprehensive Python code quality checks
# Uses: ruff (linting), mypy (type checking), bandit (security)

name: 'Scan Python Code Quality'
description: 'Run comprehensive Python code quality and security scans'

inputs:
  service-path:
    description: 'Path to the service directory (e.g., services/api)'
    required: true
  check-types:
    description: 'Run mypy type checking'
    required: false
    default: 'false'
  check-security:
    description: 'Run bandit security scanning'
    required: false
    default: 'true'
  ruff-config:
    description: 'Path to ruff configuration file'
    required: false
    default: 'services/ruff.toml'

runs:
  using: 'composite'
  steps:
    - name: Install code quality tools
      shell: bash
      run: |
        pip install bandit[toml] mypy

    - name: Run Bandit security scan
      if: inputs.check-security == 'true'
      shell: bash
      working-directory: ${{ inputs.service-path }}
      run: |
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo "ğŸ”’ Python Security Scan (bandit)"
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo ""
        
        # Auto-detect source directory
        if [ -d "src" ]; then
          SCAN_DIR="src"
        else
          SCAN_DIR="."
        fi
        
        echo "ğŸ“ Scanning directory: $SCAN_DIR"
        echo ""
        
        if bandit -r "$SCAN_DIR" -f screen; then
          echo ""
          echo "âœ… No security issues detected"
        else
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "âš ï¸  SECURITY ISSUES DETECTED"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "ğŸ“‹ Action Required:"
          echo "   Review the security findings above and address concerns"
          echo "   Common issues: hardcoded secrets, SQL injection, weak crypto"
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          exit 1
        fi

    - name: Run mypy type checking
      if: inputs.check-types == 'true'
      shell: bash
      working-directory: ${{ inputs.service-path }}
      continue-on-error: true
      run: |
        echo "ğŸ” Running mypy type checking..."
        mypy src/ --ignore-missing-imports || {
          echo "âš ï¸  Type checking issues detected"
          exit 1
        }

    - name: Verify ruff passes
      shell: bash
      working-directory: ${{ inputs.service-path }}
      run: |
        echo "âœ¨ Verifying ruff linting..."
        ruff check src/ --config=${{ inputs.ruff-config }}

    - name: Summary
      shell: bash
      run: |
        echo "âœ… Code quality scan complete"
