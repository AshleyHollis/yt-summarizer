name: Post Preview Comment
description: Post or update comprehensive preview environment comment on PR

inputs:
  github-token:
    description: GitHub token for API access
    required: true
  pr-number:
    description: Pull request number
    required: true
  preview-url:
    description: Preview environment URL
    required: true
  image-tag:
    description: Docker image tag deployed
    required: true
  commit-sha:
    description: Commit SHA deployed
    required: true
  frontend-url:
    description: Frontend preview URL
    required: false
    default: ''
  run-id:
    description: GitHub Actions run ID for linking
    required: false
    default: ''
  repository:
    description: GitHub repository (owner/repo)
    required: false
    default: ''

runs:
  using: composite
  steps:
    - name: Post/update PR comment
      uses: actions/github-script@v7
      with:
        github-token: ${{ inputs.github-token }}
        script: |
          const previewUrl = '${{ inputs.preview-url }}';
          const frontendUrl = '${{ inputs.frontend-url }}';
          const imageTag = '${{ inputs.image-tag }}';
          const commitSha = '${{ inputs.commit-sha }}';
          const runId = '${{ inputs.run-id }}' || context.runId;
          const repo = '${{ inputs.repository }}' || `${context.repo.owner}/${context.repo.repo}`;

          const body = `## ğŸš€ Preview Environment Deployed\n\n` +
            `### ğŸŒ Environment URLs\n\n` +
            `| Environment | URL |\n` +
            `|-------------|-----|\n` +
            `| **ğŸ”Œ Backend API** | [${previewUrl}](${previewUrl}) |\n` +
            (frontendUrl ? `| **ğŸ–¥ï¸ Frontend App** | [${frontendUrl}](${frontendUrl}) |\n` : '') +
            `| **â¤ï¸ Health Check** | [${previewUrl}/health/live](${previewUrl}/health/live) |\n` +
            `| **ğŸ“– API Docs** | [${previewUrl}/docs](${previewUrl}/docs) |\n\n` +
            `### ğŸ“¦ Deployment Details\n\n` +
            `| Property | Value |\n` +
            `|----------|-------|\n` +
            `| **Image Tag** | \`${imageTag}\` |\n` +
            `| **Commit** | [\`${commitSha.substring(0, 7)}\`](https://github.com/${repo}/commit/${commitSha}) |\n` +
            `| **Workflow Run** | [View Logs](https://github.com/${repo}/actions/runs/${runId}) |\n\n` +
            `### ğŸ”— Quick Actions\n\n` +
            `<details>\n` +
            `<summary>ğŸ§ª Test Commands</summary>\n\n` +
            `\`\`\`bash\n` +
            `# Test API health\n` +
            `curl -s ${previewUrl}/health/live | jq\n\n` +
            `# Test API readiness\n` +
            `curl -s ${previewUrl}/health/ready | jq\n\n` +
            `# List videos\n` +
            `curl -s ${previewUrl}/api/videos | jq\n` +
            `\`\`\`\n` +
            `</details>\n\n` +
            `<details>\n` +
            `<summary>â˜¸ï¸ Kubernetes Commands</summary>\n\n` +
            `\`\`\`bash\n` +
            `# View preview pods\n` +
            `kubectl get pods -n preview-pr-${{ inputs.pr-number }}\n\n` +
            `# View API logs\n` +
            `kubectl logs -n preview-pr-${{ inputs.pr-number }} -l app=api --tail=100\n\n` +
            `# View deployment status\n` +
            `kubectl get deployments -n preview-pr-${{ inputs.pr-number }}\n` +
            `\`\`\`\n` +
            `</details>\n\n` +
            `---\n` +
            `_This preview will be automatically cleaned up when the PR is closed or merged._`;

          // Find existing preview comment to update
          const { data: comments } = await github.rest.issues.listComments({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: ${{ inputs.pr-number }},
          });

          const previewComment = comments.find(c =>
            c.user.type === 'Bot' &&
            c.body.includes('Preview Environment Deployed')
          );

          if (previewComment) {
            await github.rest.issues.updateComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: previewComment.id,
              body: body
            });
            console.log('Updated existing preview comment');
          } else {
            await github.rest.issues.createComment({
              issue_number: ${{ inputs.pr-number }},
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });
            console.log('Created new preview comment');
          }

    - name: Create deployment summary
      shell: bash
      run: |
        echo "## ğŸš€ Preview Deployment Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ğŸŒ Environment URLs" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Environment | URL |" >> $GITHUB_STEP_SUMMARY
        echo "|-------------|-----|" >> $GITHUB_STEP_SUMMARY
        echo "| **Backend API** | [${{ inputs.preview-url }}](${{ inputs.preview-url }}) |" >> $GITHUB_STEP_SUMMARY
        if [ -n "${{ inputs.frontend-url }}" ]; then
          echo "| **Frontend** | [${{ inputs.frontend-url }}](${{ inputs.frontend-url }}) |" >> $GITHUB_STEP_SUMMARY
        fi
        echo "| **Health Check** | [${{ inputs.preview-url }}/health/live](${{ inputs.preview-url }}/health/live) |" >> $GITHUB_STEP_SUMMARY
        echo "| **API Docs** | [${{ inputs.preview-url }}/docs](${{ inputs.preview-url }}/docs) |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ğŸ“¦ Deployment Details" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
        echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
        echo "| **PR** | #${{ inputs.pr-number }} |" >> $GITHUB_STEP_SUMMARY
        echo "| **Image Tag** | \`${{ inputs.image-tag }}\` |" >> $GITHUB_STEP_SUMMARY
        echo "| **Commit** | \`${{ inputs.commit-sha }}\` |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
