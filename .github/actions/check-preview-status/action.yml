name: 'Check Preview Pipeline Status'
description: 'Validates preview pipeline results and creates status summary'
inputs:
  needs-image-build:
    description: 'Whether PR needs image build (true/false)'
    required: true
  needs-deployment:
    description: 'Whether PR needs deployment (true/false)'
    required: true
  update-overlay-result:
    description: 'Result of update-overlay job'
    required: true
  verify-deployment-result:
    description: 'Result of verify-deployment job'
    required: true
  deploy-frontend-result:
    description: 'Result of deploy-frontend-preview job'
    required: true
  e2e-tests-result:
    description: 'Result of e2e-tests job'
    required: true
  api-url-configured:
    description: 'Whether API URL is configured'
    required: false
    default: ''
  wait-for-ci-result:
    description: 'Result of wait-for-ci job'
    required: false
    default: ''
runs:
  using: composite
  steps:
    - name: Check preview pipeline status
      shell: bash
      env:
        API_URL_CONFIGURED: ${{ inputs.api-url-configured }}
      run: |
        echo "## Preview Pipeline Status" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        # If no deployment needed, mark as success (docs-only PR)
        if [ "${{ inputs.needs-deployment }}" != "true" ]; then
          echo "ðŸ“ No deployment needed - docs-only PR" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Detect Changes | âœ… No deployment needed |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Preview pipeline completed successfully!" >> $GITHUB_STEP_SUMMARY
          exit 0
        fi

        # Track if any critical jobs failed
        HAS_FAILURES=false

        # Check Wait for CI status (critical if images need to be built)
        if [ "${{ inputs.needs-image-build }}" = "true" ]; then
          if [ "${{ inputs.wait-for-ci-result }}" != "success" ]; then
            echo "::error::CI workflow failed - cannot proceed with deployment"
            HAS_FAILURES=true
          fi
        fi

        # Check required deployment jobs
        if [ "${{ inputs.update-overlay-result }}" != "success" ] && [ "${{ inputs.update-overlay-result }}" != "skipped" ]; then
          echo "::error::Update overlay failed"
          HAS_FAILURES=true
        fi

        if [ "${{ inputs.verify-deployment-result }}" != "success" ] && [ "${{ inputs.verify-deployment-result }}" != "skipped" ]; then
          echo "::error::Deployment verification failed"
          HAS_FAILURES=true
        fi

        if [ "${{ inputs.deploy-frontend-result }}" != "success" ] && [ "${{ inputs.deploy-frontend-result }}" != "skipped" ]; then
          echo "::error::Frontend deployment failed"
          HAS_FAILURES=true
        fi

        # Determine E2E test status display
        E2E_RESULT="${{ inputs.e2e-tests-result }}"
        if [ -z "$API_URL_CONFIGURED" ]; then
          E2E_STATUS="â­ï¸ Skipped (no API URL)"
          E2E_REQUIRED=false
        elif [ "$E2E_RESULT" = "success" ]; then
          E2E_STATUS="âœ… Passed"
          E2E_REQUIRED=false
        elif [ "$E2E_RESULT" = "skipped" ]; then
          E2E_STATUS="â­ï¸ Skipped"
          E2E_REQUIRED=false
        elif [ "$E2E_RESULT" = "failure" ]; then
          E2E_STATUS="âŒ Failed"
          E2E_REQUIRED=true
          echo "::error::E2E tests failed"
          HAS_FAILURES=true
        else
          E2E_STATUS="â­ï¸ Skipped"
          E2E_REQUIRED=false
        fi

        # Display status table
        echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
        echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY

        if [ "${{ inputs.needs-image-build }}" = "true" ]; then
          if [ "${{ inputs.wait-for-ci-result }}" = "success" ]; then
            echo "| Wait for CI | âœ… Success |" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ inputs.wait-for-ci-result }}" = "failure" ]; then
            echo "| Wait for CI | âŒ Failed |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Wait for CI | â­ï¸ Skipped |" >> $GITHUB_STEP_SUMMARY
          fi
        fi

        if [ "${{ inputs.update-overlay-result }}" = "success" ]; then
          echo "| Update Overlay | âœ… Success |" >> $GITHUB_STEP_SUMMARY
        elif [ "${{ inputs.update-overlay-result }}" = "failure" ]; then
          echo "| Update Overlay | âŒ Failed |" >> $GITHUB_STEP_SUMMARY
        else
          echo "| Update Overlay | â­ï¸ Skipped |" >> $GITHUB_STEP_SUMMARY
        fi

        if [ "${{ inputs.verify-deployment-result }}" = "success" ]; then
          echo "| Verify Deployment | âœ… Success |" >> $GITHUB_STEP_SUMMARY
        elif [ "${{ inputs.verify-deployment-result }}" = "failure" ]; then
          echo "| Verify Deployment | âŒ Failed |" >> $GITHUB_STEP_SUMMARY
        else
          echo "| Verify Deployment | â­ï¸ Skipped |" >> $GITHUB_STEP_SUMMARY
        fi

        if [ "${{ inputs.deploy-frontend-result }}" = "success" ]; then
          echo "| Deploy Frontend | âœ… Success |" >> $GITHUB_STEP_SUMMARY
        elif [ "${{ inputs.deploy-frontend-result }}" = "failure" ]; then
          echo "| Deploy Frontend | âŒ Failed |" >> $GITHUB_STEP_SUMMARY
        else
          echo "| Deploy Frontend | â­ï¸ Skipped |" >> $GITHUB_STEP_SUMMARY
        fi

        echo "| E2E Tests | ${E2E_STATUS} |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        # Fail the check if any critical jobs failed
        if [ "$HAS_FAILURES" = "true" ]; then
          echo "âŒ Preview pipeline failed!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Please check the errors above and fix the issues before deploying." >> $GITHUB_STEP_SUMMARY
          exit 1
        fi

        # Warning if no API URL configured
        if [ -z "$API_URL_CONFIGURED" ]; then
          echo "âš ï¸ Preview deployed without backend API" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "To enable full preview functionality:" >> $GITHUB_STEP_SUMMARY
          echo "1. Set \`PREVIEW_API_URL\` in repository variables" >> $GITHUB_STEP_SUMMARY
          echo "2. Re-run this workflow" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
        fi

        echo "âœ… Preview pipeline completed successfully!" >> $GITHUB_STEP_SUMMARY
