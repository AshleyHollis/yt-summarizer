# =============================================================================
# âš ï¸ DEPRECATED: This action does NOT actually delete SWA environments
# =============================================================================
# 
# PROBLEM: This action was sending repository_dispatch events that nothing
# listens to, creating false positive "cleanup succeeded" reports while
# zero environments were actually deleted in Azure.
#
# WHY IT DOESN'T WORK:
# - Azure SWA environments can only be deleted via:
#   1. Azure/static-web-apps-deploy action with action: close (requires PR context)
#   2. Manual deletion in Azure Portal
#   3. Azure SWA management API (requires different auth than deployment token)
#
# - We cannot call the deployment action for other PRs from this context
# - The deployment token does not work with the SWA management API
# - repository_dispatch events were sent but no workflow listened for them
#
# USE INSTEAD:
# - For detection: ./.github/actions/find-stale-prs
# - For deletion: Close the PR (triggers preview-cleanup.yml)
# - For manual cleanup: Azure Portal
#
# See: SWA-CLEANUP-REALITY-CHECK.md for full explanation
# =============================================================================

name: Cleanup Stale SWA Environments (DEPRECATED)
description: âš ï¸ DEPRECATED - Does NOT actually delete environments. Use find-stale-prs instead.

inputs:
  github-token:
    description: GitHub token for API access
    required: true
  swa-deployment-token:
    description: Azure Static Web Apps deployment token
    required: true
  dry-run:
    description: If true, only report what would be deleted without actually deleting
    required: false
    default: 'false'
  min-age-hours:
    description: Minimum age in hours before a closed PR environment is considered stale
    required: false
    default: '1'
  max-prs-to-check:
    description: Maximum number of closed PRs to check
    required: false
    default: '100'

outputs:
  deleted-count:
    description: Number of environments deleted
    value: ${{ steps.cleanup.outputs.deleted_count }}
  stale-prs:
    description: Comma-separated list of PR numbers with stale environments
    value: ${{ steps.cleanup.outputs.stale_prs }}

runs:
  using: composite
  steps:
    - name: Find stale environments
      id: find
      shell: bash
      env:
        GITHUB_TOKEN: ${{ inputs.github-token }}
        MIN_AGE_HOURS: ${{ inputs.min-age-hours }}
        MAX_PRS: ${{ inputs.max-prs-to-check }}
      run: |
        set -euo pipefail
        
        echo "ðŸ” Finding stale SWA staging environments..."
        echo "Min age: ${MIN_AGE_HOURS} hour(s)"
        
        # Get all open PRs
        open_prs=$(gh pr list --state open --json number --jq '.[].number' | tr '\n' ' ' || echo "")
        echo "ðŸ“‹ Currently open PRs: ${open_prs:-none}"
        
        # Create associative array of open PRs for fast lookup
        declare -A active_prs
        for pr in $open_prs; do
          active_prs[$pr]=1
        done
        
        # Get recently closed PRs
        echo "ðŸ“‹ Checking last ${MAX_PRS} closed PRs..."
        closed_prs=$(gh pr list --state closed --limit ${MAX_PRS} --json number,closedAt \
          --jq '.[] | select(.closedAt != null) | "\(.number)|\(.closedAt)"' || echo "")
        
        # Find stale PRs
        stale_prs=()
        current_time=$(date +%s)
        min_age_seconds=$((MIN_AGE_HOURS * 3600))
        
        while IFS='|' read -r pr_number closed_at; do
          [[ -z "$pr_number" ]] && continue
          
          # Skip if PR is still open
          if [[ -v active_prs[$pr_number] ]]; then
            continue
          fi
          
          # Calculate age
          closed_timestamp=$(date -d "$closed_at" +%s 2>/dev/null || date -j -f "%Y-%m-%dT%H:%M:%SZ" "$closed_at" +%s 2>/dev/null || echo "0")
          age_seconds=$((current_time - closed_timestamp))
          
          # Only include if older than minimum age
          if [[ $age_seconds -ge $min_age_seconds ]]; then
            age_hours=$((age_seconds / 3600))
            echo "  âœ“ PR #$pr_number - closed ${age_hours}h ago"
            stale_prs+=("$pr_number")
          fi
        done <<< "$closed_prs"
        
        # Output results
        stale_count=${#stale_prs[@]}
        echo "stale_count=$stale_count" >> $GITHUB_OUTPUT
        
        if [[ $stale_count -gt 0 ]]; then
          stale_list=$(IFS=,; echo "${stale_prs[*]}")
          echo "stale_prs=$stale_list" >> $GITHUB_OUTPUT
          echo ""
          echo "ðŸ—‘ï¸  Found $stale_count stale environment(s): $stale_list"
        else
          echo "stale_prs=" >> $GITHUB_OUTPUT
          echo "âœ… No stale environments found"
        fi

    - name: Delete stale environments
      id: cleanup
      if: steps.find.outputs.stale_count != '0'
      shell: bash
      env:
        GITHUB_TOKEN: ${{ inputs.github-token }}
        SWA_TOKEN: ${{ inputs.swa-deployment-token }}
        DRY_RUN: ${{ inputs.dry-run }}
        STALE_PRS: ${{ steps.find.outputs.stale_prs }}
        REPO: ${{ github.repository }}
      run: |
        set -euo pipefail
        
        deleted_count=0
        IFS=',' read -ra prs <<< "$STALE_PRS"
        
        echo ""
        echo "ðŸ—‘ï¸  Processing ${#prs[@]} stale environment(s)..."
        
        for pr in "${prs[@]}"; do
          [[ -z "$pr" ]] && continue
          
          if [[ "$DRY_RUN" == "true" ]]; then
            echo "  [DRY RUN] Would delete SWA environment for PR #$pr"
            deleted_count=$((deleted_count + 1))
          else
            echo "  ðŸ—‘ï¸  Attempting to close SWA environment for PR #$pr..."
            
            # Create a temporary directory for this PR's closure
            temp_dir=$(mktemp -d)
            cd "$temp_dir"
            
            # Clone just the specific PR branch
            if git clone --depth 1 --branch "refs/pull/$pr/head" "https://github.com/${REPO}.git" pr-${pr} 2>/dev/null; then
              cd pr-${pr}
              
              # Check if we can find the SWA config
              if [[ -f "apps/web/staticwebapp.config.json" ]] || [[ -f "staticwebapp.config.json" ]]; then
                echo "    Found SWA config, attempting closure..."
                
                # We need to use the Azure SWA deployment action's close functionality
                # But we can't call a GitHub Action from bash
                # Instead, we'll use the SWA management API directly
                
                # For now, mark as "needs manual cleanup" since we can't actually close it
                echo "    âš ï¸  Cannot close SWA environment from this context"
                echo "    ðŸ’¡ This PR's environment must be closed via PR close event or manual cleanup"
              fi
              
              cd ../..
              rm -rf "$temp_dir"
            else
              echo "    âš ï¸  PR branch no longer exists - environment may already be cleaned"
            fi
            
            # Note: We're not actually incrementing deleted_count because we can't actually delete
            echo "    âš ï¸  Marked for manual cleanup"
          fi
        done
        
        echo ""
        echo "deleted_count=$deleted_count" >> $GITHUB_OUTPUT
        echo "stale_prs=$STALE_PRS" >> $GITHUB_OUTPUT
        
        echo "âš ï¸  Pre-deployment cleanup cannot automatically delete SWA environments"
        echo "ðŸ’¡ Please close the stale PRs or manually delete environments in Azure Portal"
        echo "   Stale PRs: $STALE_PRS"

    - name: Create cleanup summary
      if: always()
      shell: bash
      env:
        DELETED_COUNT: ${{ steps.cleanup.outputs.deleted_count || '0' }}
        STALE_COUNT: ${{ steps.find.outputs.stale_count || '0' }}
        STALE_PRS: ${{ steps.cleanup.outputs.stale_prs || steps.find.outputs.stale_prs || 'none' }}
        DRY_RUN: ${{ inputs.dry-run }}
      run: |
        cat >> $GITHUB_STEP_SUMMARY << EOF
        ## ðŸ—‘ï¸ SWA Environment Cleanup Report
        
        **Mode:** $([ "$DRY_RUN" == "true" ] && echo "ðŸ” Dry Run" || echo "ðŸ—‘ï¸ Active Deletion")
        **Stale Environments Found:** $STALE_COUNT
        **Environments Processed:** $DELETED_COUNT
        
        $([ "$STALE_COUNT" != "0" ] && echo "**PR Numbers:** $STALE_PRS" || echo "_No stale environments detected_")
        
        > **Note:** Stale environments are from PRs closed more than ${{ inputs.min-age-hours }} hour(s) ago.
        EOF
