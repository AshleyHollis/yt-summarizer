# Scan JavaScript/TypeScript Dependencies and Quality
# Checks for missing deps, vulnerabilities, and code quality issues
# Uses: npm audit, depcheck, eslint

name: 'Scan JavaScript Dependencies and Quality'
description: 'Scan JavaScript/TypeScript for missing dependencies and security issues'

inputs:
  working-directory:
    description: 'Directory containing package.json (e.g., apps/web)'
    required: true
  check-missing-deps:
    description: 'Check for missing dependencies using depcheck'
    required: false
    default: 'true'
  check-security:
    description: 'Run npm audit for security vulnerabilities'
    required: false
    default: 'true'
  audit-level:
    description: 'Minimum severity level for npm audit (low, moderate, high, critical)'
    required: false
    default: 'high'

runs:
  using: 'composite'
  steps:
    - name: Install scanning tools
      shell: bash
      working-directory: ${{ inputs.working-directory }}
      run: |
        npm install -g depcheck

    - name: Check for missing dependencies with depcheck
      if: inputs.check-missing-deps == 'true'
      shell: bash
      working-directory: ${{ inputs.working-directory }}
      run: |
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo "ğŸ” JavaScript Dependency Scan (depcheck)"
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo ""
        
        # Run depcheck (uses .depcheckrc config if present)
        if depcheck; then
          echo ""
          echo "âœ… No dependency issues detected"
        else
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "âš ï¸  DEPENDENCY ISSUES DETECTED"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "ğŸ“‹ Known false positives (these are actually used):"
          echo "   â€¢ @copilotkit/runtime - Used in next.config.ts optimizePackageImports"
          echo "   â€¢ @tailwindcss/postcss - PostCSS plugin in postcss.config.mjs"
          echo "   â€¢ @tailwindcss/typography - Provides prose-* utility classes"
          echo "   â€¢ tailwindcss - Core CSS framework"
          echo ""
          echo "   âš ï¸  If you see packages OTHER than those listed above,"
          echo "       they may be genuinely unused and should be investigated."
          echo ""
          echo "ğŸ“‹ Action Required:"
          echo "   1. Review the packages listed above"
          echo "   2. If it's a known false positive, document it"
          echo "   3. If it's genuinely unused, remove it from package.json"
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          exit 1
        fi

    - name: Run npm audit for security vulnerabilities
      if: inputs.check-security == 'true'
      shell: bash
      working-directory: ${{ inputs.working-directory }}
      run: |
        echo ""
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo "ğŸ”’ Security Vulnerability Scan (npm audit)"
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo ""
        
        if npm audit --audit-level=${{ inputs.audit-level }}; then
          echo ""
          echo "âœ… No security vulnerabilities detected"
        else
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "âš ï¸  SECURITY VULNERABILITIES FOUND"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "ğŸ“‹ Action Required:"
          echo "   1. Review the vulnerability report above"
          echo "   2. Run 'npm audit fix' to auto-fix where possible"
          echo "   3. For breaking changes, use 'npm audit fix --force'"
          echo "   4. Update package.json for manual updates"
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          exit 1
        fi

    - name: Verify no missing peer dependencies
      shell: bash
      working-directory: ${{ inputs.working-directory }}
      run: |
        echo "ğŸ” Checking peer dependencies..."
        npm ls --depth=0 || {
          echo "âš ï¸  Peer dependency issues detected"
          exit 1
        }

    - name: Summary
      shell: bash
      run: |
        echo "âœ… JavaScript dependency scan complete"
