# Scan JavaScript/TypeScript Dependencies and Quality
# Checks for missing deps, vulnerabilities, and code quality issues
# Uses: npm audit, depcheck, eslint

name: 'Scan JavaScript Dependencies and Quality'
description: 'Scan JavaScript/TypeScript for missing dependencies and security issues'

inputs:
  working-directory:
    description: 'Directory containing package.json (e.g., apps/web)'
    required: true
  check-missing-deps:
    description: 'Check for missing dependencies using depcheck'
    required: false
    default: 'true'
  check-security:
    description: 'Run npm audit for security vulnerabilities'
    required: false
    default: 'true'
  audit-level:
    description: 'Minimum severity level for npm audit (low, moderate, high, critical)'
    required: false
    default: 'high'

runs:
  using: 'composite'
  steps:
    - name: Install scanning tools
      shell: bash
      working-directory: ${{ inputs.working-directory }}
      run: |
        npm install -g depcheck

    - name: Check for missing dependencies with depcheck
      if: inputs.check-missing-deps == 'true'
      shell: bash
      working-directory: ${{ inputs.working-directory }}
      run: |
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo "ğŸ” JavaScript Dependency Scan (depcheck)"
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo ""
        
        # Run depcheck (uses .depcheckrc config if present)
        DEPCHECK_OUTPUT=$(depcheck 2>&1) || true
        echo "$DEPCHECK_OUTPUT"
        
        # Check for genuinely problematic issues (not in our known false positives list)
        if echo "$DEPCHECK_OUTPUT" | grep -E "(Unused dependencies|Missing dependencies)" > /dev/null; then
          # Filter out known false positives
          FILTERED_OUTPUT=$(echo "$DEPCHECK_OUTPUT" | grep -v "@copilotkit/runtime" | grep -v "@tailwindcss/postcss" | grep -v "@tailwindcss/typography" | grep -v "^* tailwindcss$")
          
          if echo "$FILTERED_OUTPUT" | grep -E "^\* " > /dev/null; then
            # Found dependencies that aren't in the known false positives list
            echo ""
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo "âŒ UNEXPECTED DEPENDENCY ISSUES"
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo ""
            echo "The following dependencies are flagged and NOT in the known false"
            echo "positives list. These should be investigated:"
            echo ""
            echo "$FILTERED_OUTPUT"
            echo ""
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            exit 1
          else
            # Only known false positives detected
            echo ""
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo "âœ… PASSED (Known False Positives Only)"
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo ""
            echo "ğŸ“‹ The following packages appear unused but are required:"
            echo "   â€¢ @copilotkit/runtime - Used in next.config.ts optimizePackageImports"
            echo "   â€¢ @tailwindcss/postcss - PostCSS plugin in postcss.config.mjs"
            echo "   â€¢ @tailwindcss/typography - Provides prose-* utility classes"
            echo "   â€¢ tailwindcss - Core CSS framework (imported in globals.css)"
            echo ""
            echo "   These are documented in apps/web/README.md"
            echo ""
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          fi
        else
          echo ""
          echo "âœ… No dependency issues detected"
        fi

    - name: Run npm audit for security vulnerabilities
      if: inputs.check-security == 'true'
      shell: bash
      working-directory: ${{ inputs.working-directory }}
      run: |
        echo ""
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo "ğŸ”’ Security Vulnerability Scan (npm audit)"
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo ""
        
        if npm audit --audit-level=${{ inputs.audit-level }}; then
          echo ""
          echo "âœ… No security vulnerabilities detected"
        else
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "âš ï¸  SECURITY VULNERABILITIES FOUND"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "ğŸ“‹ Action Required:"
          echo "   1. Review the vulnerability report above"
          echo "   2. Run 'npm audit fix' to auto-fix where possible"
          echo "   3. For breaking changes, use 'npm audit fix --force'"
          echo "   4. Update package.json for manual updates"
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          exit 1
        fi

    - name: Verify no missing peer dependencies
      shell: bash
      working-directory: ${{ inputs.working-directory }}
      run: |
        echo "ğŸ” Checking peer dependencies..."
        npm ls --depth=0 || {
          echo "âš ï¸  Peer dependency issues detected"
          exit 1
        }

    - name: Summary
      shell: bash
      run: |
        echo "âœ… JavaScript dependency scan complete"
