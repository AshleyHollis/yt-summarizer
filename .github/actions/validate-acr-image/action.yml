name: Validate ACR Image Exists
description: Verify that an image tag exists in Azure Container Registry before deployment

inputs:
  registry:
    description: Container registry (without .azurecr.io suffix)
    required: true
  repository:
    description: Repository name (e.g., yt-summarizer-api)
    required: true
  tag:
    description: Image tag to validate
    required: true
  fail-if-missing:
    description: Whether to fail if image doesn't exist
    required: false
    default: 'true'

outputs:
  exists:
    description: Whether the image exists (true/false)
    value: ${{ steps.check.outputs.exists }}
  manifest-digest:
    description: Image manifest digest if exists
    value: ${{ steps.check.outputs.digest }}

runs:
  using: composite
  steps:
    - name: Check if image exists in ACR
      id: check
      shell: bash
      run: |
        REGISTRY="${{ inputs.registry }}"
        REPOSITORY="${{ inputs.repository }}"
        TAG="${{ inputs.tag }}"
        FAIL_IF_MISSING="${{ inputs.fail-if-missing }}"
        
        echo "ðŸ” Validating image exists in ACR..."
        echo "  Registry: ${REGISTRY}.azurecr.io"
        echo "  Repository: ${REPOSITORY}"
        echo "  Tag: ${TAG}"
        
        # Try to get manifest for the specific tag
        # This requires authentication, which should be set up by Azure Login action
        MANIFEST=$(az acr repository show --name "$REGISTRY" --image "${REPOSITORY}:${TAG}" --output json 2>&1 || echo "")
        
        if [ -z "$MANIFEST" ] || [[ "$MANIFEST" == *"not found"* ]] || [[ "$MANIFEST" == *"ResourceNotFound"* ]]; then
          echo "exists=false" >> $GITHUB_OUTPUT
          echo "digest=" >> $GITHUB_OUTPUT
          
          echo "::warning::âŒ Image NOT found: ${REGISTRY}.azurecr.io/${REPOSITORY}:${TAG}"
          
          if [ "$FAIL_IF_MISSING" = "true" ]; then
            echo ""
            echo "::error::Required image does not exist in ACR!"
            echo "::error::  Registry: ${REGISTRY}.azurecr.io"
            echo "::error::  Image: ${REPOSITORY}:${TAG}"
            echo ""
            echo "::group::ðŸ”§ How to Fix This"
            echo "This usually means the CI workflow didn't complete successfully or didn't push images."
            echo ""
            echo "Options:"
            echo "  1. **Re-run the CI workflow** for the commit that changed code"
            echo "     - Go to Actions â†’ CI â†’ Find the run for this commit â†’ Re-run failed jobs"
            echo ""
            echo "  2. **Check if CI completed successfully**"
            echo "     - The build-images job must succeed and push to ACR"
            echo "     - Check for authentication or permission errors"
            echo ""
            echo "  3. **Push a new commit with code changes** to trigger a fresh CI build"
            echo "     - This will ensure new images are built and pushed"
            echo ""
            echo "  4. **Verify Azure credentials** if this is the first deployment"
            echo "     - Ensure AZURE_CLIENT_ID, AZURE_TENANT_ID, AZURE_SUBSCRIPTION_ID are set"
            echo "     - Check that the service principal has AcrPush permissions"
            echo "::endgroup::"
            echo ""
            
            # List available tags for this repository to help debugging
            echo "::group::ðŸ“¦ Available Tags in ${REPOSITORY}"
            az acr repository show-tags --name "$REGISTRY" --repository "$REPOSITORY" --orderby time_desc --output table --top 20 2>/dev/null || echo "Could not list tags (permission issue or repository doesn't exist)"
            echo "::endgroup::"
            
            exit 1
          fi
        else
          # Extract digest from manifest
          # Use set +e temporarily to prevent pipefail from stopping on jq errors
          set +e
          DIGEST=$(echo "$MANIFEST" | jq -r '.digest // ""' 2>/dev/null)
          set -e
          
          # Fallback if jq fails or returns null
          if [ -z "$DIGEST" ] || [ "$DIGEST" = "null" ]; then
            DIGEST=""
          fi
          
          echo "exists=true" >> $GITHUB_OUTPUT
          echo "digest=${DIGEST}" >> $GITHUB_OUTPUT
          
          echo "âœ… Image exists in ACR"
          if [ -n "$DIGEST" ]; then
            echo "   Digest: ${DIGEST}"
          fi
        fi    
    - name: Test Kubernetes image pull capability
      id: k8s-pull-test
      shell: bash
      if: steps.check.outputs.exists == 'true'
      run: |
        REGISTRY="${{ inputs.registry }}"
        REPOSITORY="${{ inputs.repository }}"
        TAG="${{ inputs.tag }}"
        FULL_IMAGE="${REGISTRY}.azurecr.io/${REPOSITORY}:${TAG}"
        
        echo ""
        echo "ðŸ§ª Testing Kubernetes image pull capability..."
        echo "   This verifies that K8s pods can actually pull the image (not just Azure CLI)"
        echo ""
        
        # Use a temporary test namespace to avoid conflicts
        TEST_NAMESPACE="acr-pull-test-$(date +%s)"
        CLEANUP_NEEDED=false
        
        # Create test namespace
        if kubectl create namespace "$TEST_NAMESPACE" --dry-run=client -o yaml | kubectl apply -f - &>/dev/null; then
          CLEANUP_NEEDED=true
          echo "  âœ“ Created test namespace: $TEST_NAMESPACE"
        else
          echo "  ::warning::Could not create test namespace, using default"
          TEST_NAMESPACE="default"
        fi
        
        # Try to pull the image using a test pod
        echo "  ðŸ”„ Attempting image pull with test pod..."
        
        POD_NAME="acr-pull-test-$(date +%s)"
        PULL_SUCCESS=false
        
        # Create a simple pod that just tries to pull the image
        cat <<EOF | kubectl apply -n "$TEST_NAMESPACE" -f - &>/dev/null
apiVersion: v1
kind: Pod
metadata:
  name: ${POD_NAME}
spec:
  restartPolicy: Never
  containers:
    - name: test
      image: ${FULL_IMAGE}
      command: ["sh", "-c", "echo 'Image pulled successfully' && exit 0"]
EOF
        
        # Wait up to 60 seconds for pod to start or fail
        echo "  â³ Waiting for pod status (max 60s)..."
        for i in {1..60}; do
          POD_STATUS=$(kubectl get pod ${POD_NAME} -n "$TEST_NAMESPACE" -o jsonpath='{.status.phase}' 2>/dev/null || echo "Unknown")
          
          if [ "$POD_STATUS" = "Running" ] || [ "$POD_STATUS" = "Succeeded" ]; then
            PULL_SUCCESS=true
            echo "  âœ… Image pull SUCCESSFUL - Pod status: $POD_STATUS"
            break
          elif [ "$POD_STATUS" = "Failed" ] || [ "$POD_STATUS" = "ErrImagePull" ] || [ "$POD_STATUS" = "ImagePullBackOff" ]; then
            echo "  âŒ Image pull FAILED - Pod status: $POD_STATUS"
            break
          fi
          
          # Check container status for more detail
          CONTAINER_STATE=$(kubectl get pod ${POD_NAME} -n "$TEST_NAMESPACE" -o jsonpath='{.status.containerStatuses[0].state}' 2>/dev/null || echo "")
          if [[ "$CONTAINER_STATE" == *"ErrImagePull"* ]] || [[ "$CONTAINER_STATE" == *"ImagePullBackOff"* ]]; then
            echo "  âŒ Image pull FAILED - Container state: ErrImagePull/ImagePullBackOff"
            break
          fi
          
          sleep 1
        done
        
        # Get detailed pod events if pull failed
        if [ "$PULL_SUCCESS" = "false" ]; then
          echo ""
          echo "  ::group::ðŸ” Pod Events (Pull Failure Diagnostics)"
          kubectl describe pod ${POD_NAME} -n "$TEST_NAMESPACE" 2>/dev/null | grep -A 20 "Events:" || echo "Could not retrieve events"
          echo "  ::endgroup::"
          echo ""
          
          echo "  ::group::ðŸ” Container Status Details"
          kubectl get pod ${POD_NAME} -n "$TEST_NAMESPACE" -o jsonpath='{.status.containerStatuses[0]}' 2>/dev/null | jq '.' || echo "Could not retrieve container status"
          echo "  ::endgroup::"
          echo ""
          
          echo "::error::âŒ CRITICAL: Image exists in ACR but Kubernetes CANNOT pull it!"
          echo "::error:: "
          echo "::error::  This indicates an ACR authentication/permissions issue:"
          echo "::error::  1. AKS kubelet identity may not have AcrPull role on the registry"
          echo "::error::  2. ACR network rules may be blocking AKS cluster"
          echo "::error::  3. Image pull secrets may be missing or invalid"
          echo "::error:: "
          echo "::error::  Recommended fixes:"
          echo "::error::  - Verify AKS managed identity has 'AcrPull' role: az role assignment list --scope /subscriptions/.../acr/..."
          echo "::error::  - Check ACR network rules allow AKS subnet"
          echo "::error::  - If using admin credentials, verify imagePullSecrets are configured"
        else
          echo "  âœ… VERIFICATION PASSED: Kubernetes can successfully pull this image"
        fi
        
        # Cleanup
        kubectl delete pod ${POD_NAME} -n "$TEST_NAMESPACE" --ignore-not-found=true &>/dev/null || true
        if [ "$CLEANUP_NEEDED" = "true" ]; then
          kubectl delete namespace "$TEST_NAMESPACE" --ignore-not-found=true &>/dev/null || true
        fi
        
        # Output result
        echo "pull_success=${PULL_SUCCESS}" >> $GITHUB_OUTPUT
        
        # Exit with error if pull test failed
        if [ "$PULL_SUCCESS" = "false" ]; then
          exit 1
        fi