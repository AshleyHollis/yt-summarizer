name: Validate ACR Image Exists
description: Verify that an image tag exists in Azure Container Registry before deployment

inputs:
  registry:
    description: Container registry (without .azurecr.io suffix)
    required: true
  repository:
    description: Repository name (e.g., yt-summarizer-api)
    required: true
  tag:
    description: Image tag to validate
    required: true
  fail-if-missing:
    description: Whether to fail if image doesn't exist
    required: false
    default: 'true'

outputs:
  exists:
    description: Whether the image exists (true/false)
    value: ${{ steps.check.outputs.exists }}
  manifest-digest:
    description: Image manifest digest if exists
    value: ${{ steps.check.outputs.digest }}

runs:
  using: composite
  steps:
    - name: Check if image exists in ACR
      id: check
      shell: bash
      run: |
        REGISTRY="${{ inputs.registry }}"
        REPOSITORY="${{ inputs.repository }}"
        TAG="${{ inputs.tag }}"
        FAIL_IF_MISSING="${{ inputs.fail-if-missing }}"
        
        echo "ðŸ” Validating image exists in ACR..."
        echo "  Registry: ${REGISTRY}.azurecr.io"
        echo "  Repository: ${REPOSITORY}"
        echo "  Tag: ${TAG}"
        
        # Try to get manifest for the specific tag
        # This requires authentication, which should be set up by Azure Login action
        MANIFEST=$(az acr repository show --name "$REGISTRY" --image "${REPOSITORY}:${TAG}" --output json 2>&1 || echo "")
        
        if [ -z "$MANIFEST" ] || [[ "$MANIFEST" == *"not found"* ]] || [[ "$MANIFEST" == *"ResourceNotFound"* ]]; then
          echo "exists=false" >> $GITHUB_OUTPUT
          echo "digest=" >> $GITHUB_OUTPUT
          
          echo "::warning::âŒ Image NOT found: ${REGISTRY}.azurecr.io/${REPOSITORY}:${TAG}"
          
          if [ "$FAIL_IF_MISSING" = "true" ]; then
            echo ""
            echo "::error::Required image does not exist in ACR!"
            echo "::error::  Registry: ${REGISTRY}.azurecr.io"
            echo "::error::  Image: ${REPOSITORY}:${TAG}"
            echo ""
            echo "::group::ðŸ”§ How to Fix This"
            echo "This usually means the CI workflow didn't complete successfully or didn't push images."
            echo ""
            echo "Options:"
            echo "  1. **Re-run the CI workflow** for the commit that changed code"
            echo "     - Go to Actions â†’ CI â†’ Find the run for this commit â†’ Re-run failed jobs"
            echo ""
            echo "  2. **Check if CI completed successfully**"
            echo "     - The build-images job must succeed and push to ACR"
            echo "     - Check for authentication or permission errors"
            echo ""
            echo "  3. **Push a new commit with code changes** to trigger a fresh CI build"
            echo "     - This will ensure new images are built and pushed"
            echo ""
            echo "  4. **Verify Azure credentials** if this is the first deployment"
            echo "     - Ensure AZURE_CLIENT_ID, AZURE_TENANT_ID, AZURE_SUBSCRIPTION_ID are set"
            echo "     - Check that the service principal has AcrPush permissions"
            echo "::endgroup::"
            echo ""
            
            # List available tags for this repository to help debugging
            echo "::group::ðŸ“¦ Available Tags in ${REPOSITORY}"
            az acr repository show-tags --name "$REGISTRY" --repository "$REPOSITORY" --orderby time_desc --output table --top 20 2>/dev/null || echo "Could not list tags (permission issue or repository doesn't exist)"
            echo "::endgroup::"
            
            exit 1
          fi
        else
          # Extract digest from manifest
          DIGEST=$(echo "$MANIFEST" | jq -r '.digest // empty' 2>/dev/null || echo "")
          
          echo "exists=true" >> $GITHUB_OUTPUT
          echo "digest=${DIGEST}" >> $GITHUB_OUTPUT
          
          echo "âœ… Image exists in ACR"
          [ -n "$DIGEST" ] && echo "   Digest: ${DIGEST}"
        fi
