# Validate Python Dependencies
# Scans codebase for missing/unused/vulnerable dependencies
# Uses industry-standard tools: deptry, pip-audit, pipdeptree

name: 'Validate Python Dependencies'
description: 'Scan for missing dependencies, unused dependencies, and security vulnerabilities'

inputs:
  service-path:
    description: 'Path to the service directory (e.g., services/api)'
    required: true
  check-missing:
    description: 'Check for missing dependencies (imports not in pyproject.toml)'
    required: false
    default: 'true'
  check-unused:
    description: 'Check for unused dependencies (in pyproject.toml but never imported)'
    required: false
    default: 'false'
  check-security:
    description: 'Check for security vulnerabilities in dependencies'
    required: false
    default: 'true'
  fail-on-warnings:
    description: 'Fail if warnings are found'
    required: false
    default: 'false'

runs:
  using: 'composite'
  steps:
    - name: Install dependency scanning tools
      shell: bash
      run: |
        uv tool install deptry
        uv tool install pip-audit
        uv tool install pipdeptree

    - name: Display dependency tree
      shell: bash
      working-directory: ${{ inputs.service-path }}
      run: |
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo "ğŸ“¦ Dependency Tree (pipdeptree - first 50 lines)"
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo ""
        pipdeptree --python $(which python) 2>/dev/null | head -n 50 || true
        echo ""
        echo "(Output truncated for readability)"

    - name: Check for missing dependencies with deptry
      if: inputs.check-missing == 'true'
      shell: bash
      working-directory: ${{ inputs.service-path }}
      run: |
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo "ğŸ” Scanning for Missing Dependencies (deptry)"
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo ""

        # Auto-detect source directory
        if [ -d "src" ]; then
          SRC_DIR="src"
        else
          SRC_DIR="."
        fi

        echo "ğŸ“ Source directory: $SRC_DIR"
        echo ""

        # Ignore DEP003 (transitive dependencies) for editable local packages
        # Ignore DEP002 (unused deps) for dev/test/infrastructure packages
        if deptry "$SRC_DIR" --extend-exclude "test.*" --ignore DEP003,DEP002; then
          echo ""
          echo "âœ… No missing dependencies detected"
        else
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "âŒ MISSING DEPENDENCIES DETECTED"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "ğŸ“‹ Action Required:"
          echo "   Add the packages listed above to pyproject.toml"
          echo "   under [project.dependencies]"
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          exit 1
        fi

    - name: Check for unused dependencies with deptry
      if: inputs.check-unused == 'true'
      shell: bash
      working-directory: ${{ inputs.service-path }}
      continue-on-error: ${{ inputs.fail-on-warnings == 'false' }}
      run: |
        echo "ğŸ” Scanning for unused dependencies..."
        deptry src --extend-exclude "test.*" --ignore-obsolete DEP004 || {
          echo "âš ï¸  UNUSED DEPENDENCIES DETECTED"
          echo "Consider removing unused packages from pyproject.toml"
          exit 1
        }

    - name: Check for security vulnerabilities with pip-audit
      if: inputs.check-security == 'true'
      shell: bash
      working-directory: ${{ inputs.service-path }}
      continue-on-error: ${{ inputs.fail-on-warnings == 'false' }}
      run: |
        echo ""
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo "ğŸ”’ Security Vulnerability Scan (pip-audit)"
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo ""

        if pip-audit --desc; then
          echo ""
          echo "âœ… No security vulnerabilities detected"
        else
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "âš ï¸  SECURITY VULNERABILITIES FOUND"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "ğŸ“‹ Action Required:"
          echo "   1. Review the vulnerability report above"
          echo "   2. Update affected packages in pyproject.toml"
          echo "   3. Run 'uv sync' to update lock file"
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          exit 1
        fi

    - name: Summary
      shell: bash
      run: |
        echo "âœ… Dependency validation complete"
        echo "Checks performed:"
        echo "  - Missing dependencies: ${{ inputs.check-missing }}"
        echo "  - Unused dependencies: ${{ inputs.check-unused }}"
        echo "  - Security vulnerabilities: ${{ inputs.check-security }}"
