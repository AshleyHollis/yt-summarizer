name: 'Post Terraform Plan'
description: 'Posts Terraform plan to PR comments and generates pipeline summary'
inputs:
  plan-summary:
    description: 'JSON summary of plan changes (add, change, destroy, has_changes)'
    required: true
  formatted-plan:
    description: 'Formatted terraform plan output'
    required: true
  plan-outcome:
    description: 'Plan outcome (success/failure)'
    required: true
  skip-pr-comment:
    description: 'Skip posting to PR comment (true/false)'
    required: false
    default: 'false'
outputs:
  comment-id:
    description: 'ID of the created or updated PR comment'
    value: ${{ steps.post-pr.outputs.comment-id }}
runs:
  using: composite
  steps:
    - name: Generate plan section
      id: generate-sections
      shell: bash
      run: |
        # Parse inputs
        PLAN_SUMMARY='${{ inputs.plan-summary }}'
        FORMATTED_PLAN='${{ inputs.formatted-plan }}'
        PLAN_OUTCOME='${{ inputs.plan-outcome }}'

        # Write to output file for later steps
        echo "$PLAN_SUMMARY" > ${{ github.action_path }}/plan-summary.json
        echo "$FORMATTED_PLAN" > ${{ github.action_path }}/formatted-plan.txt
        echo "$PLAN_OUTCOME" > ${{ github.action_path }}/plan-outcome.txt

    - name: Post to PR
      id: post-pr
      if: ${{ inputs.skip-pr-comment != 'true' && github.event_name == 'pull_request' }}
      uses: actions/github-script@v7
      env:
        PLAN_SUMMARY: ${{ inputs.plan-summary }}
        FORMATTED_PLAN: ${{ inputs.formatted-plan }}
        PLAN_OUTCOME: ${{ inputs.plan-outcome }}
      with:
        github-token: ${{ github.token }}
        retries: 3
        script: |
          const summary = JSON.parse(process.env.PLAN_SUMMARY || '{"add":0,"change":0,"destroy":0,"has_changes":false}');
          const rawPlan = process.env.FORMATTED_PLAN || 'No plan output available';
          const planOutcome = process.env.PLAN_OUTCOME;

          core.info(`Plan Outcome: ${planOutcome}`);
          core.info(`Summary: Add=${summary.add}, Change=${summary.change}, Destroy=${summary.destroy}`);

          const hasChanges = summary.has_changes;
          const runNumber = context.runNumber;
          const runId = context.runId;
          const runUrl = `${context.payload.repository.html_url}/actions/runs/${runId}`;
          const timestamp = new Date().toISOString().replace('T', ' ').substring(0, 19) + ' UTC';

          // Unique marker for finding this comment - MUST be at the start
          const COMMENT_MARKER = '<!-- terraform-plan-comment -->';

          // Parse resources from terraform plan output
          function parseResources(planOutput) {
            const resources = [];
            const lines = planOutput.split('\n');
            let currentResource = null;
            let currentDetails = [];
            let inResource = false;

            for (const line of lines) {
              const resourceMatch = line.match(/^\s*#\s+(.+?)\s+(will be|must be)\s+(created|updated in-place|replaced|destroyed)/);
              if (resourceMatch) {
                if (currentResource) {
                  resources.push({ ...currentResource, details: currentDetails.join('\n') });
                }
                const actionText = resourceMatch[3];
                let action = 'read';
                if (actionText === 'created') action = 'create';
                else if (actionText === 'updated in-place') action = 'update';
                else if (actionText === 'replaced') action = 'replace';
                else if (actionText === 'destroyed') action = 'destroy';
                currentResource = { address: resourceMatch[1], action };
                currentDetails = [];
                inResource = true;
                continue;
              }

              if (inResource && line.trim()) {
                if (line.match(/^Plan:|^Changes to Outputs:|^Warning:|^-+$/)) {
                  inResource = false;
                  if (currentResource) {
                    resources.push({ ...currentResource, details: currentDetails.join('\n') });
                    currentResource = null;
                    currentDetails = [];
                  }
                } else {
                  currentDetails.push(line);
                }
              }
            }
            if (currentResource) {
              resources.push({ ...currentResource, details: currentDetails.join('\n') });
            }
            return resources;
          }

          const resources = parseResources(rawPlan);
          core.info(`Parsed ${resources.length} resources from plan`);

          const creates = resources.filter(r => r.action === 'create');
          const updates = resources.filter(r => r.action === 'update');
          const replaces = resources.filter(r => r.action === 'replace');
          const destroys = resources.filter(r => r.action === 'destroy');

          function buildResourceSection(resource) {
            const actionColors = {
              create: '#22c55e',
              update: '#f59e0b', 
              replace: '#a855f7',
              destroy: '#ef4444'
            };
            const actionSymbols = {
              create: '+ create',
              update: '~ update',
              replace: '-/+ replace',
              destroy: '- destroy'
            };
            const color = actionColors[resource.action] || '#6b7280';
            const symbol = actionSymbols[resource.action] || 'read';
            const cleanDetails = resource.details.split('\n').filter(l => l.trim()).map(l => l.replace(/^\s{4}/, '')).join('\n');
            
            return `<details>\n<summary>` +
              `<strong style="color:${color};">${symbol}</strong> ` +
              `<code>${resource.address}</code>` +
              `</summary>\n\n` +
              `\`\`\`terraform\n${cleanDetails || '(no details)'}\n\`\`\`\n\n` +
              `</details>`;
          }

          // Build the comment body
          const sections = [];

          // Hidden marker for comment detection
          sections.push(COMMENT_MARKER);
          sections.push('');

          // Status header with outcome - more visual
          if (planOutcome === 'success') {
            sections.push('# <img src="https://raw.githubusercontent.com/hashicorp/terraform-website/master/public/img/logo-terraform.svg" width="20" height="20" /> Terraform Plan');
          } else {
            sections.push('# <img src="https://raw.githubusercontent.com/hashicorp/terraform-website/master/public/img/logo-terraform.svg" width="20" height="20" /> Terraform Plan Failed');
          }
          sections.push('');

          // Metadata table - cleaner layout
          sections.push('| | |');
          sections.push('|:--|:--|');
          sections.push(`| **Run** | [#${runNumber}](${runUrl}) ${planOutcome === 'success' ? '‚úÖ' : '‚ùå'} |`);
          sections.push(`| **Updated** | ${timestamp} |`);
          sections.push(`| **Triggered by** | @${context.actor} |`);
          sections.push('');

          // Summary section with better visual hierarchy
          if (hasChanges) {
            const totalChanges = summary.add + summary.change + summary.destroy;
            sections.push(`### üìä Summary: ${totalChanges} resource${totalChanges !== 1 ? 's' : ''} to change`);
            sections.push('');
            sections.push('| Action | Resources |');
            sections.push('|:-------|----------:|');
            if (summary.add > 0) {
              sections.push(`| <span style="color:#22c55e;">**+ Create**</span> | **${summary.add}** |`);
            }
            if (summary.change > 0) {
              sections.push(`| <span style="color:#f59e0b;">**~ Update**</span> | **${summary.change}** |`);
            }
            if (summary.destroy > 0) {
              sections.push(`| <span style="color:#ef4444;">**- Destroy**</span> | **${summary.destroy}** |`);
            }
            sections.push('');
            
            // Navigation hint
            sections.push('> üí° **Tip:** Click on sections below to expand/collapse resource details');
            sections.push('');
          } else {
            sections.push('### ‚úÖ No Changes');
            sections.push('');
            sections.push('> Infrastructure matches the configuration. No changes required.');
            sections.push('');
          }

          sections.push('<hr/>');
          sections.push('');

          // Resource details by action type - improved styling
          if (creates.length > 0) {
            sections.push(`### <span style="color:#22c55e;">‚ûï Resources to Create</span> <sup>${creates.length}</sup>`);
            sections.push('');
            sections.push(`<details>`);
            sections.push(`<summary>Click to expand all ${creates.length} resource${creates.length !== 1 ? 's' : ''}</summary>`);
            sections.push('');
            creates.forEach(r => sections.push(buildResourceSection(r)));
            sections.push('</details>');
            sections.push('');
          }
          
          if (replaces.length > 0) {
            sections.push(`### <span style="color:#a855f7;">‚ôªÔ∏è Resources to Replace</span> <sup>${replaces.length}</sup>`);
            sections.push('');
            sections.push(`<details>`);
            sections.push(`<summary>Click to expand all ${replaces.length} resource${replaces.length !== 1 ? 's' : ''}</summary>`);
            sections.push('');
            replaces.forEach(r => sections.push(buildResourceSection(r)));
            sections.push('</details>');
            sections.push('');
          }
          
          if (updates.length > 0) {
            sections.push(`### <span style="color:#f59e0b;">üîÑ Resources to Update</span> <sup>${updates.length}</sup>`);
            sections.push('');
            sections.push(`<details>`);
            sections.push(`<summary>Click to expand all ${updates.length} resource${updates.length !== 1 ? 's' : ''}</summary>`);
            sections.push('');
            updates.forEach(r => sections.push(buildResourceSection(r)));
            sections.push('</details>');
            sections.push('');
          }
          
          if (destroys.length > 0) {
            sections.push(`### <span style="color:#ef4444;">üóëÔ∏è Resources to Destroy</span> <sup>${destroys.length}</sup>`);
            sections.push('');
            sections.push(`<details>`);
            sections.push(`<summary>‚ö†Ô∏è Click to expand all ${destroys.length} resource${destroys.length !== 1 ? 's' : ''}</summary>`);
            sections.push('');
            destroys.forEach(r => sections.push(buildResourceSection(r)));
            sections.push('</details>');
            sections.push('');
          }

          // Fallback: show raw plan if no resources parsed but has changes
          if (resources.length === 0 && hasChanges) {
            sections.push('<details>');
            sections.push('<summary><strong>üìã Raw Plan Output</strong></summary>');
            sections.push('');
            sections.push('```terraform');
            sections.push(rawPlan.length > 60000 ? rawPlan.substring(0, 60000) + '\n...(truncated)' : rawPlan);
            sections.push('```');
            sections.push('</details>');
            sections.push('');
          }

          const commentBody = sections.join('\n');

          core.info('Fetching comments...');
          const { data: comments } = await github.rest.issues.listComments({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: context.issue.number,
            per_page: 100
          });

          // Find comment by unique marker (most reliable method)
          const botComment = comments.find(c => c.body && c.body.includes(COMMENT_MARKER));
          core.info(`Found ${comments.length} comments, ${botComment ? 'updating existing #' + botComment.id : 'creating new'}`);

          let commentId = null;
          try {
            if (botComment) {
              core.info(`Updating comment ${botComment.id}...`);
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: commentBody
              });
              core.info('Comment updated');
              commentId = botComment.id;
            } else {
              core.info('Creating comment...');
              const result = await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: commentBody
              });
              core.info(`Comment created: ${result.data.id}`);
              commentId = result.data.id;
            }
            core.notice(`Terraform plan posted to PR #${context.issue.number}`);
          } catch (error) {
            core.error(`Failed: ${error.message}`);
            core.setFailed(error.stack);
            throw error;
          }

          core.setOutput('comment-id', commentId);

    - name: Update pipeline summary
      uses: actions/github-script@v7
      env:
        PLAN_SUMMARY: ${{ inputs.plan-summary }}
        FORMATTED_PLAN: ${{ inputs.formatted-plan }}
        PLAN_OUTCOME: ${{ inputs.plan-outcome }}
      with:
        script: |
          const summary = JSON.parse(process.env.PLAN_SUMMARY || '{"add":0,"change":0,"destroy":0,"has_changes":false}');
          const rawPlan = process.env.FORMATTED_PLAN || 'No plan output available';
          const planOutcome = process.env.PLAN_OUTCOME;
          const hasChanges = summary.has_changes;
          const runNumber = context.runNumber;
          const runId = context.runId;
          const runUrl = `${context.payload.repository.html_url}/actions/runs/${runId}`;
          const timestamp = new Date().toISOString().replace('T', ' ').substring(0, 19) + ' UTC';

          // Parse resources from terraform plan output (same as PR comment)
          function parseResources(planOutput) {
            const resources = [];
            const lines = planOutput.split('\n');
            let currentResource = null;
            let currentDetails = [];
            let inResource = false;

            for (const line of lines) {
              const resourceMatch = line.match(/^\s*#\s+(.+?)\s+(will be|must be)\s+(created|updated in-place|replaced|destroyed)/);
              if (resourceMatch) {
                if (currentResource) {
                  resources.push({ ...currentResource, details: currentDetails.join('\n') });
                }
                const actionText = resourceMatch[3];
                let action = 'read';
                if (actionText === 'created') action = 'create';
                else if (actionText === 'updated in-place') action = 'update';
                else if (actionText === 'replaced') action = 'replace';
                else if (actionText === 'destroyed') action = 'destroy';
                currentResource = { address: resourceMatch[1], action };
                currentDetails = [];
                inResource = true;
                continue;
              }

              if (inResource && line.trim()) {
                if (line.match(/^Plan:|^Changes to Outputs:|^Warning:|^-+$/)) {
                  inResource = false;
                  if (currentResource) {
                    resources.push({ ...currentResource, details: currentDetails.join('\n') });
                    currentResource = null;
                    currentDetails = [];
                  }
                } else {
                  currentDetails.push(line);
                }
              }
            }
            if (currentResource) {
              resources.push({ ...currentResource, details: currentDetails.join('\n') });
            }
            return resources;
          }

          const resources = parseResources(rawPlan);
          const creates = resources.filter(r => r.action === 'create');
          const updates = resources.filter(r => r.action === 'update');
          const replaces = resources.filter(r => r.action === 'replace');
          const destroys = resources.filter(r => r.action === 'destroy');

          function buildResourceSection(resource) {
            const actionColors = {
              create: '#22c55e',
              update: '#f59e0b',
              replace: '#a855f7',
              destroy: '#ef4444'
            };
            const actionSymbols = {
              create: '+ create',
              update: '~ update',
              replace: '-/+ replace',
              destroy: '- destroy'
            };
            const color = actionColors[resource.action] || '#6b7280';
            const symbol = actionSymbols[resource.action] || 'read';
            const cleanDetails = resource.details.split('\n').filter(l => l.trim()).map(l => l.replace(/^\s{4}/, '')).join('\n');
            
            return `<details>\n<summary>` +
              `<strong style="color:${color};">${symbol}</strong> ` +
              `<code>${resource.address}</code>` +
              `</summary>\n\n` +
              `\`\`\`terraform\n${cleanDetails || '(no details)'}\n\`\`\`\n\n` +
              `</details>`;
          }

          const lines = [];

          // Header with Terraform branding
          if (planOutcome === 'success') {
            lines.push('# <img src="https://raw.githubusercontent.com/hashicorp/terraform-website/master/public/img/logo-terraform.svg" width="20" height="20" /> Terraform Plan');
          } else {
            lines.push('# <img src="https://raw.githubusercontent.com/hashicorp/terraform-website/master/public/img/logo-terraform.svg" width="20" height="20" /> Terraform Plan Failed');
          }
          lines.push('');

          // Metadata table
          lines.push('| | |');
          lines.push('|:--|:--|');
          lines.push(`| **Run** | [#${runNumber}](${runUrl}) ${planOutcome === 'success' ? '‚úÖ' : '‚ùå'} |`);
          lines.push(`| **Updated** | ${timestamp} |`);
          lines.push(`| **Triggered by** | @${context.actor} |`);
          lines.push('');

          // Summary section
          if (hasChanges) {
            const totalChanges = summary.add + summary.change + summary.destroy;
            lines.push(`### üìä Summary: ${totalChanges} resource${totalChanges !== 1 ? 's' : ''} to change`);
            lines.push('');
            lines.push('| Action | Resources |');
            lines.push('|:-------|----------:|');
            if (summary.add > 0) {
              lines.push(`| <span style="color:#22c55e;">**+ Create**</span> | **${summary.add}** |`);
            }
            if (summary.change > 0) {
              lines.push(`| <span style="color:#f59e0b;">**~ Update**</span> | **${summary.change}** |`);
            }
            if (summary.destroy > 0) {
              lines.push(`| <span style="color:#ef4444;">**- Destroy**</span> | **${summary.destroy}** |`);
            }
            lines.push('');
            
            lines.push('> üí° **Tip:** Click on sections below to expand/collapse resource details');
            lines.push('');
          } else {
            lines.push('### ‚úÖ No Changes');
            lines.push('');
            lines.push('> Infrastructure matches the configuration. No changes required.');
            lines.push('');
          }

          lines.push('<hr/>');
          lines.push('');

          // Resource details by action type
          if (creates.length > 0) {
            lines.push(`### <span style="color:#22c55e;">‚ûï Resources to Create</span> <sup>${creates.length}</sup>`);
            lines.push('');
            lines.push(`<details>`);
            lines.push(`<summary>Click to expand all ${creates.length} resource${creates.length !== 1 ? 's' : ''}</summary>`);
            lines.push('');
            creates.forEach(r => lines.push(buildResourceSection(r)));
            lines.push('</details>');
            lines.push('');
          }

          if (replaces.length > 0) {
            lines.push(`### <span style="color:#a855f7;">‚ôªÔ∏è Resources to Replace</span> <sup>${replaces.length}</sup>`);
            lines.push('');
            lines.push(`<details>`);
            lines.push(`<summary>Click to expand all ${replaces.length} resource${replaces.length !== 1 ? 's' : ''}</summary>`);
            lines.push('');
            replaces.forEach(r => lines.push(buildResourceSection(r)));
            lines.push('</details>');
            lines.push('');
          }

          if (updates.length > 0) {
            lines.push(`### <span style="color:#f59e0b;">üîÑ Resources to Update</span> <sup>${updates.length}</sup>`);
            lines.push('');
            lines.push(`<details>`);
            lines.push(`<summary>Click to expand all ${updates.length} resource${updates.length !== 1 ? 's' : ''}</summary>`);
            lines.push('');
            updates.forEach(r => lines.push(buildResourceSection(r)));
            lines.push('</details>');
            lines.push('');
          }

          if (destroys.length > 0) {
            lines.push(`### <span style="color:#ef4444;">üóëÔ∏è Resources to Destroy</span> <sup>${destroys.length}</sup>`);
            lines.push('');
            lines.push(`<details>`);
            lines.push(`<summary>‚ö†Ô∏è Click to expand all ${destroys.length} resource${destroys.length !== 1 ? 's' : ''}</summary>`);
            lines.push('');
            destroys.forEach(r => lines.push(buildResourceSection(r)));
            lines.push('</details>');
            lines.push('');
          }

          // Fallback: show raw plan if no resources parsed but has changes
          if (resources.length === 0 && hasChanges) {
            lines.push('<details>');
            lines.push('<summary><strong>üìã Raw Plan Output</strong></summary>');
            lines.push('');
            lines.push('```terraform');
            lines.push(rawPlan.length > 60000 ? rawPlan.substring(0, 60000) + '\n...(truncated)' : rawPlan);
            lines.push('```');
            lines.push('</details>');
            lines.push('');
          }

          await core.summary
            .addRaw(lines.join('\n'))
            .write();

    - name: Store outputs
      id: outputs
      shell: bash
      run: |
        # Store comment-id if available (from PR post step)
        if [ -n "${{ steps.post-pr.outputs.comment-id }}" ]; then
          echo "comment-id=${{ steps.post-pr.outputs.comment-id }}" >> $GITHUB_OUTPUT
        fi
