# =============================================================================
# Unified Validation Action
# =============================================================================
# Consolidates all validation logic for K8s, Kustomize, Argo CD, and Terraform
# Replaces: validate-k8s-yaml, kustomize-validate, validate-argocd-paths,
#           validate-argocd-manifest, validate-terraform-config
#
# Usage:
#   - validators: Comma-separated list of validators to run
#     Options: yaml-syntax, kustomize-build, argocd-paths, argocd-manifest, terraform-config, all
#
# Examples:
#   # CI - Full K8s validation
#   - uses: ./.github/actions/validate
#     with:
#       validators: yaml-syntax,kustomize-build,argocd-paths
#       overlay-paths: k8s/overlays/preview,k8s/overlays/prod
#
#   # Production - Pre-deployment
#   - uses: ./.github/actions/validate
#     with:
#       validators: kustomize-build,argocd-manifest
#       overlay-paths: k8s/overlays/prod
#       argocd-app-name: yt-summarizer-prod
# =============================================================================

name: Validate Manifests
description: Unified validation for K8s, Kustomize, Argo CD, and Terraform

inputs:
  # =============================================================================
  # What to Validate
  # =============================================================================
  validators:
    description: |
      Comma-separated list of validators to run.
      Options: yaml-syntax, kustomize-build, argocd-paths, argocd-manifest, terraform-config, k8s-placeholders, swa-config, kustomize-resources, reusable-workflows, all
      Example: yaml-syntax,kustomize-build,argocd-paths
    required: true

  # =============================================================================
  # K8s/Kustomize Configuration
  # =============================================================================
  k8s-directory:
    description: 'Directory containing K8s manifests (for yaml-syntax validator)'
    required: false
    default: 'k8s'

  overlay-paths:
    description: |
      Comma-separated list of overlay paths to validate (for kustomize-build validator)
      Example: k8s/overlays/preview,k8s/overlays/prod
    required: false

  base-paths:
    description: |
      Comma-separated list of base paths to validate (for kustomize-build validator)
      Example: k8s/base
    required: false

  # =============================================================================
  # Argo CD Configuration
  # =============================================================================
  argocd-app-name:
    description: 'Argo CD Application name (for argocd-manifest validator)'
    required: false

  argocd-namespace:
    description: 'Argo CD namespace (for argocd-manifest validator)'
    required: false
    default: 'argocd'

  target-namespace:
    description: 'Target deployment namespace (for argocd-manifest validator)'
    required: false

  # =============================================================================
  # Terraform Configuration
  # =============================================================================
  terraform-directory:
    description: 'Terraform working directory (for terraform-config validator)'
    required: false

  terraform-backend-config:
    description: 'Validate backend configuration (for terraform-config validator)'
    required: false
    default: 'false'

  # =============================================================================
  # K8s Placeholder Configuration
  # =============================================================================
  k8s-preview-patch-dir:
    description: 'Comma-separated list of K8s patch directories to validate for placeholders (for k8s-placeholders validator)'
    required: false
    default: 'k8s/overlays/preview/patches,k8s/overlays/prod/patches'

  # =============================================================================
  # SWA Configuration
  # =============================================================================
  swa-workflow-files:
    description: 'Comma-separated list of SWA workflow files to validate (for swa-config validator)'
    required: false
    default: '.github/workflows/deploy-prod.yml,.github/workflows/swa-baseline-deploy.yml'

  swa-app-dir:
    description: 'SWA application directory containing package.json (for swa-config validator)'
    required: false
    default: 'apps/web'

  # =============================================================================
  # Resource Quota Configuration
  # =============================================================================
  max-cpu-millicores:
    description: 'Maximum CPU in millicores for resource validation (for kustomize-resources validator)'
    required: false

  max-memory-mi:
    description: 'Maximum memory in Mi for resource validation (for kustomize-resources validator)'
    required: false

  query-aks:
    description: 'Query AKS cluster for resource quotas (for kustomize-resources validator)'
    required: false
    default: 'false'

  aks-resource-group:
    description: 'AKS resource group (required if query-aks=true)'
    required: false

  aks-cluster-name:
    description: 'AKS cluster name (required if query-aks=true)'
    required: false

  aks-namespace:
    description: 'AKS namespace to check quotas (for kustomize-resources validator)'
    required: false
    default: 'default'

  # =============================================================================
  # Behavior
  # =============================================================================
  fail-fast:
    description: 'Stop execution on first validator failure'
    required: false
    default: 'true'

  timeout-seconds:
    description: 'Timeout per validator in seconds'
    required: false
    default: '60'

  verbose:
    description: 'Enable verbose output for debugging'
    required: false
    default: 'false'

outputs:
  results:
    description: 'JSON object with validation results: {"passed": [...], "failed": [...], "skipped": [...]}'
    value: ${{ steps.run-validators.outputs.results }}

  all-passed:
    description: 'Boolean indicating if all validators passed'
    value: ${{ steps.run-validators.outputs.all-passed }}

  passed:
    description: 'Comma-separated list of validators that passed'
    value: ${{ steps.run-validators.outputs.passed }}

  failed:
    description: 'Comma-separated list of validators that failed'
    value: ${{ steps.run-validators.outputs.failed }}

runs:
  using: composite
  steps:
    - name: Run validators
      id: run-validators
      shell: bash
      env:
        VALIDATORS: ${{ inputs.validators }}
        K8S_DIRECTORY: ${{ inputs.k8s-directory }}
        OVERLAY_PATHS: ${{ inputs.overlay-paths }}
        BASE_PATHS: ${{ inputs.base-paths }}
        ARGOCD_APP_NAME: ${{ inputs.argocd-app-name }}
        ARGOCD_NAMESPACE: ${{ inputs.argocd-namespace }}
        TARGET_NAMESPACE: ${{ inputs.target-namespace }}
        TERRAFORM_DIRECTORY: ${{ inputs.terraform-directory }}
        TERRAFORM_BACKEND_CONFIG: ${{ inputs.terraform-backend-config }}
        K8S_PREVIEW_PATCH_DIR: ${{ inputs.k8s-preview-patch-dir }}
        SWA_WORKFLOW_FILES: ${{ inputs.swa-workflow-files }}
        SWA_APP_DIR: ${{ inputs.swa-app-dir }}
        MAX_CPU_MILLICORES: ${{ inputs.max-cpu-millicores }}
        MAX_MEMORY_MI: ${{ inputs.max-memory-mi }}
        QUERY_AKS: ${{ inputs.query-aks }}
        AKS_RESOURCE_GROUP: ${{ inputs.aks-resource-group }}
        AKS_CLUSTER_NAME: ${{ inputs.aks-cluster-name }}
        AKS_NAMESPACE: ${{ inputs.aks-namespace }}
        FAIL_FAST: ${{ inputs.fail-fast }}
        TIMEOUT_SECONDS: ${{ inputs.timeout-seconds }}
        VERBOSE: ${{ inputs.verbose }}
      run: |
        set -euo pipefail

        # Initialize result tracking
        PASSED=()
        FAILED=()
        SKIPPED=()

        # Parse validators list
        IFS=',' read -ra VALIDATOR_LIST <<< "$VALIDATORS"

        # Expand "all" to all available validators
        if [[ " ${VALIDATOR_LIST[@]} " =~ " all " ]]; then
          VALIDATOR_LIST=("yaml-syntax" "kustomize-build" "argocd-paths" "argocd-manifest" "terraform-config" "k8s-placeholders" "swa-config" "kustomize-resources" "reusable-workflows")
        fi

        echo "::group::ðŸ“‹ Validation Plan"
        echo "Validators to run: ${VALIDATOR_LIST[*]}"
        echo "Fail-fast mode: $FAIL_FAST"
        echo "Timeout per validator: ${TIMEOUT_SECONDS}s"
        echo "::endgroup::"
        echo ""

        # Function to run a validator
        run_validator() {
          local validator_name="$1"
          local validator_script="${GITHUB_ACTION_PATH}/validators/${validator_name}.sh"

          if [[ ! -f "$validator_script" ]]; then
            echo "::error::Validator script not found: $validator_script"
            FAILED+=("$validator_name")
            return 1
          fi

          echo "::group::ðŸ” Running validator: $validator_name"
          echo "Script: $validator_script"
          echo "Timeout: ${TIMEOUT_SECONDS}s"
          echo ""

          # Run validator with timeout
          if timeout "${TIMEOUT_SECONDS}s" bash "$validator_script"; then
            echo ""
            echo "âœ… Validator passed: $validator_name"
            echo "::endgroup::"
            PASSED+=("$validator_name")
            return 0
          else
            local exit_code=$?
            echo ""
            echo "âŒ Validator failed: $validator_name (exit code: $exit_code)"
            echo "::endgroup::"
            FAILED+=("$validator_name")
            return 1
          fi
        }

        # Run all validators
        OVERALL_SUCCESS=true
        for validator in "${VALIDATOR_LIST[@]}"; do
          # Skip empty entries
          [[ -z "$validator" ]] && continue

          if ! run_validator "$validator"; then
            OVERALL_SUCCESS=false
            if [[ "$FAIL_FAST" == "true" ]]; then
              echo ""
              echo "::error::Validation failed in fail-fast mode. Stopping execution."
              break
            fi
          fi
        done

        # Generate summary
        echo ""
        echo "::group::ðŸ“Š Validation Summary"
        echo "Passed: ${#PASSED[@]} validator(s)"
        [[ ${#PASSED[@]} -gt 0 ]] && echo "  - ${PASSED[*]}"
        echo "Failed: ${#FAILED[@]} validator(s)"
        [[ ${#FAILED[@]} -gt 0 ]] && echo "  - ${FAILED[*]}"
        echo "Skipped: ${#SKIPPED[@]} validator(s)"
        [[ ${#SKIPPED[@]} -gt 0 ]] && echo "  - ${SKIPPED[*]}"
        echo "::endgroup::"

        # Export outputs
        echo "passed=${PASSED[*]}" >> "$GITHUB_OUTPUT"
        echo "failed=${FAILED[*]}" >> "$GITHUB_OUTPUT"
        echo "skipped=${SKIPPED[*]}" >> "$GITHUB_OUTPUT"

        # Generate JSON results
        RESULTS_JSON=$(cat <<EOF
        {
          "passed": [$(printf '"%s",' "${PASSED[@]}" | sed 's/,$//') ],
          "failed": [$(printf '"%s",' "${FAILED[@]}" | sed 's/,$//') ],
          "skipped": [$(printf '"%s",' "${SKIPPED[@]}" | sed 's/,$//') ]
        }
        EOF
        )
        echo "results<<EOF" >> "$GITHUB_OUTPUT"
        echo "$RESULTS_JSON" >> "$GITHUB_OUTPUT"
        echo "EOF" >> "$GITHUB_OUTPUT"

        if [[ "$OVERALL_SUCCESS" == "true" ]]; then
          echo "all-passed=true" >> "$GITHUB_OUTPUT"
          echo ""
          echo "âœ… All validators passed successfully!"
          exit 0
        else
          echo "all-passed=false" >> "$GITHUB_OUTPUT"
          echo ""
          echo "::error::One or more validators failed. Check the logs above for details."
          exit 1
        fi
