name: Compute Preview Image Tag
description: |
  Determines which image tag to use for preview deployment.
  Logic: If needs_image_build=true, use CI tag; otherwise use existing prod tag.

inputs:
  needs-image-build:
    description: 'Whether new images need to be built (from detect-changes)'
    required: true
  ci-image-tag:
    description: 'Image tag from CI workflow (if images were built)'
    required: false
    default: ''
  production-image-tag:
    description: 'Current production image tag (fallback for K8s-only or forced deploys)'
    required: false
    default: ''

outputs:
  image_tag:
    description: 'Computed image tag to use for preview deployment'
    value: ${{ steps.compute.outputs.image_tag }}
  source:
    description: 'Source of the image tag (ci or production)'
    value: ${{ steps.compute.outputs.source }}

runs:
  using: composite
  steps:
    - name: Compute final image tag
      id: compute
      shell: bash
      env:
        NEEDS_IMAGE_BUILD: ${{ inputs.needs-image-build }}
        CI_TAG: ${{ inputs.ci-image-tag }}
        PROD_TAG: ${{ inputs.production-image-tag }}
      run: ${{ github.action_path }}/compute-preview-image-tag.sh
