name: Verify Deployment Image
description: Verify that a Kubernetes deployment is using the expected image tag

inputs:
  namespace:
    description: Kubernetes namespace
    required: true
  deployment-name:
    description: Name of the deployment to verify
    required: true
  expected-tag:
    description: Expected image tag
    required: true
  registry:
    description: Container registry
    required: true
  image-name:
    description: Image name (without registry prefix)
    required: true
  timeout-seconds:
    description: Maximum time to wait in seconds
    required: false
    default: '300'
  wait-for-ready:
    description: Wait for deployment to be ready
    required: false
    default: 'true'

runs:
  using: composite
  steps:
    - name: Verify deployment
      shell: bash
      run: |
        NAMESPACE="${{ inputs.namespace }}"
        DEPLOYMENT="${{ inputs.deployment-name }}"
        EXPECTED_TAG="${{ inputs.expected-tag }}"
        REGISTRY="${{ inputs.registry }}"
        IMAGE_NAME="${{ inputs.image-name }}"
        TIMEOUT=${{ inputs.timeout-seconds }}
        INTERVAL=5
        MAX_ATTEMPTS=$((TIMEOUT / INTERVAL))
        
        echo "Waiting for ${DEPLOYMENT} deployment..."
        echo "Expected image: ${REGISTRY}/${IMAGE_NAME}:${EXPECTED_TAG}"
        
        for i in $(seq 1 $MAX_ATTEMPTS); do
          if kubectl get deployment ${DEPLOYMENT} -n ${NAMESPACE} 2>/dev/null; then
            echo "✅ ${DEPLOYMENT} deployment exists"
            
            # Get the current image
            CURRENT_IMAGE=$(kubectl get deployment ${DEPLOYMENT} -n ${NAMESPACE} -o jsonpath='{.spec.template.spec.containers[0].image}')
            echo "Current image: ${CURRENT_IMAGE}"
            
            # Check if it matches expected tag
            if [[ "${CURRENT_IMAGE}" == "${REGISTRY}/${IMAGE_NAME}:${EXPECTED_TAG}" ]]; then
              echo "✅ ${DEPLOYMENT} is using the correct image tag"
              
              # Wait for deployment to be ready if requested
              if [ "${{ inputs.wait-for-ready }}" = "true" ]; then
                if kubectl rollout status deployment/${DEPLOYMENT} -n ${NAMESPACE} --timeout=120s; then
                  echo "✅ ${DEPLOYMENT} deployment is ready"
                  exit 0
                fi
              else
                exit 0
              fi
            else
              echo "⚠️ Image tag mismatch - Argo CD may still be syncing"
            fi
          fi
          
          echo "  Attempt $i/${MAX_ATTEMPTS} - Waiting ${INTERVAL}s..."
          sleep $INTERVAL
        done
        
        echo "::error::${DEPLOYMENT} deployment did not reach ready state after ${TIMEOUT}s"
        kubectl get deployment ${DEPLOYMENT} -n ${NAMESPACE} -o yaml || true
        exit 1
