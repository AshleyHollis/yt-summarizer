# Scan Python Code Security
# Runs comprehensive Python security scans
# Uses: bandit (security scanning), mypy (type checking)
# Note: Linting (ruff) is handled separately in the lint-python job

name: 'Scan Python Code Security'
description: 'Run Python security and type checking scans'

inputs:
  service-path:
    description: 'Path to the service directory (e.g., services/api)'
    required: true
  check-types:
    description: 'Run mypy type checking'
    required: false
    default: 'false'
  check-security:
    description: 'Run bandit security scanning'
    required: false
    default: 'true'

runs:
  using: 'composite'
  steps:
    - name: Install code quality tools
      shell: bash
      run: |
        uv tool install bandit[toml] mypy

    - name: Run Bandit security scan
      if: inputs.check-security == 'true'
      shell: bash
      working-directory: ${{ inputs.service-path }}
      run: |
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo "ğŸ”’ Python Security Scan (bandit)"
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo ""

        # Auto-detect source directory
        if [ -d "src" ]; then
          SCAN_DIR="src"
        else
          SCAN_DIR="."
        fi

        echo "ğŸ“ Scanning directory: $SCAN_DIR"
        echo ""

        # Exclude test directories and skip common test-related warnings
        # B101: assert_used (expected in tests)
        # B110: try_except_pass (acceptable for telemetry/optional features)
        # B310: urllib_urlopen (used for health checks, not user input)
        # B311: random (used for jitter/backoff, not cryptographic purposes)
        # B608: hardcoded_sql_expressions (false positive with SQLAlchemy ORM)
        if uv run bandit -r "$SCAN_DIR" -f screen --skip B101,B110,B310,B311,B608 --exclude "./tests/*,*/tests/*,*/test_*.py"; then
          echo ""
          echo "âœ… No security issues detected"
          exit 0
        else
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "âš ï¸  SECURITY ISSUES DETECTED"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "ğŸ“‹ Action Required:"
          echo "   Review the security findings above and address concerns"
          echo "   Common issues: hardcoded secrets, SQL injection, weak crypto"
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          exit 1
        fi

    - name: Run mypy type checking
      if: inputs.check-types == 'true'
      shell: bash
      working-directory: ${{ inputs.service-path }}
      continue-on-error: true
      run: |
        echo "ğŸ” Running mypy type checking..."
        uv run mypy src/ --ignore-missing-imports || {
          echo "âš ï¸  Type checking issues detected"
          exit 1
        }

    - name: Summary
      shell: bash
      run: |
        echo "âœ… Code quality scan complete"
