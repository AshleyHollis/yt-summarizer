#!/bin/bash
# Pre-push hook for yt-summarizer
# ALWAYS runs pre-commit validation before allowing push
# Blocks push if pre-commit checks would fail
# Bypass with --no-verify (not recommended)

set -e  # Exit on error

# Color codes for terminal output
RED='\033[0;31m'
GREEN='\033[0;32m'
CYAN='\033[0;36m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Go to repository root
cd "$(git rev-parse --show-toplevel)" || {
    echo -e "${RED}ERROR: Could not find repository root${NC}"
    exit 0  # Allow push if repo root not found (fallback to CI)
}

echo ""
echo "========================================"
echo -e "${CYAN}PRE-PUSH: VALIDATING PRE-COMMIT${CYAN}"
echo "========================================"
echo ""
echo "Running pre-commit to ensure no issues before pushing..."
echo "This prevents you from pushing code that will fail in CI."
echo ""

# Check if pre-commit command exists
if ! command -v pre-commit &> /dev/null; then
    echo "WARNING: pre-commit not found on PATH"
    echo "Pre-push validation skipped (will rely on CI)"
    exit 0
fi

# Run pre-commit local validation (no auto-fix)
echo -e "${CYAN}Running pre-commit --all-files --verbose...${NC}"
if pre-commit run --all-files --verbose; then
    EXIT_CODE=0
else
    EXIT_CODE=$?
fi

if [ $EXIT_CODE -ne 0 ]; then
    echo ""
    echo "========================================"
    echo -e "${RED}PRE-PUSH VALIDATION FAILED${RED}"
    echo "========================================"
    echo ""
    echo -e "${RED}Your PUSH has been BLOCKED.${NC}"
    echo ""
    echo "Issues found that must be fixed before pushing"
    echo ""
    echo -e "${YELLOW}How to fix:${NC}"
    echo "  1. Run 'pre-commit run --all-files --verbose' to auto-fix issues"
    echo "  2. Review fixes: git diff"
    echo "  3. Add fixes: git add ."
    echo "  4. Commit: git commit -m \"fix: apply pre-commit fixes\""
    echo "  5. Push again"
    echo ""
    echo -e "${RED}To bypass PRE-PUSH check (not recommended):${NC}"
    echo -e "  ${YELLOW}git push --no-verify ...${YELLOW}"
    echo ""
    exit $EXIT_CODE
else
    echo ""
    echo "========================================"
    echo -e "${GREEN}PRE-PUSH VALIDATION PASSED${GREEN}"
    echo "========================================"
    echo ""
    echo -e "${GREEN}Safe to push!${NC}"
    echo ""
    exit 0
fi
