# =============================================================================
# Preview Overlay Kustomization Template
# =============================================================================
# This is a template for the preview kustomization.yaml
# The script will load this and substitute variables
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

metadata:
  annotations:
    config.kubernetes.io/local-config: 'true'

namespace: preview-pr-__PR_NUMBER__

resources:
  - ../../base
  - resource-quota.yaml
  - limit-range.yaml

patches:
  - target:
      group: apps
      version: v1
      kind: Deployment
      name: api
      namespace: preview-pr-__PR_NUMBER__
    patch: |
      apiVersion: apps/v1
      kind: Deployment
      metadata:
        name: api
      spec:
        template:
          spec:
            containers:
            - name: api
              resources:
                requests:
                  cpu: 25m
                  memory: 64Mi
                limits:
                  cpu: 150m
                  memory: 256Mi
  - target:
      group: apps
      version: v1
      kind: Deployment
      name: transcribe-worker
      namespace: preview-pr-__PR_NUMBER__
    patch: |
      apiVersion: apps/v1
      kind: Deployment
      metadata:
        name: transcribe-worker
      spec:
        template:
          spec:
            containers:
            - name: worker
              resources:
                requests:
                  cpu: 25m
                  memory: 64Mi
                limits:
                  cpu: 150m
                  memory: 256Mi
  - target:
      group: apps
      version: v1
      kind: Deployment
      name: summarize-worker
      namespace: preview-pr-__PR_NUMBER__
    patch: |
      apiVersion: apps/v1
      kind: Deployment
      metadata:
        name: summarize-worker
      spec:
        template:
          spec:
            containers:
            - name: worker
              resources:
                requests:
                  cpu: 25m
                  memory: 64Mi
                limits:
                  cpu: 150m
                  memory: 256Mi
  - target:
      group: apps
      version: v1
      kind: Deployment
      name: embed-worker
      namespace: preview-pr-__PR_NUMBER__
    patch: |
      apiVersion: apps/v1
      kind: Deployment
      metadata:
        name: embed-worker
      spec:
        template:
          spec:
            containers:
            - name: worker
              resources:
                requests:
                  cpu: 25m
                  memory: 64Mi
                limits:
                  cpu: 150m
                  memory: 256Mi
  - target:
      group: apps
      version: v1
      kind: Deployment
      name: relationships-worker
      namespace: preview-pr-__PR_NUMBER__
    patch: |
      apiVersion: apps/v1
      kind: Deployment
      metadata:
        name: relationships-worker
      spec:
        template:
          spec:
            containers:
            - name: worker
              resources:
                requests:
                  cpu: 25m
                  memory: 64Mi
                limits:
                  cpu: 150m
                  memory: 256Mi
  - target:
      group: apps
      version: v1
      kind: Deployment
      name: api
      namespace: preview-pr-__PR_NUMBER__
    patch: |
      apiVersion: apps/v1
      kind: Deployment
      metadata:
        name: api
      spec:
        replicas: 1
  - target:
      group: apps
      version: v1
      kind: Deployment
      name: transcribe-worker
      namespace: preview-pr-__PR_NUMBER__
    patch: |
      apiVersion: apps/v1
      kind: Deployment
      metadata:
        name: transcribe-worker
      spec:
        replicas: 1
  - target:
      group: apps
      version: v1
      kind: Deployment
      name: summarize-worker
      namespace: preview-pr-__PR_NUMBER__
    patch: |
      apiVersion: apps/v1
      kind: Deployment
      metadata:
        name: summarize-worker
      spec:
        replicas: 1
  - target:
      group: apps
      version: v1
      kind: Deployment
      name: embed-worker
      namespace: preview-pr-__PR_NUMBER__
    patch: |
      apiVersion: apps/v1
      kind: Deployment
      metadata:
        name: embed-worker
      spec:
        replicas: 1
  - target:
      group: apps
      version: v1
      kind: Deployment
      name: relationships-worker
      namespace: preview-pr-__PR_NUMBER__
    patch: |
      apiVersion: apps/v1
      kind: Deployment
      metadata:
        name: relationships-worker
      spec:
        replicas: 1
  - target:
      group: batch
      version: v1
      kind: Job
      name: db-migration
      namespace: preview-pr-__PR_NUMBER__
    patch: |
      apiVersion: batch/v1
      kind: Job
      metadata:
        name: db-migration
      spec:
        template:
          spec:
            serviceAccountName: default
  - path: patches/externalsecret-db-patch.yaml
  - path: patches/externalsecret-openai-patch.yaml
  - path: patches/externalsecret-storage-patch.yaml
  - path: patches/secretstore-delete-patch.yaml
  - path: patches/configmap-patch.yaml
  - path: patches/ingress-patch.yaml
  - path: patches/resources-patch.yaml
  - path: patches/replicas-patch.yaml
