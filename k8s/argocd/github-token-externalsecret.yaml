# =============================================================================
# GitHub Token ExternalSecret for ArgoCD ApplicationSet
# =============================================================================
# Syncs GitHub PAT from Azure Key Vault to Kubernetes secret
# Enables automatic rotation when Key Vault secret is updated
#
# Prerequisites:
# 1. Store GitHub PAT in Azure Key Vault:
#    az keyvault secret set --vault-name kv-ytsumm-prd \
#      --name github-argocd-token --value "<YOUR_GITHUB_PAT>"
#
# 2. Ensure ClusterSecretStore is configured (already exists)
#
# Apply: kubectl apply -f k8s/argocd/github-token-externalsecret.yaml
# =============================================================================

apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: github-token
  namespace: argocd
  labels:
    app.kubernetes.io/name: argocd
    app.kubernetes.io/component: applicationset
spec:
  # Refresh from Key Vault every hour
  refreshInterval: 1h

  # Use cluster-wide secret store (configured in cluster-secretstore.yaml)
  secretStoreRef:
    name: cluster-secretstore
    kind: ClusterSecretStore

  # Target Kubernetes secret
  target:
    name: github-token
    creationPolicy: Owner
    deletionPolicy: Retain

  # Map Key Vault secret to Kubernetes secret key
  data:
    - secretKey: token
      remoteRef:
        key: github-argocd-token
