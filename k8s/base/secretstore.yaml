# =============================================================================
# SecretStore for Azure Key Vault
# =============================================================================
# Configures External Secrets Operator to sync secrets from Azure Key Vault.
# Uses AKS Workload Identity for authentication (no secrets needed).
#
# Prerequisites:
# 1. AKS cluster with Workload Identity enabled
# 2. Azure Key Vault with secrets
# 3. Federated credential on Key Vault's managed identity for this ServiceAccount
# =============================================================================

apiVersion: external-secrets.io/v1beta1
kind: SecretStore
metadata:
  name: azure-keyvault
  namespace: yt-summarizer
  annotations:
    argocd.argoproj.io/sync-wave: "-1"
spec:
  provider:
    azurekv:
      # Azure Key Vault URL - will be patched per environment
      vaultUrl: "https://kv-ytsumm-prd.vault.azure.net/"
      # Use Workload Identity authentication
      authType: WorkloadIdentity
      serviceAccountRef:
        name: yt-summarizer-sa  # ServiceAccount with Azure identity binding

---
# ServiceAccount with Azure Workload Identity annotations
apiVersion: v1
kind: ServiceAccount
metadata:
  name: yt-summarizer-sa
  namespace: yt-summarizer
  annotations:
    argocd.argoproj.io/sync-wave: "-2"
    # Production managed identity client ID for External Secrets Operator
    # Note: Update this value if deploying to a different environment
    azure.workload.identity/client-id: "fd0bd4f3-4a8a-4003-b509-9622605c6087"
  labels:
    azure.workload.identity/use: "true"
