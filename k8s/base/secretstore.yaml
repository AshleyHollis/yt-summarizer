# =============================================================================
# SecretStore for Azure Key Vault
# =============================================================================
# Configures External Secrets Operator to sync secrets from Azure Key Vault.
# Uses AKS Workload Identity for authentication (no secrets needed).
#
# Prerequisites:
# 1. AKS cluster with Workload Identity enabled
# 2. Azure Key Vault with secrets
# 3. Federated credential on Key Vault's managed identity for this ServiceAccount
# =============================================================================

apiVersion: external-secrets.io/v1beta1
kind: SecretStore
metadata:
  name: azure-keyvault
  namespace: yt-summarizer
spec:
  provider:
    azurekv:
      # Azure Key Vault URL - will be patched per environment
      vaultUrl: "https://kv-ytsumm-prd.vault.azure.net/"
      # Use Workload Identity authentication
      authType: WorkloadIdentity
      serviceAccountRef:
        name: yt-summarizer-sa  # ServiceAccount with Azure identity binding

---
# ServiceAccount with Azure Workload Identity annotations
apiVersion: v1
kind: ServiceAccount
metadata:
  name: yt-summarizer-sa
  namespace: yt-summarizer
  annotations:
    # This will be patched by Kustomize with the actual client ID
    azure.workload.identity/client-id: "PLACEHOLDER_CLIENT_ID"
  labels:
    azure.workload.identity/use: "true"
