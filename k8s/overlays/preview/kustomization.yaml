# Preview overlay - updated by GitHub Actions
# PR: #4
# Image Tag: pr-4-3b78d6a
# Updated: 2026-01-10T05:52:43Z
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

namespace: preview-pr-4

resources:
  - ../../base
  - resource-quota.yaml
  - limit-range.yaml
  # Note: SecretStore and ServiceAccount from base are replaced by patches
  # Preview uses ClusterSecretStore which references production namespace's SA

patches:
  - path: patches/configmap-patch.yaml
  - path: patches/ingress-patch.yaml
  - path: patches/resources-patch.yaml
  - path: patches/replicas-patch.yaml
  # Patch ExternalSecrets to use ClusterSecretStore
  - target:
      group: external-secrets.io
      version: v1beta1
      kind: ExternalSecret
      name: db-credentials
    patch: |-
      - op: replace
        path: /spec/secretStoreRef/kind
        value: ClusterSecretStore
      - op: replace
        path: /spec/secretStoreRef/name
        value: azure-keyvault-cluster
  - target:
      group: external-secrets.io
      version: v1beta1
      kind: ExternalSecret
      name: openai-credentials
    patch: |-
      - op: replace
        path: /spec/secretStoreRef/kind
        value: ClusterSecretStore
      - op: replace
        path: /spec/secretStoreRef/name
        value: azure-keyvault-cluster
  - target:
      group: external-secrets.io
      version: v1beta1
      kind: ExternalSecret
      name: storage-credentials
    patch: |-
      - op: replace
        path: /spec/secretStoreRef/kind
        value: ClusterSecretStore
      - op: replace
        path: /spec/secretStoreRef/name
        value: azure-keyvault-cluster
  # Delete SecretStore (preview uses ClusterSecretStore)
  - target:
      group: external-secrets.io
      version: v1beta1
      kind: SecretStore
      name: azure-keyvault
    patch: |-
      $patch: delete
      apiVersion: external-secrets.io/v1beta1
      kind: SecretStore
      metadata:
        name: azure-keyvault
  # Strip federated identity annotations from ServiceAccount
  # (Preview uses ClusterSecretStore with production SA for Key Vault access,
  # but we still need the SA for pods to run)
  - target:
      kind: ServiceAccount
      name: yt-summarizer-sa
    patch: |-
      - op: remove
        path: /metadata/annotations/azure.workload.identity~1client-id
      - op: remove
        path: /metadata/annotations/azure.workload.identity~1tenant-id
  # Use default SA for migration job (avoids circular dependency with SA sync wave)
  - target:
      group: batch
      version: v1
      kind: Job
      name: db-migration
    patch: |-
      - op: replace
        path: /spec/template/spec/serviceAccountName
        value: default

images:
  - name: yt-summarizer-api
    newName: acrytsummprd.azurecr.io/yt-summarizer-api
    newTag: "pr-4-3b78d6a"
  - name: yt-summarizer-workers
    newName: acrytsummprd.azurecr.io/yt-summarizer-workers
    newTag: "pr-4-3b78d6a"

labels:
  - pairs:
      app.kubernetes.io/part-of: yt-summarizer-preview
      preview.pr-number: "4"
