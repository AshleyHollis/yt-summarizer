# Preview overlay - updated by GitHub Actions
# PR: #__PR_NUMBER__
# Image Tag: __IMAGE_TAG__
# Updated: __TIMESTAMP__
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

namespace: preview-pr-__PR_NUMBER__

resources:
  - ../../base
  - resource-quota.yaml
  - limit-range.yaml
  # Note: SecretStore and ServiceAccount from base are replaced by patches
  # Preview uses ClusterSecretStore which references production namespace's SA

patches:
  - path: patches/configmap-patch.yaml
  - path: patches/ingress-patch.yaml
  - path: patches/resources-patch.yaml
  - path: patches/replicas-patch.yaml
  # Patch ExternalSecrets to use ClusterSecretStore
  - target:
      group: external-secrets.io
      version: v1beta1
      kind: ExternalSecret
      name: db-credentials
    patch: |-
      - op: replace
        path: /spec/secretStoreRef/kind
        value: ClusterSecretStore
      - op: replace
        path: /spec/secretStoreRef/name
        value: azure-keyvault-cluster
  - target:
      group: external-secrets.io
      version: v1beta1
      kind: ExternalSecret
      name: openai-credentials
    patch: |-
      - op: replace
        path: /spec/secretStoreRef/kind
        value: ClusterSecretStore
      - op: replace
        path: /spec/secretStoreRef/name
        value: azure-keyvault-cluster
  - target:
      group: external-secrets.io
      version: v1beta1
      kind: ExternalSecret
      name: storage-credentials
    patch: |-
      - op: replace
        path: /spec/secretStoreRef/kind
        value: ClusterSecretStore
      - op: replace
        path: /spec/secretStoreRef/name
        value: azure-keyvault-cluster
  # Delete SecretStore (preview uses ClusterSecretStore)
  - target:
      group: external-secrets.io
      version: v1beta1
      kind: SecretStore
      name: azure-keyvault
    patch: |-
      $patch: delete
      apiVersion: external-secrets.io/v1beta1
      kind: SecretStore
      metadata:
        name: azure-keyvault
  # Strip federated identity annotations from ServiceAccount
  # (Preview uses ClusterSecretStore with production SA for Key Vault access,
  # but we still need the SA for pods to run)
  - target:
      kind: ServiceAccount
      name: yt-summarizer-sa
    patch: |-
      - op: remove
        path: /metadata/annotations/azure.workload.identity~1client-id
      - op: remove
        path: /metadata/annotations/azure.workload.identity~1tenant-id
  # Use default SA for migration job (avoids circular dependency with SA sync wave)
  - target:
      group: batch
      version: v1
      kind: Job
      name: db-migration
    patch: |-
      - op: replace
        path: /spec/template/spec/serviceAccountName
        value: default

images:
  - name: yt-summarizer-api
    newName: __ACR_SERVER__/yt-summarizer-api
    newTag: "__IMAGE_TAG__"
  - name: yt-summarizer-workers
    newName: __ACR_SERVER__/yt-summarizer-workers
    newTag: "__IMAGE_TAG__"

labels:
  - pairs:
      app.kubernetes.io/part-of: yt-summarizer-preview
      preview.pr-number: "__PR_NUMBER__"
TEMPLATE_EOF

# Remove leading spaces from template
sed -i 's/^          //' "${OVERLAY_FILE}.template"

# Substitute placeholders with actual values
TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
sed -e "s/__PR_NUMBER__/${PR_NUMBER}/g" \
    -e "s/__IMAGE_TAG__/${IMAGE_TAG}/g" \
    -e "s/__ACR_SERVER__/${ACR_SERVER}/g" \
    -e "s/__TIMESTAMP__/${TIMESTAMP}/g" \
    "${OVERLAY_FILE}.template" > "$OVERLAY_FILE"
rm "${OVERLAY_FILE}.template"

# Generate preview URL
# Priority: 1. Repo Variable (PREVIEW_API_URL) 2. Dynamic Ingress IP
if [ -n "http://20.255.113.149" ]; then
  PREVIEW_URL="http://20.255.113.149"
  echo "✅ Using configured API URL: ${PREVIEW_URL}"
elif [ -n "$INGRESS_IP" ]; then
  PREVIEW_URL="https://${INGRESS_IP}/api"
  echo "✅ Using dynamic Ingress URL: ${PREVIEW_URL}"
else
  PREVIEW_URL=""
  echo "⚠️ PREVIEW_API_URL not configured and Ingress IP not found"
  echo "::warning::Backend connectivity may be broken"
fi
echo "preview_url=${PREVIEW_URL}" >> $GITHUB_OUTPUT

echo "Updated preview overlay at ${OVERLAY_FILE}"
cat "$OVERLAY_FILE"
