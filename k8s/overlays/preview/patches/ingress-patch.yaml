# =============================================================================
# Preview Ingress Patch
# =============================================================================
# Routes traffic to preview API pods via nip.io wildcard DNS
# 
# CRITICAL: TLS/HTTPS REQUIREMENTS
# ---------------------------------
# - Frontend served from Azure Static Web Apps over HTTPS
# - Backend MUST also use HTTPS to avoid mixed content errors
# - Browsers block HTTP requests from HTTPS pages (mixed content policy)
# - cert-manager.io/cluster-issuer MUST use "letsencrypt-prod" for trusted certs
# - NEVER use "letsencrypt-staging" - it creates untrusted certs that browsers reject
#
# Access URL: https://api.preview-pr-<num>.<ip-dashed>.nip.io
# Example: https://api.preview-pr-4.20-255-113-149.nip.io
# =============================================================================
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: api-ingress
  namespace: yt-summarizer
  annotations:
    # IMPORTANT: ssl-redirect must be "true" for HTTPS (prevents mixed content errors)
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
    # TEMPORARY: Using letsencrypt-staging due to rate limiting on production
    # TODO: Switch back to letsencrypt-prod once rate limit resets
    # letsencrypt-staging creates untrusted certs, but allows testing HTTPS
    cert-manager.io/cluster-issuer: letsencrypt-staging
spec:
  rules:
    # Host will be filled in by the preview workflow (e.g. api.preview-pr-<num>.<ip-dashed>.nip.io)
    - host: api.preview-pr-4.20-255-113-149.nip.io
      http:
        paths:
          - path: /api(/|$)(.*)
            pathType: ImplementationSpecific
            backend:
              service:
                name: api
                port:
                  number: 80
          - path: /
            pathType: Prefix
            backend:
              service:
                name: api
                port:
                  number: 80
  tls:
    - hosts:
        - api.preview-pr-4.20-255-113-149.nip.io
      secretName: preview-pr-4-tls
