# Generated by generate_preview_kustomization.sh on 2026-02-24 11:38:42 UTC
# PR: 141
# Image: acrytsummprd.azurecr.io/api:pr-141-96b24ba
# Preview Host: api-pr-141.yt-summarizer.apps.ashleyhollis.com
# Commit: 96b24baed3fedc0303b8ae253aaab02e7b8357e2


# =============================================================================
# Preview Overlay Kustomization Template
# =============================================================================
# This is a template for the preview kustomization.yaml
# The script will load this and substitute variables
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

metadata:
  annotations:
    config.kubernetes.io/local-config: 'true'

namespace: preview-pr-141

resources:
  - ../../base-preview
  - resource-quota.yaml
  - limit-range.yaml

images:
  - name: yt-summarizer-api
    newName: acrytsummprd.azurecr.io/yt-summarizer-api
    newTag: pr-141-96b24ba
  - name: yt-summarizer-workers
    newName: acrytsummprd.azurecr.io/yt-summarizer-workers
    newTag: pr-141-96b24ba

patches:
  # ExternalSecret patches - reference ClusterSecretStore
  - patch: |-
      apiVersion: external-secrets.io/v1beta1
      kind: ExternalSecret
      metadata:
        name: db-credentials
      spec:
        secretStoreRef:
          kind: ClusterSecretStore
          name: azure-keyvault-cluster
    target:
      kind: ExternalSecret
      name: db-credentials

  - patch: |-
      apiVersion: external-secrets.io/v1beta1
      kind: ExternalSecret
      metadata:
        name: openai-credentials
      spec:
        secretStoreRef:
          kind: ClusterSecretStore
          name: azure-keyvault-cluster
    target:
      kind: ExternalSecret
      name: openai-credentials

  - patch: |-
      apiVersion: external-secrets.io/v1beta1
      kind: ExternalSecret
      metadata:
        name: storage-credentials
      spec:
        secretStoreRef:
          kind: ClusterSecretStore
          name: azure-keyvault-cluster
    target:
      kind: ExternalSecret
      name: storage-credentials

  # ConfigMap patch - CORS origins with SWA URL
  - patch: |-
      apiVersion: v1
      kind: ConfigMap
      metadata:
        name: shared-config
      data:
        CORS_ORIGINS: "https://red-grass-06d413100-141.eastasia.6.azurestaticapps.net"
    target:
      kind: ConfigMap
      name: shared-config

  # API Deployment patch - CORS origins env var
  - patch: |-
      apiVersion: apps/v1
      kind: Deployment
      metadata:
        name: api
      spec:
        template:
          spec:
            containers:
            - name: api
              env:
              - name: API__CORS_ORIGINS
                # JSON array string - keep no spaces after commas
                value: '["https://red-grass-06d413100-141.eastasia.6.azurestaticapps.net","http://localhost:3000"]'
    target:
      kind: Deployment
      name: api

  # HTTPRoute patch - preview hostname
  - patch: |-
      apiVersion: gateway.networking.k8s.io/v1
      kind: HTTPRoute
      metadata:
        name: api-httproute
        annotations:
          external-dns.alpha.kubernetes.io/hostname: api-pr-141.yt-summarizer.apps.ashleyhollis.com
      spec:
        hostnames:
        - "api-pr-141.yt-summarizer.apps.ashleyhollis.com"
    target:
      kind: HTTPRoute
      name: api-httproute

  # Replicas patch - single replica for all deployments
  - patch: |-
      - op: replace
        path: /spec/replicas
        value: 1
    target:
      kind: Deployment
      labelSelector: app.kubernetes.io/component

  # Resource limits patch - API deployment
  - patch: |-
      - op: replace
        path: /spec/template/spec/containers/0/resources
        value:
          requests:
            cpu: 50m
            memory: 128Mi
          limits:
            cpu: 200m
            memory: 256Mi
    target:
      kind: Deployment
      name: api

  # Resource limits patch - Worker deployments
  - patch: |-
      - op: replace
        path: /spec/template/spec/containers/0/resources
        value:
          requests:
            cpu: 25m
            memory: 64Mi
          limits:
            cpu: 150m
            memory: 256Mi
    target:
      kind: Deployment
      labelSelector: app.kubernetes.io/component=worker

  # Migration job patch - resource limits
  - patch: |-
      - op: replace
        path: /spec/template/spec/containers/0/resources
        value:
          requests:
            cpu: 25m
            memory: 64Mi
          limits:
            cpu: 150m
            memory: 256Mi
    target:
      kind: Job
      name: db-migration
