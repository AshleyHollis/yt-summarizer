# =============================================================================
# Preview Overlay Template - Kustomization
# =============================================================================
# Template for ephemeral PR preview environments
# The preview.yml workflow copies this template to pr-<number>/
# Placeholders: {{PR_NUMBER}}, {{IMAGE_TAG}}, {{ACR_LOGIN_SERVER}}
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

# Namespace is created per-preview
namespace: preview-pr-{{PR_NUMBER}}

resources:
  - ../../../base
  - namespace.yaml
  - resource-quota.yaml
  - limit-range.yaml

# Image tags - set by preview.yml workflow
images:
  - name: yt-summarizer-api
    newName: {{ACR_LOGIN_SERVER}}/yt-summarizer-api
    newTag: {{IMAGE_TAG}}
  - name: yt-summarizer-workers
    newName: {{ACR_LOGIN_SERVER}}/yt-summarizer-workers
    newTag: {{IMAGE_TAG}}

# Preview-specific patches
patches:
  - path: patches/configmap-patch.yaml
  - path: patches/ingress-patch.yaml
  - path: patches/resources-patch.yaml
  - path: patches/replicas-patch.yaml

labels:
  - pairs:
      environment: preview
      preview-pr: "{{PR_NUMBER}}"
      app.kubernetes.io/part-of: yt-summarizer

commonAnnotations:
  deployment.kubernetes.io/environment: preview
  preview.yt-summarizer.dev/pr: "{{PR_NUMBER}}"
